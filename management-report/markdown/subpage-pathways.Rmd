---
title: "PATHWAYS DRAFT PATHWAYS DRAFT PATHWAYS DRAFT PATHWAYS DRAFT PATHWAYS DRAFT"
output: 
  flexdashboard::flex_dashboard:
    logo: phs-logo.png
    orientation: rows
    vertical_layout: scroll
---

```{r load-setup, include=FALSE}
source(here::here("code", "00_setup-environment.R"))
library(crosstalk) # for drop down menus
#library(phsstyles)
library(htmltools)


# Write numbers with thousands separator
knit_hooks$set(inline = function(x){
  if(!is.character(x)){prettyNum(x, big.mark=",")}else{x}
})
```

---
date: "`r paste('Data as at', format(end_date, '%d %B %Y'))`"
---

```{r setup, include=FALSE}

# Load functions
walk(dir(here::here("functions"), full.names = TRUE), source)


# Load PDS data
pds <- read_rds(get_mi_data_path("final_data", ext = "rds", test_output = test_output)) %>% 
  
  # Remove codes from board and IJB
  mutate(health_board = str_sub(health_board, 3, -1),
         ijb          = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))

# Load expected diagnoses reference file
exp <- read_csv(get_exp_diagnoses_path())


# Load error summary
err <- read_rds(get_mi_data_path("error_data", ext = "rds", test_output = test_output)) %>% 

  mutate(ijb = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))

# calculate referrals for Scotland and health boards
pds_ijb <- pds %>% arrange(ijb)

pds_ijb %<>% rename(geog = ijb) 

pds_ijb$geog<- factor(pds_ijb$geog, levels = unique(pds_ijb$geog))

pds_scot <- pds %>% group_by(health_board = "Scotland", ijb = "Scotland", fy, month, ldp_full, ldp, age_grp_2, age_grp, simd, sex) %>%  summarise(referrals = sum(referrals), .groups = "drop")

pds_scot %<>% rename(geog = ijb) 

pds_scot$geog<- factor(pds_scot$geog, levels = unique(pds_scot$geog))

pds_hb <- pds %>% group_by(health_board, fy, month, ldp_full, ldp, age_grp_2, age_grp, simd, sex) %>% 
  summarise(referrals = sum(referrals), .groups = "drop") %>% mutate(ijb = health_board, .before = fy)

pds_hb %<>% rename(geog = ijb) 

pds_hb$geog<- factor(pds_hb$geog, levels = unique(pds_hb$geog))

# combine data for ijb, hb and Scotland
pds_all <- bind_rows(pds_scot, pds_ijb, pds_hb)

pds_all$geog<- factor(pds_all$geog, levels = unique(pds_all$geog))

#get totals for all geogs, hbs, ijbs, scotland
pds_all_totals <- pds_all %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_ijb_totals <- pds_ijb %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_hb_totals <- pds_hb %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_scot_totals <- pds_scot %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))


#get totals for all geogs, hbs, ijbs, scotland with LARGE AGE GROUPS
pds_all_totals_2 <- bind_rows(pds_all_totals,
  pds_all %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_all_totals_2$age_grp_2<- factor(pds_all_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))

pds_ijb_totals_2 <- bind_rows(pds_ijb_totals,
    pds_ijb %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_ijb_totals_2$age_grp_2<- factor(pds_ijb_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))


pds_hb_totals_2 <- bind_rows(pds_hb_totals,
    pds_hb %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_hb_totals_2$age_grp_2<- factor(pds_hb_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))


pds_scot_totals_2 <- bind_rows(pds_scot_totals,
    pds_scot %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_scot_totals_2$age_grp_2<- factor(pds_scot_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))



#create year lists
provisional_year <- paste0(as.numeric(substr(last(finalised_years),1,4)) + 1,
                           "/", as.numeric(substr(last(finalised_years),6,7)) + 1)

current_fy <- paste0(substr(fy,1,4),
                           "/", as.numeric(substr(fy,3,4)) + 1)

last_full_year <- if_else(qt == 4, current_fy, paste0(as.numeric(substr(fy,1,4)) - 1,
                           "/", as.numeric(substr(fy,3,4))))

all_years <- unique(pds_all$fy)

if(qt == 4){full_years = all_years}else{full_years = all_years[-length(all_years)]}


```

<script>

var pds_year = "`r current_fy`";

var ldp_year = "`r last_full_year`";

</script>

<!-- delete all of above when finished testing -->


PDS Pathways
=================================================

```{r data-setup-pathways, include=FALSE}

#load pathways data
wait_data <- read_rds(get_mi_data_path("wait_data", ext = "rds", test_output = test_output))

# term_data_contact <- read_rds(get_mi_data_path("wait_data_2", ext = "rds", test_output = test_output))

wait_data$health_board <- as.factor(wait_data$health_board)
wait_data$fy <- as.factor(wait_data$fy)
wait_data$simd <- as.factor(wait_data$simd)
wait_data$sex <- as.factor(wait_data$sex)
wait_data$ijb <- as.factor(wait_data$ijb)

# term_data_contact$health_board <- as.factor(term_data_contact$health_board)
# term_data_contact$fy <- as.factor(term_data_contact$fy)
# term_data_contact %<>% arrange(termination_or_transition_reason)
# term_data_contact$sex <- as.factor(term_data_contact$sex)
# term_data_contact$ijb <- factor(term_data_contact$ijb, levels = unique(pds_all$geog))
# term_data_contact %<>% mutate(termination_or_transition_reason = if_else(termination_or_transition_reason == "14 All reasons", substring(termination_or_transition_reason, 4), termination_or_transition_reason))
# term_data_contact$termination_or_transition_reason <- as.factor(term_data_contact$termination_or_transition_reason)

term_data_no_contact <- read_rds(get_mi_data_path("wait_data_3", ext = "rds", test_output = test_output))

term_data_no_contact$health_board <- as.factor(term_data_no_contact$health_board)
term_data_no_contact$fy <- as.factor(term_data_no_contact$fy)
term_data_no_contact %<>% arrange(termination_or_transition_reason)
term_data_no_contact$sex <- as.factor(term_data_no_contact$sex)
term_data_no_contact$ijb <- factor(term_data_no_contact$ijb, levels = unique(pds_all$geog))
term_data_no_contact %<>% mutate(termination_or_transition_reason = if_else(termination_or_transition_reason == "14 All reasons", substring(termination_or_transition_reason, 4), termination_or_transition_reason))
term_data_no_contact$termination_or_transition_reason <- as.factor(term_data_no_contact$termination_or_transition_reason)

#load uptake decision data
uptake_data <- read_rds(get_mi_data_path("uptake_data", ext = "rds", test_output = test_output))

 
```

Sidebar - waiting times {.sidebar}
-----------------------------------------------------------------------

<br>

### Pathways - Waiting Times

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[**Pathways - Waiting Times**](#pds-pathways)</li>
  <li>[Pathways - PDS Outcomes](#outcomes)</li>
  <li>[Pathways - Uptake Decision](#uptake)</li>
  <li>[Pathways - No Contact within 12 Months](#no-contact)</li>
</ul>

***

**FURTHER INFORMATION:**

<ul style="list-style-type:square;">
   <li >[Glossary](#glossary)</li>
   <li >[Navigation Guide](#navigation-guide)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

This page provides information on the pathways from dementia diagnosis to first contact by PDS practitioner. *See the [Glossary](#glossary) for more details.* 

The Integration Authority Areas and Health Boards tabs include a chart and table showing the median number of days between diagnosis and contact for each geographical area by financial year.  

The Trend tab includes a chart and table showing the trend of the median days between diagnosis and contact by financial year for Scotland, Integration Authority Areas and Health Boards. Multiple geographies can be selected. 

The Waiting Times Breakdown tab provides a table showing the number of referrals, percentage of referrals allocated and contacted by PDS practitioner, and the median number of days between each stage of the pathway. The figures presented here will be reflective of how local services and systems are set up, e.g. referral date and/or date of allocation to a PDS practitioner may be recorded at the same time as the diagnosis.  

*The figures shown for `r provisional_year` onwards are currently provisional and subject to change in future versions of this report.*

`r if(qt != 4) {div(style = css(fontStyle="italic"),paste0("For diagnoses in financial year ", current_fy, " data is available up to and including Q", qt, "."))}`
`r if(qt != 4) {HTML("<br>")}`
**Please note:** *Aberdeen City Health & Social Care Partnership changed to provide PDS in 2019 to an inhouse hybrid model. This change in model, and process of receiving referrals and recording, resulted in data quality issues for financial years 2019/20 and 2020/21. This should be taken into account when interpreting figures for Aberdeen City and NHS Grampian.*

Row {.tabset data-height=1180}
----------------------------------------------------------------------

### **Integration Authority Areas**

```{r dropdown-median-ijb}
median_data_ijb <- wait_data %>% 
      filter(sex == "All") %>% 
     filter(ijb != "All", simd == "All") %>% 
      select(ijb, fy, median_diagnosis_to_contact) %>% 
  mutate(median_diagnosis_to_contact = if_else(is.na(median_diagnosis_to_contact)| median_diagnosis_to_contact < 0, 0, median_diagnosis_to_contact)) %>% 
      mutate(ijb = if_else(ijb == "Scotland", "AAA", ijb)) %>%
      arrange(ijb) %>% 
      mutate(ijb = if_else(ijb == "AAA", "Scotland", ijb)) %>% 
    mutate(median_diagnosis_to_contact = if_else(ijb == "Aberdeen City" & fy %in% c("2019/20", "2020/21"), 0, median_diagnosis_to_contact))

median_data_ijb <- left_join(median_data_ijb,
median_data_ijb %>% filter(ijb == "Scotland") %>% select(fy, median_diagnosis_to_contact) %>%  rename(scot_median_diagnosis_to_contact = median_diagnosis_to_contact)) %>% filter(ijb != "Scotland") %>% 
  rename(geog = ijb)

median_data_ijb$geog<- factor(median_data_ijb$geog, levels = c(unique(median_data_ijb$geog)))


median_data_ijb_table <- SharedData$new(median_data_ijb, key = ~fy, group = "median_ijb")

data_filter_median <- filter_select(id = "filter_median",
                                    label = "Select Financial Year of Diagnosis:",
                                    group = ~fy,
                                    sharedData = median_data_ijb_table,
                                    multiple = FALSE
                                   )

bscols(widths = c(1,5,NA),NULL,
data_filter_median,
NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px">Average (median) days from diagnosis to first contact by PDS practitioner by Integration Authority Area</h2>
```{r plot-median-ijb}

bscols(widths = 12,
  div(style = css(width="98%", height="385px", marginBottom="-30px"),
plot_bar_median(median_data_ijb_table))
)

```


```{r table-median-ijb}
median_ijb_table_data <- wait_data %>% 
      filter(sex == "All") %>% 
     filter(ijb != "All", simd == "All") %>% 
      select(ijb, fy, total_referrals, perc_contacted, median_diagnosis_to_contact) %>%
   mutate(median_diagnosis_to_contact = if_else(median_diagnosis_to_contact < 0, "-", as.character(median_diagnosis_to_contact))) %>% 
  mutate(across(starts_with("perc"), ~ paste0(.,"%"))) %>%
    mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>%
      mutate(ijb = if_else(ijb == "Scotland", "AAA", ijb)) %>%
      arrange(ijb) %>% 
      mutate(ijb = if_else(ijb == "AAA", "Scotland", ijb)) %>% 
    mutate(median_diagnosis_to_contact = if_else(ijb == "Aberdeen City" & fy %in% c("2019/20", "2020/21"), "-", median_diagnosis_to_contact)) %>% 
    mutate(perc_contacted = if_else(ijb == "Aberdeen City" & fy %in% c("2019/20", "2020/21"), "-", perc_contacted)) %>%
  mutate(median_diagnosis_to_contact = if_else(median_diagnosis_to_contact == "  NA", "-", median_diagnosis_to_contact)) %>% 
    rename(`Number of People Referred to PDS` = total_referrals, 
         `% of Referrals contacted by PDS practitioner` = perc_contacted,
        `Average (median) days from diagnosis to first contact` = median_diagnosis_to_contact) %>% 
  #pivot_longer(!c(ijb,fy), names_to = "measure", values_to = "n") %>% 
 # pivot_wider(names_from = ijb, values_from = n) %>% 
  rename("Integration Authority Area" = "ijb")

median_ijb_table <- SharedData$new(median_ijb_table_data, key = ~fy, group = "median_ijb")


bscols(widths = 12,
       div(style = css(width="97%", height="450px", margin="20px"),
DT::datatable(median_ijb_table, rownames = FALSE, extensions = "FixedColumns",
               caption = htmltools::tags$caption(
                       style = 'caption-side: bottom; text-align: left;',
                       "A dash (-) indicates that this measure could not be calculated due to data quality issues."),
              options = list(pageLength = 33,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 1),
                                               list(className = 'dt-right', targets = 2:4)
                                               ))) %>%
           DT::formatStyle(1, fontWeight = "bold", #padding = "4px"
                          )
        )
     )



```

### **Health Boards**

```{r dropdown-median-hb}
median_data_hb <- wait_data %>% 
      filter(sex == "All") %>% 
     filter(ijb == "All" | ijb == "Scotland", simd == "All") %>% 
      select(health_board, fy, median_diagnosis_to_contact) %>% 
  mutate(median_diagnosis_to_contact = if_else(is.na(median_diagnosis_to_contact)| median_diagnosis_to_contact < 0, 0, median_diagnosis_to_contact))

median_data_hb <- left_join(median_data_hb,
median_data_hb %>% filter(health_board == "Scotland") %>% select(fy, median_diagnosis_to_contact) %>%  rename(scot_median_diagnosis_to_contact = median_diagnosis_to_contact)) %>% filter(health_board != "Scotland") %>% 
    mutate(median_diagnosis_to_contact = if_else(health_board == "NHS Grampian" & fy %in% c("2019/20", "2020/21"), 0, median_diagnosis_to_contact)) %>% 
  rename(geog = health_board)

median_data_hb$geog<- factor(median_data_hb$geog, levels = c(unique(median_data_hb$geog)))


median_data_hb_table <- SharedData$new(median_data_hb, key = ~fy, group = "median_hb")

data_filter_median_hb <- filter_select(id = "filter_median_hb",
                                    label = "Select Financial Year of Diagnosis:",
                                    group = ~fy,
                                    sharedData = median_data_hb_table,
                                    multiple = FALSE
                                   )

bscols(widths = c(1,5,NA),NULL,
data_filter_median_hb,
NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px">Average (median) days from diagnosis to contact by PDS practitioner by Health Board</h2>
```{r plot-median-hb}

bscols(widths = 12,
  div(style = css(width="98%", height="385px", marginBottom="-30px"),
plot_bar_median(median_data_hb_table))
)

```


```{r table-median-hb}
median_hb_table_data <- wait_data %>% 
      filter(sex == "All") %>% 
     filter(ijb == "All" | ijb == "Scotland", simd == "All") %>% 
      select(health_board, fy, total_referrals, perc_contacted, median_diagnosis_to_contact) %>% 
    mutate(median_diagnosis_to_contact = if_else(median_diagnosis_to_contact < 0, "-", as.character(median_diagnosis_to_contact))) %>% 
  mutate(across(starts_with("perc"), ~ paste0(.,"%"))) %>%
    mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>%
        mutate(median_diagnosis_to_contact = if_else(health_board == "NHS Grampian" & fy %in% c("2019/20", "2020/21"), "-", median_diagnosis_to_contact)) %>% 
    mutate(perc_contacted = if_else(health_board == "NHS Grampian" & fy %in% c("2019/20", "2020/21"), "-", perc_contacted)) %>%
  rename(`Number of People Referred to PDS` = total_referrals, 
         `% of Referrals contacted by PDS practitioner` = perc_contacted,
        `Average (median) days from diagnosis to first contact` = median_diagnosis_to_contact) %>% 
 # pivot_longer(!c(health_board,fy), names_to = "measure", values_to = "n") %>% 
 # pivot_wider(names_from = health_board, values_from = n) %>% 
  rename("Health Board" = "health_board")

median_hb_table <- SharedData$new(median_hb_table_data, key = ~fy, group = "median_hb")


bscols(widths = 12,
       div(style = css(width="97%", height="450px", margin="20px"),
DT::datatable(median_hb_table, rownames = FALSE, extensions = "FixedColumns",
              caption = htmltools::tags$caption(
                       style = 'caption-side: bottom; text-align: left;',
                       "A dash (-) indicates that due to data quality issues this measure could not be calculated."),
              options = list(pageLength = 15,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 1),
                                               list(className = 'dt-right', targets = 2:4)
                                               ))) %>%
           DT::formatStyle(1, fontWeight = "bold", #padding = "4px"
                          )
        )
     )



```

### **Trend**

```{r dropdown-wait-trend}
wait_data_trend_all <- wait_data %>% filter(sex == "All", simd == "All") %>% 
                                     mutate(ijb = if_else(ijb == "All", health_board, ijb)) %>%
                                     rename(geog = ijb) %>% select(geog, fy, median_diagnosis_to_contact) %>% 
  #coding Aberdeen City and NHS Grampian medians as -999 so they do not appear on chart
            mutate(median_diagnosis_to_contact = 
              if_else(geog == "Aberdeen City" & fy %in% c("2019/20", "2020/21"), -999, median_diagnosis_to_contact)) %>% 
            mutate(median_diagnosis_to_contact = 
              if_else(geog == "NHS Grampian" & fy %in% c("2019/20", "2020/21"), -999, median_diagnosis_to_contact))

wait_data_trend_plot <- wait_data_trend_all %>% 
          mutate(median_diagnosis_to_contact = if_else(median_diagnosis_to_contact < 0, NA, median_diagnosis_to_contact))
  
wait_data_trend_plot$geog<- factor(wait_data_trend_plot$geog, levels = unique(pds_all$geog))

wait_data_trend <- SharedData$new(wait_data_trend_plot %>% arrange(geog), key = ~geog)

data_filter_wait_trend <- filter_select(id = "trend_filter_wait",
                                    label = "Select Integration Authority Area(s) or Health Board(s):",
                                    group = ~geog,
                                    sharedData = wait_data_trend
                                   )
bscols(widths = c(1,10,NA),NULL,
data_filter_wait_trend,NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px">Average (median) days from diagnosis to first contact by PDS practitioner</h2>
```{r plot-wait-trend}

  wait_plot_trend <- #plot_trend(wait_data_trend, median_diagnosis_to_contact, x ="Financial Year of Diagnosis", y = "Median Wait (days)", colours = phs_colours_46, measure_text = "Average (median) days from diagnosis to first contact: ")
plotly_trend_median(wait_data_trend)
  #       x = ~fy, y = ~median_diagnosis_to_contact, 
  #       hovertext = ~geog,
  #       type = 'scatter', mode = "lines+markers", color = ~geog, colors = phs_colours_46,
  #       hovertemplate = paste0("%{hovertext} <br>", "%{x} <br>", 
  #                              "Average (median) days from diagnosis to first contact: %{y}<extra></extra>")
  #     ) %>% 
  # layout(clickmode = "none", showlegend = TRUE, legend = list(orientation = 'h', xanchor = "center", x = 0.5, y = -0.3),
  #        margin = list(l = -5, b = 10, t = 40),
  #        xaxis = list(title = "Financial Year of Diagnosis", showline = FALSE, linecolor = "#b3b3b3",
  #                     categoryorder = "trace", tickangle = -45, titlefont = list(size = 16)
  #                     ),
  #        yaxis = list(title = "Median Wait (days)", linecolor = "#b3b3b3", titlefont = list(size = 16), 
  #                     rangemode = "tozero")
  # ) %>%
  # config(displayModeBar = TRUE, doubleClick = F,
  #        modeBarButtonsToRemove = list('select2d', 'lasso2d', 'zoomIn2d', 
  #                                      'zoomOut2d', 'autoScale2d', 
  #                                      'toggleSpikelines', 
  #                                      'hoverCompareCartesian', 
  #                                      'hoverClosestCartesian', 'toImage'), 
  #        displaylogo = F, editable = F)


bscols(widths = 12,
        div(style = css(width="98%", height="385px"),
wait_plot_trend)
)
```

```{r table-wait-trend}
wait_data_trend_table <-
wait_data_trend_all %>% arrange(geog) %>% 
              mutate(median_diagnosis_to_contact = if_else(median_diagnosis_to_contact < 0, "-", as.character(median_diagnosis_to_contact))) %>% 
           # mutate(median_diagnosis_to_contact = 
             # if_else(geog == "Aberdeen City" & fy %in% c("2019/20", "2020/21"), "-", median_diagnosis_to_contact)) %>% 
          #  mutate(median_diagnosis_to_contact = 
             # if_else(geog == "NHS Grampian" & fy %in% c("2019/20", "2020/21"), "-", median_diagnosis_to_contact)) %>%           
  pivot_wider(names_from = fy, values_from = median_diagnosis_to_contact) %>%
            rename(`Integration Authority Area/Health Board` = geog)# %>%
            #kable(align = c("l", rep("r", length(all_years)))) %>%
            #kable_styling(full_width = TRUE) %>%
            #column_spec(1, bold = TRUE) %>%
  # Add header above table
            #add_header_above(
                   # c(" " = 1,
                 #    "Financial Year of Diagnosis" = length(all_years))) %>%
  # add_footnote(label = "A dash (\\-) indicates that this measure could not be calculated due to data quality issues.") %>% 
           # scroll_box(height = "470px")


bscols(widths = 12,
       div(style = css(width="97%", height="580px", margin="20px"),
    DT::datatable(wait_data_trend_table, rownames = FALSE,  
                                       caption = htmltools::tags$caption(
                       style = 'caption-side: bottom; text-align: left;',
                       "A dash (-) indicates that due to data quality issues this measure could not be calculated."),
                       options = list(pageLength = 46,
                             scrollX = FALSE,
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(className = 'dt-right', 
                                                    targets = 2:length(all_years))
                                                ))) %>%
           DT::formatStyle(1, fontWeight = "bold",
                           )
        )
     )


```

### **Waiting Times Breakdown**

```{r dropdown-wait}
wait_data_all <- wait_data %>% 
      filter(sex == "All", simd == "All") %>% 
  mutate(ijb = if_else(ijb == "All", health_board, ijb)) %>% 
  rename(geog = ijb) %>% 
      select(geog, fy, total_referrals, median_diagnosis_to_referral,
             perc_allocated, median_referral_to_allocation,
             perc_contacted, median_allocation_to_contact,
             median_diagnosis_to_contact) %>% 
   mutate(across(starts_with("perc"), ~ paste0(.,"%"))) %>%
  mutate(across(starts_with("median"), ~ replace(., is.na(.) | .<0, "-"))) %>% 
        mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
    mutate(across(starts_with("perc"),
                  ~if_else(geog == "Aberdeen City" & fy %in% c("2019/20", "2020/21"), "-", .))) %>%
    mutate(across(starts_with("median"),
                  ~if_else(geog == "Aberdeen City" & fy %in% c("2019/20", "2020/21"), "-", .))) %>% 
  mutate(across(starts_with("perc"),
                  ~if_else(geog == "NHS Grampian" & fy %in% c("2019/20", "2020/21"), "-", .))) %>%
  mutate(across(starts_with("median"),
                  ~if_else(geog == "NHS Grampian" & fy %in% c("2019/20", "2020/21"), "-", .))) 

wait_data_all$geog<- factor(wait_data_all$geog, levels = unique(pds_all$geog))

   wait_data_all %<>% arrange(geog) %>% set_colnames(c("Integration Authority Area/Health Board", "fy", "Number of People Referred to PDS",  "Average (median) days from diagnosis to PDS referral",
                     "% of Referrals allocated to PDS practitioner", "Average (median) days from referral to allocation of PDS practitioner", 
                     "% of Referrals contacted by PDS practitioner",  "Average (median) days from allocation to first contact with PDS practitioner",
                     "Average (median) days from diagnosis to first contact"
      )) 



wait_table_data_all <- SharedData$new(wait_data_all)

data_filter_all_year <- filter_select(id = "wait_filter_all_year",
                                    label = "Select Financial Year of Diagnosis:",
                                    group = ~fy,
                                    sharedData = wait_table_data_all,
                                    multiple = FALSE
                                   )

bscols(widths = c(1,4,NA), NULL,
data_filter_all_year, NULL)

```

<h2 style="margin-left: 30px; margin-top: 0px; margin-bottom: 0px"> Pathways from diagnosis to first contact by PDS practitioner </h2>
<h4 style="margin-left: 60px; margin-top: 0px; margin-bottom: -10px; font-style: italic">Please see notes section above for more information</h4>
```{r wait-table-all}
bscols(widths = 12,
       div(style = css(width="97%", height="770px", margin="20px"),
    DT::datatable(wait_table_data_all, rownames = FALSE,  
                                       caption = htmltools::tags$caption(
                       style = 'caption-side: bottom; text-align: left;',
                       "A dash (-) indicates that due to data quality issues this measure could not be calculated."),
                       options = list(pageLength = 46,
                             scrollX = FALSE,
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 1),
                                                list(className = 'dt-right', targets = 2:8)
                                                #list(width = '10px', targets = 1:10)
                                                ))) %>%
           DT::formatStyle(1, fontWeight = "bold",
                           ) %>%
           DT::formatStyle(9, fontWeight = "bold",
                           backgroundColor = "#E1C7DF"
                          )
        )
     )

  

```

Outcomes {.hidden}
=================================================

```{r add-percentage-function, include=FALSE}

add_percent <- function(df, value, name) {
  
 data <- df %>%  mutate(perc =  if_else(total == 0, "-",
    paste0(round(100*{{value}}/total,1), "%")))
  
colnames(data)[colnames(data) == 'perc'] <- name

return(data)
  
}

```

Sidebar - outcomes{.sidebar}
-----------------------------------------------------------------------

<br>

### Pathways - PDS Outcomes

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Pathways - Waiting Times](#pds-pathways)</li>
  <li>[**Pathways - PDS Outcomes**](#outcomes)</li>
  <li>[Pathways - Uptake Decision](#uptake)</li>
  <li>[Pathways - No Contact within 12 Months](#no-contact)</li>
</ul>

***

**FURTHER INFORMATION:**

<ul style="list-style-type:square;">
   <li >[Methodology](#methodology)</li>
   <li >[Glossary](#glossary)</li>
   <li >[Navigation Guide](#navigation-guide)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

This page includes further information for referrals relating to the LDP Standard. *See the [Methodology](#methodology) page for more details.* 

The LDP Standard Not Met tab provides a table showing the percentage of total referrals and number of individuals who did not receive a minimum of one year’s PDS starting within 12 months of diagnosis, along with the percentage for each reason for not meeting the LDP Standard for Scotland, Integration Authority Areas and Health Boards by financial year. 

The PDS Ongoing tab includes a table showing the percentage of total referrals and number of individuals where the LDP Standard cannot yet be determined and is therefore classed as Ongoing. Data is only shown for the financial years where referrals could still be ongoing. *See the [Glossary](#glossary) for more details.* The table also shows what percentage of the ongoing referrals are yet to start PDS with less than 12 months since diagnosis, and the percentage still receiving PDS with less than 12 months since first contact. 

The Exempt tab includes a table showing the percentage of total referrals and number of individuals who are exempt from the LDP Standard for Scotland, Integration Authority Areas and Health Boards by financial year. 

*As PDS for some referrals in `r provisional_year` onwards is still ongoing, it is not known yet whether or not they will meet the LDP standard. Therefore, the figures shown for these years are currently provisional and subject to change in future versions of this report.*

`r if(qt != 4) {div(style = css(fontStyle="italic"),paste0("For diagnoses in financial year ", current_fy, " data is available up to and including Q", qt, "."))}`
`r if(qt != 4) {HTML("<br>")}`
**Please note:** *Aberdeen City Health & Social Care Partnership changed to provide PDS in 2019 to an inhouse hybrid model. This change in model, and process of receiving referrals and recording, resulted in data quality issues for financial years 2019/20 and 2020/21. This should be taken into account when interpreting figures for Aberdeen City and NHS Grampian.*

Row {.tabset data-height=790}
----------------------------------------------------------------------

### **LDP Standard Not Met**

```{r dropdown-not-met}
not_met_data <- pds_all %>% filter(ldp == "fail") %>% group_by(geog, fy, ldp_full) %>% 
  summarise(referrals = sum(referrals), .groups = "drop") %>% mutate(ldp_full = substring(ldp_full, 8)) %>% 
  pivot_wider(names_from = ldp_full, values_from = referrals) %>%
    mutate(total = rowSums(across(where(is.numeric))), .after = fy) %>% 
   add_percent(`PDS started more than 12 months after diagnosis`, "started_more_than_12") %>% 
  add_percent(`PDS not started and more than 12 months since diagnosis`, "no_contact_more_than_12") %>% 
   add_percent(`PDS terminated less than 11 months after first contact`, "ended_after_contact") %>% 
   add_percent(`PDS terminated before first contact`, "ended_without_contact") %>% 
   select(-starts_with("PDS"))

not_met_data_totals <- left_join(pds_all_totals %>% 
                               select(-age_grp_2), not_met_data) %>% 
    mutate(perc_of_total = paste0(round(100*total/total_referrals,1), "%"),
                                              .after = total_referrals) %>% 
  mutate(across(where(is.numeric), ~format(., big.mark = ","))) 

not_met_table_data <- SharedData$new(not_met_data_totals)

 data_filter_not_met_year <- filter_select(id = "not_met_filter_year",
                                     label = "Select Financial Year of Diagnosis:",
                                     group = ~fy,
                                     sharedData = not_met_table_data,
                                    multiple = FALSE
                                    )

 bscols(widths = c(1,4,NA), NULL,
 data_filter_not_met_year, NULL)

```

<h2 style="margin-left: 30px; margin-top: 0px; margin-bottom: -10px">Individuals who did not receive a minimum of one year’s PDS (Standard Not Met)</h2>
```{r not-met-table}


headers_notmet <- htmltools::withTags(table(
  class = 'display',
  thead(
    tr( 
      th(rowspan = 2, "Integration Authority Area/Health Board"),
      th(rowspan = 2, " "),
      th(rowspan = 2, "Total referrals"),
      th(rowspan = 2, "% of Total referrals Standard Not Met"),
      th(rowspan = 2, "Standard Not Met"),
      th(colspan = 4, "% of Standard Not Met", style = css(textAlign="center"))

    ),
    tr(
      th(colspan = 1, "First contact occurred more than 12 months after diagnosis"),
      th(colspan = 1, "No contact and more than 12 months since diagnosis"),
      th(colspan = 1, "PDS terminated less than 11 months after first contact"),
      th(colspan = 1, "PDS terminated without contact")
    )
  )
))

bscols(widths = 12,
       div(style = css(width="97%", height="575px", margin="20px"),
    DT::datatable(not_met_table_data, container = headers_notmet,
                         rownames = FALSE,
                         # caption = htmltools::tags$caption(
                         # style = 'caption-side: bottom; text-align: left;',
                         # "A dash (-) indicates no dates of referral were submitted for diagnoses in this
                         #      year."),
                         options = list(pageLength = 46,
                                        scrollX = FALSE,
                                        scrollY = TRUE,
                                        dom = "t",
                                        ordering = FALSE,
                                        columnDefs = list(list(visible = FALSE, targets = 1),
                                                          list(className = 'dt-right', targets = 2:8)
                                                          #list(width = '10px', targets = 1:10)
                                        ))) %>%
             DT::formatStyle(1, fontWeight = "bold"#, padding = "4px"
             ) %>% 
             DT::formatStyle(5, `border-right` = "solid 1px")

        )
     )


```

### **PDS Ongoing**

```{r dropdown-ongoing}
ongoing_data <- pds_all %>% filter(ldp == "ongoing") %>% group_by(geog, fy, ldp_full) %>% 
  summarise(referrals = sum(referrals), .groups = "drop") %>% mutate(ldp_full = substring(ldp_full, 11)) %>%   pivot_wider(names_from = ldp_full, values_from = referrals) %>%
   mutate(total = rowSums(across(where(is.numeric))), .after = fy) %>% 
   add_percent(`PDS not started and less than 12 months since diagnosis`, "not_started") %>% 
 add_percent(`Still receiving PDS and less than 12 months since first contact`, "started") %>% 
  select(-`PDS not started and less than 12 months since diagnosis`, -`Still receiving PDS and less than 12 months since first contact`)

ongoing_data_totals <- left_join(pds_all_totals %>% 
                               select(-age_grp_2), ongoing_data) %>% 
   mutate(`% of Total referrals PDS Ongoing` = paste0(round(100*total/total_referrals,1), "%"),
                                              .after = total_referrals) %>% 
  filter(!fy %in% finalised_years) %>% 
  rename(`Integration Authority Area/Health Board` = geog, 
         `Total referrals` = total_referrals,
         `PDS Ongoing` = total) %>% mutate(across(where(is.numeric), ~format(., big.mark = ","))) 

ongoing_table_data <- SharedData$new(ongoing_data_totals)

 data_filter_ongoing_year <- filter_select(id = "ongoing_filter_year",
                                     label = "Select Financial Year of Diagnosis:",
                                     group = ~fy,
                                     sharedData = ongoing_table_data,
                                    multiple = FALSE
                                    )

 bscols(widths = c(1,4,NA), NULL,
 data_filter_ongoing_year, NULL)

```

<h2 style="margin-left: 30px; margin-top: 0px; margin-bottom: -10px">Individuals where LDP Standard cannot yet be determined (PDS Ongoing)</h2>
```{r ongoing-table}

headers_ongoing <- htmltools::withTags(table(
  class = 'display',
  thead(
    tr( 
      th(rowspan = 2, "Integration Authority Area/Health Board"),
      th(rowspan = 2, " "),
      th(rowspan = 2, "Total referrals"),
      th(rowspan = 2, "% of Total referrals PDS Ongoing"),
      th(rowspan = 2, "PDS Ongoing"),
      th(colspan = 2, "% of PDS Ongoing", style = css(textAlign="center"))
    ),
    tr(
      th(colspan = 1, "Less than 12 months since diagnosis and PDS not yet started"),
      th(colspan = 1, " Still receiving PDS and less than 12 months since first contact")
    )
  )
))

bscols(widths = 12,
       div(style = css(width="97%", height="580px", margin="20px"),
    DT::datatable(ongoing_table_data, container = headers_ongoing, rownames = FALSE,
                                       # caption = htmltools::tags$caption(
                      # style = 'caption-side: bottom; text-align: left;',
                      # "A dash (-) indicates no dates of referral were submitted for diagnoses in this
                        #      year."),
                       options = list(pageLength = 46,
                             scrollX = FALSE,
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 1),
                                                list(className = 'dt-right', targets = 2:6)
                                                #list(width = '10px', targets = 1:10)
                                                ))) %>%
           DT::formatStyle(1, fontWeight = "bold"#, padding = "4px"
                          ) %>% 
      DT::formatStyle(5, `border-right` = "solid 1px")
        )
     )


```

### **Exempt**

```{r dropdown-exempt}
exempt_data <- pds_all %>% filter(ldp == "exempt") %>% group_by(geog, fy, ldp_full) %>% 
  summarise(referrals = sum(referrals), .groups = "drop") %>% mutate(ldp_full = substring(ldp_full, 10)) %>%   pivot_wider(names_from = ldp_full, values_from = referrals) %>%
   mutate(total = rowSums(across(where(is.numeric))), .after = fy) %>% 
   add_percent(`03 Service user has died`, "% 03 Service user has died") %>% 
 add_percent(`04 Service user has moved to a different Health Board area`, "% 04 Service user has moved to a different Health Board area") %>% 
  add_percent(`05 Service user has terminated PDS early/refused`, "% 05 Service user has terminated PDS early/refused") %>% 
  add_percent(`06 Service user no longer able to engage in PDS`, "% 06 Service user no longer able to engage in PDS") %>% 
  select(-starts_with("0"))

exempt_data_totals <- left_join(pds_all_totals %>% 
                               select(-age_grp_2), exempt_data) %>% 
   mutate(`% of Total referrals Exempt` = paste0(round(100*total/total_referrals,1), "%"),
                                              .after = total_referrals) %>% 
  rename(`Integration Authority Area/Health Board` = geog, 
         `Total referrals` = total_referrals,
         `Number of referrals Exempt` = total) %>% mutate(across(where(is.numeric), ~format(., big.mark = ","))) 

exempt_table_data <- SharedData$new(exempt_data_totals)

 data_filter_exempt_year <- filter_select(id = "exempt_filter_year",
                                     label = "Select Financial Year of Diagnosis:",
                                     group = ~fy,
                                     sharedData = exempt_table_data,
                                    multiple = FALSE
                                    )

 bscols(widths = c(1,4,NA), NULL,
 data_filter_exempt_year, NULL)

```

<h2 style="margin-left: 30px; margin-top: 0px; margin-bottom: -20px">Individuals exempt from LDP Standard</h2>
```{r exempt-table}

bscols(widths = 12,
       div(style = css(width="97%", height="585px", margin="20px"),
    DT::datatable(exempt_table_data, rownames = FALSE,
                                       # caption = htmltools::tags$caption(
                      # style = 'caption-side: bottom; text-align: left;',
                      # "A dash (-) indicates no dates of referral were submitted for diagnoses in this
                        #      year."),
                       options = list(pageLength = 46,
                             scrollX = FALSE,
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(1,5,6,7,8)), #removes exemption reasons for data governance purposes
                                                list(className = 'dt-right', targets = 2:8)
                                                #list(width = '10px', targets = 1:10)
                                                ))) %>%
           DT::formatStyle(1, fontWeight = "bold"#, padding = "4px"
                          )
        )
     )


```

Uptake{.hidden}
=====================================

Sidebar - uptake{.sidebar}
-----------------------------------------------------------------------

<br>

### Pathways - Uptake Decision
***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Pathways - Waiting Times](#pds-pathways)</li>
  <li>[Pathways - PDS Outcomes](#outcomes)</li>
  <li>[**Pathways - Uptake Decision**](#uptake)</li>
  <li>[Pathways - No Contact within 12 Months](#no-contact)</li>
</ul>

***

**FURTHER INFORMATION:**

<ul style="list-style-type:square;">
   <li >[Glossary](#glossary)</li>
   <li >[Navigation Guide](#navigation-guide)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

This page includes a table showing the percentage of total referrals where ‘PDS uptake decision’ has been recorded along with the percentage which have been recorded as ‘Accepted’ or ‘Accepted but initially declined’ for Integration Authority Areas and Health Boards with comparison to Scotland for each financial year. 

*The figures shown for `r provisional_year` onwards are currently provisional and subject to change in future versions of this report.*

`r if(qt != 4) {div(style = css(fontStyle="italic"),paste0("For diagnoses in financial year ", current_fy, " data is available up to and including Q", qt, "."))}`
`r if(qt != 4) {HTML("<br>")}`
**Please note:** *Aberdeen City Health & Social Care Partnership changed to provide PDS in 2019 to an inhouse hybrid model. This change in model, and process of receiving referrals and recording, resulted in data quality issues for financial years 2019/20 and 2020/21. This should be taken into account when interpreting figures for Aberdeen City and NHS Grampian.*

Row {.tabset data-height=920}
----------------------------------------------------------------------

### **Integration Authority Areas**

```{r dropdown-uptake-ijb}

 table_ijb_uptake_data <- left_join(bind_rows(pds_scot_totals, pds_ijb_totals),
  
  uptake_data %>% 
      filter(age_grp_2 == "All", simd == "All") %>% 
      mutate(ijb = if_else(health_board == "Scotland", "AAA", ijb)) %>%
      arrange(ijb) %>% 
      filter(ijb != "All") %>% 
      mutate(ijb = if_else(ijb == "AAA", "Scotland", ijb)) %>%
      pivot_wider(names_from = pds_uptake_decision, values_from = referrals) %>% 
      mutate(across(where(is.numeric), ~ replace(., is.na(.), 0))) %>% rename("geog" = "ijb")
  ) %>% 
       mutate(Known = total_referrals - `Not Known`) %>% 
       mutate(perc_known = paste0(round(100*Known/total_referrals,1), "%")) %>%
      select(2,1,4,7,8,9,10,11,12) %>% 
  mutate(perc_declined = if_else(Known == 0, "-", paste0(round(100*Declined/Known,1), "%"))) %>%
  mutate(perc_accepted = if_else(Known == 0, "-", paste0(round((Accepted + `Accepted, but Initially Declined`)/Known*100,1), "%"))) %>%  
          mutate(across(where(is.numeric), ~format(., big.mark = ","))
                    ) %>% 
  select(fy, geog, total_referrals, perc_known, perc_accepted, perc_declined) %>% 
  rename("Number of People Referred to PDS" = "total_referrals",
         "% of referrals where Uptake Decision is Recorded" = "perc_known",
             "% Accepted (includes those initially declined)" = "perc_accepted",
         "% Declined" = "perc_declined") %>% 
  #remove Aberdeen City 2019/20 and 2020/21 data
  mutate(across(starts_with("%"), ~if_else(geog == "Aberdeen City" & fy %in% c("2019/20","2020/21"), "-", .))) %>% 
    rename("Integration Authority Area" = "geog")


table_ijb_uptake <- SharedData$new(table_ijb_uptake_data)

data_filter_uptake_ijb <- filter_select(id = "filter_uptake_ijb_year",
                                    label = "Select Financial Year of Diagnosis:",
                                    group = ~fy,
                                    sharedData = table_ijb_uptake,
                                    multiple = FALSE
                                   )
bscols(widths = c(1,5,NA),
       NULL,
       data_filter_uptake_ijb,
       NULL)

```

<h2 style="margin-left: 30px; margin-top: 0px; margin-bottom: 0px"> Referrals by PDS Uptake Decision; Integration Authority Areas</h2>
```{r table-uptake-ijb}



bscols(widths = 12,
       div(style = css(width="98%", height="710px", margin="15px"),
          DT::datatable(table_ijb_uptake, rownames = FALSE,
                       # caption = htmltools::tags$caption(
                      # style = 'caption-side: bottom; text-align: left;',
                       #"A dash (-) indicates that due to data quality issues this measure could not be calculated."),
              options = list(pageLength = 32,
                             scrollX = FALSE,
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,5)),
                                               list(className = 'dt-right', targets = 2:4)
                             ))) %>%
  DT::formatStyle(2, fontWeight = "bold")
            )
       )




```

### **Health Boards**

```{r dropdown-uptake-hb}

 table_hb_uptake_data <- left_join(bind_rows(pds_scot_totals, pds_hb_totals),
  
  uptake_data %>% 
      filter(age_grp_2 == "All", simd == "All") %>% 
     filter(ijb == "All" | ijb == "Scotland") %>% 
      pivot_wider(names_from = pds_uptake_decision, values_from = referrals) %>% 
      mutate(across(where(is.numeric), ~ replace(., is.na(.), 0))) %>% rename("geog" = "health_board")
  ) %>% 
       mutate(Known = total_referrals - `Not Known`) %>% 
       mutate(perc_known = paste0(round(100*Known/total_referrals,1), "%")) %>%
      select(2,1,4,7,8,9,10,11,12) %>% 
  mutate(perc_declined = if_else(Known == 0, "-", paste0(round(100*Declined/Known,1), "%"))) %>%
  mutate(perc_accepted = if_else(Known == 0, "-", paste0(round((Accepted + `Accepted, but Initially Declined`)/Known*100,1), "%"))) %>%  
          mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  select(fy, geog, total_referrals, perc_known, perc_accepted, perc_declined) %>% 
  rename("Number of People Referred to PDS" = "total_referrals",
         "% of referrals where Uptake Decision is Recorded" = "perc_known",
             "% Accepted (includes those initially declined)" = "perc_accepted",
         "% Declined" = "perc_declined") %>% 
   rename("Health Board" = "geog")




 # table_hb_uptake_data <- uptake_data %>% 
 #      filter(age_grp_2 == "All", simd == "All") %>% 
 #      filter(ijb == "All" | ijb == "Scotland") %>% 
 #      pivot_wider(names_from = pds_uptake_decision, values_from = referrals) %>% 
 #      mutate(across(where(is.numeric), ~ replace(., is.na(.), 0))) %>% 
 #      adorn_totals("col") %>% 
 #      select(3,1,10,6,7,8,9) %>% 
 #      rowwise() %>% 
 #  mutate(perc_accepted = paste0(round(sum(c_across(4:5))/sum(c_across(3))*100,1), "%")) %>%   
 #      mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
 #  rename("Number of People Referred to PDS" = "Total", 
 #             "Health Board" = "health_board",
 #             "% Accepted (includes those initially declined)" = "perc_accepted")


table_hb_uptake <- SharedData$new(table_hb_uptake_data)

data_filter_uptake_hb <- filter_select(id = "filter_uptake_hb_year",
                                    label = "Select Financial Year of Diagnosis:",
                                    group = ~fy,
                                    sharedData = table_hb_uptake,
                                    multiple = FALSE
                                   )
bscols(widths = c(1,5,NA),
       NULL,
       data_filter_uptake_hb,
       NULL)

```

<h2 style="margin-left: 30px; margin-top: 0px; margin-bottom: 0px"> Referrals by PDS Uptake Decision; Health Boards</h2>
```{r table-uptake-hb}

bscols(widths = 12,
       div(style = css(width="98%", height="710px", margin="15px"),
          DT::datatable(table_hb_uptake, rownames = FALSE,
              options = list(pageLength = 15,
                             scrollX = FALSE,
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,5)),
                                               list(className = 'dt-right', targets = 2:4)
                             ))) %>%
  DT::formatStyle(2, fontWeight = "bold")
            )
       )


```

No Contact {.hidden}
=================================================
Sidebar - no contact{.sidebar}
-----------------------------------------------------------------------

<br>

### Pathways - No Contact within 12 Months
***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Pathways - Waiting Times](#pds-pathways)</li>
  <li>[Pathways - PDS Outcomes](#outcomes)</li>
  <li>[Pathways - Uptake Decision](#uptake)</li>
  <li>[**Pathways - No Contact within 12 Months**](#no-contact)</li>
</ul>

***

**FURTHER INFORMATION:**

<ul style="list-style-type:square;">
   <li >[Glossary](#glossary)</li>
   <li >[Navigation Guide](#navigation-guide)</li>
</ul>

***
Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

This page provides tables for Scotland, Integration Authority Areas and Health Boards for the selected financial year, showing: 

the number of individuals and percentage of total referrals with no contact date recorded within 12 months of diagnosis; 

the number and percentage of total referrals whose PDS was ended with no contact date recorded, including those exempt from the LDP Standard. 

*The figures shown for `r provisional_year` onwards are currently provisional and subject to change in future versions of this report.*

`r if(qt != 4) {div(style = css(fontStyle="italic"),paste0("For diagnoses in financial year ", current_fy, " data is available up to and including Q", qt, "."))}`
`r if(qt != 4) {HTML("<br>")}`
**Please note:** *Aberdeen City Health & Social Care Partnership changed to provide PDS in 2019 to an inhouse hybrid model. This change in model, and process of receiving referrals and recording, resulted in data quality issues for financial years 2019/20 and 2020/21. This should be taken into account when interpreting figures for Aberdeen City and NHS Grampian.*

Row {.tabset data-height=680}
----------------------------------------------------------------------

### **Integration Authority Areas**

```{r dropdown-no-contact-ijb}

no_contact_term_ijb <- term_data_no_contact %>%  
    filter(sex == "All", termination_or_transition_reason == "All reasons", ldp == "All") %>%
    filter(!grepl("NHS", ijb)) %>% 
    pivot_wider(names_from = ldp, values_from = c(referrals, median_referral_to_termination)) %>%
    select(fy, ijb,
           referrals_All) %>% rename(referrals_no_contact_term = referrals_All)
    
totals_ijb <- wait_data %>% filter(sex == "All", simd == "All", ijb != "All" | ijb == "Scotland") %>% select(ijb, fy, total_referrals)

no_contact_12_ijb <- pds_all %>% filter(!grepl("NHS", geog), ldp_full == "fail - PDS not started and more than 12 months since diagnosis" | ldp_full == "fail - PDS started more than 12 months after diagnosis") %>% 
   group_by(fy, geog) %>% summarise(referrals_no_contact_12 = sum(referrals)) %>% rename(ijb = geog)
 
ijb_totals_12 <- left_join(totals_ijb, no_contact_12_ijb)

no_contact_ijb <- left_join(ijb_totals_12, no_contact_term_ijb) %>% 
  mutate(across(starts_with("referrals"), ~ replace(., is.na(.), 0))) %>%
    mutate(across(starts_with("median"), ~ replace(., is.na(.), "-"))) %>% 
     mutate(perc_no_contact_term = paste0(round((referrals_no_contact_term/total_referrals)*100,1),"%")) %>% 
   mutate(perc_no_contact_12 = paste0(round((referrals_no_contact_12/total_referrals)*100,1),"%")) %>% 
  select(fy, ijb,
         total_referrals,
         perc_no_contact_12, referrals_no_contact_12,
         perc_no_contact_term, referrals_no_contact_term) %>% 
    mutate(ijb = if_else(ijb == "Scotland", "AAA", ijb)) %>% arrange(ijb) %>%
    mutate(ijb = if_else(ijb == "AAA", "Scotland", ijb)) %>% 
    mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
   mutate(across(starts_with("perc"),
                  ~if_else(ijb == "Aberdeen City" & fy %in% c("2019/20", "2020/21"), "-", .))) %>%
   mutate(across(starts_with("referrals"),
                  ~if_else(ijb == "Aberdeen City" & fy %in% c("2019/20", "2020/21"), "-", .))) %>% 
    set_colnames(c("fy", "Integration Authority Area", "Number of People Referred to PDS",
                   "% of total referrals not contacted within 12 months of diagnosis",
                   "Number of referrals not contacted within 12 months of diagnosis",
                   "% of total referrals whose PDS ended with no contact",
                   "Number of referrals whose PDS ended with no contact"))
    

no_contact_table_data_ijb <- SharedData$new(no_contact_ijb)

data_filter_year_no_contact_ijb <- filter_select(id = "no_contact_filter_year_ijb",
                                    label = "Select Financial Year of Diagnosis:",
                                    group = ~fy,
                                    sharedData = no_contact_table_data_ijb,
                                    multiple = FALSE
                                   )

bscols(widths = c(1,4,NA), NULL,
data_filter_year_no_contact_ijb, NULL)

```

<h2 style="margin-left: 30px; margin-top: 0px; margin-bottom: -20px">Individuals referred to PDS not contacted within 12 months of diagnosis; Integration Authority Areas</h2>
```{r no-contact-table-ijb}

bscols(widths = 12,
       div(style = css(width="97%", height="500px", margin="20px"),
     DT::datatable(no_contact_table_data_ijb, rownames = FALSE, caption = htmltools::tags$caption(
                       style = 'caption-side: bottom; text-align: left;',
                       "A dash (-) indicates that this measure could not be calculated due to data quality issues. Referrals not contacted within 12 months of diagnosis includes records with no contact date and those with a contact date more than 12 months after diagnosis."),
              options = list(pageLength = 33,
                             scrollX = FALSE,
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                                list(className = 'dt-right', targets = 2:6)
                                                #list(width = '30px', targets = 6)
                                                ))) %>%
           DT::formatStyle(2, fontWeight = "bold"#, padding = "4px"
                          ) %>% 
       DT::formatStyle(5, `border-right` = "solid 1px")
        )
     )

```

### **Health Boards**

```{r dropdown-no-contact-hb}

no_contact_term_hb <- term_data_no_contact %>%  
    filter(sex == "All", termination_or_transition_reason == "All reasons", ldp == "All") %>%
    filter(ijb == "Scotland" | grepl("NHS", ijb)) %>% 
    pivot_wider(names_from = ldp, values_from = c(referrals, median_referral_to_termination)) %>%
    select(fy, health_board,
           referrals_All) %>% rename(referrals_no_contact_term = referrals_All)
    
totals_hb <- wait_data %>% filter(sex == "All", simd == "All", ijb == "All" | ijb == "Scotland") %>% select(health_board, fy, total_referrals)

no_contact_12_hb <- pds_all %>% filter(geog == "Scotland" | grepl("NHS", geog), ldp_full == "fail - PDS not started and more than 12 months since diagnosis" | ldp_full == "fail - PDS started more than 12 months after diagnosis") %>% 
   group_by(fy, geog) %>% summarise(referrals_no_contact_12 = sum(referrals)) %>% rename(health_board = geog)
 
hb_totals_12 <- left_join(totals_hb, no_contact_12_hb)

no_contact_hb <- left_join(hb_totals_12, no_contact_term_hb) %>% 
  mutate(across(starts_with("referrals"), ~ replace(., is.na(.), 0))) %>%
    mutate(across(starts_with("median"), ~ replace(., is.na(.), "-"))) %>% 
     mutate(perc_no_contact_term = paste0(round((referrals_no_contact_term/total_referrals)*100,1),"%")) %>% 
   mutate(perc_no_contact_12 = paste0(round((referrals_no_contact_12/total_referrals)*100,1),"%")) %>% 
  select(fy, health_board,
         total_referrals,
         perc_no_contact_12, referrals_no_contact_12,
         perc_no_contact_term, referrals_no_contact_term) %>% 
     mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
   mutate(across(starts_with("%"),
                  ~if_else(health_board == "NHS Grampian" & fy %in% c("2019/20", "2020/21"), "-", .))) %>%
   mutate(across(starts_with("referrals"),
                  ~if_else(health_board == "NHS Grampian" & fy %in% c("2019/20", "2020/21"), "-", .))) %>% 
    set_colnames(c("fy", "Health Board", "Number of People Referred to PDS",
                   "% of total referrals not contacted within 12 months of diagnosis",
                   "Number of referrals not contacted within 12 months of diagnosis",
                   "% of total referrals whose PDS ended with no contact",
                   "Number of referrals whose PDS ended with no contact"))
    
no_contact_table_data_hb <- SharedData$new(no_contact_hb)

data_filter_year_no_contact_hb <- filter_select(id = "no_contact_filter_year_hb",
                                    label = "Select Financial Year of Diagnosis:",
                                    group = ~fy,
                                    sharedData = no_contact_table_data_hb,
                                    multiple = FALSE
                                   )

bscols(widths = c(1,4,NA), NULL,
data_filter_year_no_contact_hb, NULL)

```

<h2 style="margin-left: 30px; margin-top: 0px; margin-bottom: -20px">Individuals referred to PDS not contacted within 12 months of diagnosis; Health Boards</h2>
```{r no-contact-table-hb}
bscols(widths = 12,
       div(style = css(width="97%", height="500px", margin="20px"),
     DT::datatable(no_contact_table_data_hb, rownames = FALSE, caption = htmltools::tags$caption(
                       style = 'caption-side: bottom; text-align: left;',
                       "A dash (-) indicates insufficient data for this measure to be calculated. Referrals not contacted within 12 months of diagnosis includes records with no contact date and those with a contact date more than 12 months after diagnosis."),
              options = list(pageLength = 15,
                             scrollX = FALSE,
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                                list(className = 'dt-right', targets = 2:6)
                                                #list(width = '30px', targets = 6)
                                                ))) %>%
           DT::formatStyle(2, fontWeight = "bold"#, padding = "4px"
                          ) %>% 
       DT::formatStyle(5, `border-right` = "solid 1px")
        )
     )

```


```{js }

function filter_default() {


  document.getElementById("not_met_filter_year").getElementsByClassName("selectized") 
  [0].selectize.setValue(pds_year, false);

  document.getElementById("not_met_filter_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("ongoing_filter_year").getElementsByClassName("selectized") 
  [0].selectize.setValue(pds_year, false);

  document.getElementById("ongoing_filter_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("exempt_filter_year").getElementsByClassName("selectized") 
  [0].selectize.setValue(pds_year, false);

  document.getElementById("exempt_filter_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("wait_filter_all_year").getElementsByClassName("selectized") 
  [0].selectize.setValue(pds_year, false);

  document.getElementById("wait_filter_all_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_median").getElementsByClassName("selectized") 
  [0].selectize.setValue(pds_year, false);

  document.getElementById("filter_median").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_median_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue(pds_year, false);

  document.getElementById("filter_median_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("trend_filter_wait").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("trend_filter_wait").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_uptake_hb_year").getElementsByClassName("selectized") 
  [0].selectize.setValue(pds_year, false);

  document.getElementById("filter_uptake_hb_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_uptake_ijb_year").getElementsByClassName("selectized") 
  [0].selectize.setValue(pds_year, false);

  document.getElementById("filter_uptake_ijb_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("no_contact_filter_year_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue(pds_year, false);

  document.getElementById("no_contact_filter_year_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("no_contact_filter_year_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue(pds_year, false);

  document.getElementById("no_contact_filter_year_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");

 
  }
  
  $(document).ready(filter_default);

```
