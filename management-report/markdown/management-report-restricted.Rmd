---
title: "Dementia PDS Quarterly Management Report"
output: 
  flexdashboard::flex_dashboard:
    logo: phs-logo.png
    orientation: rows
    vertical_layout: scroll
---

```{r load-setup, include=FALSE}
source(here::here("code", "00_setup-environment.R"))
library(crosstalk) # for drop down menus
library(phsstyles)
library(htmltools)

# Write numbers with thousands separator
knit_hooks$set(inline = function(x){
  if(!is.character(x)){prettyNum(x, big.mark=",")}else{x}
})
```

---
date: "`r paste('Data as at', format(end_date, '%d %B %Y'))`"
---

```{r setup, include=FALSE}

# Remove tidylog
detach("package:tidylog", unload = TRUE)

# Load functions
walk(dir(here::here("functions"), full.names = TRUE), source)


# Load PDS data
pds <- read_rds(get_mi_data_path("final_data", ext = "rds", test_output = test_output)) %>% 
  
  # Remove codes from board and IJB
  mutate(health_board = str_sub(health_board, 3, -1),
         ijb          = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))

# Load expected diagnoses reference file
exp <- read_csv(get_exp_diagnoses_path())


# Load error summary
err <- read_rds(get_mi_data_path("error_data", ext = "rds", test_output = test_output)) %>% 

  mutate(ijb = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))

# calculate referrals for Scotland and health boards
pds_ijb <- pds %>% arrange(ijb)

pds_ijb %<>% rename(geog = ijb) 

pds_ijb$geog<- factor(pds_ijb$geog, levels = unique(pds_ijb$geog))

pds_scot <- pds %>% group_by(health_board = "Scotland", ijb = "Scotland", fy, month, ldp_full, ldp, age_grp_2, age_grp, simd, sex) %>%  summarise(referrals = sum(referrals), .groups = "drop")

pds_scot %<>% rename(geog = ijb) 

pds_scot$geog<- factor(pds_scot$geog, levels = unique(pds_scot$geog))

pds_hb <- pds %>% group_by(health_board, fy, month, ldp_full, ldp, age_grp_2, age_grp, simd, sex) %>% 
  summarise(referrals = sum(referrals), .groups = "drop") %>% mutate(ijb = health_board, .before = fy)

pds_hb %<>% rename(geog = ijb) 

pds_hb$geog<- factor(pds_hb$geog, levels = unique(pds_hb$geog))

# combine data for ijb, hb and Scotland
pds_all <- bind_rows(pds_scot, pds_hb, pds_ijb)

pds_all$geog<- factor(pds_all$geog, levels = unique(pds_all$geog))

#get totals for all geogs, hbs, ijbs, scotland
pds_all_totals <- pds_all %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_ijb_totals <- pds_ijb %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_hb_totals <- pds_hb %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_scot_totals <- pds_scot %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))


#get totals for all geogs, hbs, ijbs, scotland with LARGE AGE GROUPS
pds_all_totals_2 <- bind_rows(pds_all_totals,
  pds_all %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_all_totals_2$age_grp_2<- factor(pds_all_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))

pds_ijb_totals_2 <- bind_rows(pds_ijb_totals,
    pds_ijb %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_ijb_totals_2$age_grp_2<- factor(pds_ijb_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))


pds_hb_totals_2 <- bind_rows(pds_hb_totals,
    pds_hb %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_hb_totals_2$age_grp_2<- factor(pds_hb_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))


pds_scot_totals_2 <- bind_rows(pds_scot_totals,
    pds_scot %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_scot_totals_2$age_grp_2<- factor(pds_scot_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))

#load population rates data
pop_data <- read_rds("//conf/dementia/A&I/Outputs/management-report/lookups/pop_data.rds")

#create year lists
provisional_year <- paste0(as.numeric(substr(last(finalised_years),1,4)) + 1,
                           "/", as.numeric(substr(last(finalised_years),6,7)) + 1)

current_fy <- paste0(substr(fy,1,4),
                           "/", as.numeric(substr(fy,3,4)) + 1)

last_full_year <- if_else(qt == 4, current_fy, paste0(as.numeric(substr(fy,1,4)) - 1,
                           "/", as.numeric(substr(fy,3,4))))

all_years <- unique(pds_all$fy)

if(qt == 4){full_years = all_years}else{full_years = all_years[-length(all_years)]}

#load completion data
comp_data <- read_rds(get_mi_data_path("comp_data", ext = "rds", test_output = test_output))

# restricted geographies
restricted_hb <- c("Scotland", "NHS Greater Glasgow & Clyde", "NHS Highland", "NHS Lothian", "NHS Lanarkshire")

restricted_ijb <- c("Scotland", "Edinburgh City", "Glasgow City", "Highland", "North Lanarkshire", "South Lanarkshire")

```

Home
=================================================

Row
-------------------------------------------------

### **About This Report**

This report has been produced by Public Health Scotland (PHS) and contains analysis of performance against the [Scottish Government's LDP Standard](https://www.gov.scot/About/Performance/scotPerforms/NHSScotlandperformance/Dementia-LDP){target="_blank"} on provision of Dementia Post Diagnostic Support (PDS){target="_blank"}.

<span style="color:red"> **The information contained in this report is for management information only and should not be distributed widely.** </span>

These reports reflect the [Dementia PDS dataset](https://publichealthscotland.scot/media/20921/2023-12-14-dementia-pds-definitions-and-recording-guidance-v14.pdf){target="_blank"} effective 01 April 2019 and contain data for individuals diagnosed with dementia between **`r format(dmy(01042016), "%d %B %Y")`** and **`r format(end_date, "%d %B %Y")`** who were referred for post diagnostic support.

Data are submitted to PHS by health boards on a quarterly basis. Each health board provides updated information for all individuals referred for post diagnostic support with a diagnosis date from `r format(start_date, "%d %B %Y")` onwards. Therefore, data for diagnoses from this date onwards are refreshed in each management report and are based on the most recently submitted data. 

Information is shown at Scotland, Health Board and Integration Joint Board level using the drop down menus at the top of the page.

To ensure these reports are as useful as possible, we would welcome any comments or feedback you may have via the PHS Dementia PDS team mailbox at: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot).



Row
-------------------------------------------------

### **About the LDP Standard**

The Local Delivery Plan (LDP) standard is that *everyone newly diagnosed with dementia will be offered a minimum of one year’s post-diagnostic support, coordinated by an appropriately trained Link Worker, including the building of a person-centred support plan*. Performance is reported in two parts:

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">

1. The percentage of people estimated to be newly diagnosed with dementia who were referred for post-diagnostic support.

2. The percentage of people referred who received a minimum of one year’s worth of post-diagnostic support coordinated by a Link Worker, including the building of a person-centred support plan.

</div> <br>

For more detail on how the above is calculated, please see the [methodology](#methodology) page.

Further information regarding the Dementia PDS dataset and submission process can be found on the [Dementia PDS pages](https://publichealthscotland.scot/services/data-management/data-management-in-primary-social-and-community-care/dementia-post-diagnostic-support-pds/){target="_blank"}.


Row
-------------------------------------------------

### **Additional Notes**

*Please note the following:*

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**

**NHS Orkney** – NHS Orkney had no referrals in *2022/23* (*Q3* and *Q4*) and *2023/24* (*Q1* and *Q2*) as they were unable to access a consultant psychiatrist.

**NHS Shetland** - NHS Shetland did not have a PDS worker in post from *2022/23 Q1* through *2023/24 Q3*. As a result not all people referred to PDS could be allocated or contacted by a PDS worker within 12 months of diagnosis, hence they have been recorded as not having met the standard. A PDS worker was assigned in *2023/24 Q4* and the PDS service in Shetland has resumed.

**NHS Grampian** - Due to changes in service provider the figures for Aberdeen City in *2019/20* and *2020/21* have been affected.

**NHS Tayside** – Due to local IT system issues the figures for *2018/19* and *2019/20* have been affected. PHS have identified issues with the data submitted by NHS Tayside for *2023/24* and *2024/25*, which has resulted in some records showing as incorrectly having met the standard. PHS are working with the Health Board to try and rectify this data issue in future submissions.

**Please note:** In December 2016, the Scottish Government published a report: [2014-2020 Estimated and Projected Diagnosis Rates for Dementia in Scotland](https://www.gov.scot/publications/estimated-projected-diagnosis-rates-dementia-scotland-2014-2020/){target="_blank"}. For financial years *2021/22*, *2022/23* and *2023/24*, the rates referenced in the report were used to create national, age specific rates of dementia incidence per 1,000 population which were then applied to the National Records of Scotland (NRS) Mid-2021 Population Estimates to obtain the incidence estimates.


<!-- Scotland -->

```{r scotland, include=FALSE}

scotland <- map(.x = sort(unique(pds$fy)),
                .f = ~ set_env(data = pds,
                               exp  = exp,
                               hb   = "Scotland",
                               year = .x,
                               quarter = qt))

```

`r paste(knitr::knit_child(text = scotland), collapse = '')`


<!-- HEALTH BOARDS -->

```{r health-boards, include=FALSE}

health_boards <- pmap(expand.grid(sort(unique(pds$fy)),
                                  sort(unique(pds$health_board))), 
                      .f = ~ set_env(data = pds,
                                     exp  = exp,
                                     hb   = .y,
                                     year = .x,
                                     quarter = qt))

```

`r paste(knitr::knit_child(text = health_boards), collapse = '')`


<!-- TOTAL REFERRALS - TRENDS & RATES -->
`r knitr::knit_child("subpage-trends.Rmd")`

<!-- DEMOGRAPHICS -->
`r knitr::knit_child("subpage-demographics-restricted.Rmd")`

<!-- PATHWAYS -->
`r knitr::knit_child("subpage-pathways-restricted.Rmd")`

<!-- ADDITIONAL ANALYSIS -->
`r knitr::knit_child("subpage-additional-analysis-restricted.Rmd")`


Methodology 
=================================================

Row
-------------------------------------------------

### <!-- No Title -->

This page includes more detail regarding the methodology used to arrive at the figures in this report. It is hoped that by sharing this, the reports will be easier to understand and local reporting will be more consistent.


Row {.tabset data-height=800}
-------------------------------------------------

### **Local Delivery Plan (LDP) Standard Classification**

The following steps are taken to ensure the data is of sufficient quality for analysis:

* Remove records with diagnosis date outwith the reporting period.
* Remove records with missing diagnosis date.

#### LDP Standard Met

* Started PDS within 12 months of diagnosis and support ongoing after 12 months.
* Started PDS within 12 months of diagnosis and PDS ended after at least 11 months.

#### LDP Standard Not Met

* PDS started more than 12 months after diagnosis.
* PDS not started and more than 12 months has passed since diagnosis.
* PDS terminated (for non-exempt reason) less than 11 months after first contact date.
* PDS terminated (for non-exempt reason) before first contact made.

#### Exempt from LDP Standard

* No first contact date or less than 12 months between diagnosis and first contact date and one of the following termination reasons:
    * 03 Service user has died.
    * 04 Service user has moved to a different Health Board area.
    * 05 Service user has terminated PDS early/refused.
    * 06 Service user no longer able to engage in PDS.

#### PDS Ongoing

* Less than 12 months since diagnosis and PDS not yet started.
* PDS started within 12 months and not yet ended.


### **Number of Expected Diagnoses**

In December 2016, the Scottish Government published a report: [Estimated and Projected Diagnosis Rates for Dementia in Scotland: 2014-2020](https://www.gov.scot/publications/estimated-projected-diagnosis-rates-dementia-scotland-2014-2020/){target="_blank"}. Estimations in this report are available per calendar year and health board therefore analysis of this part of the LDP standard is unavailable by IJB or any other breakdowns. Information on the methodology used to calculate these figures and the limitations of this are available in the report.

For financial years *2021/22, 2022/23 and 2023/24,* the rates referenced in the report above were used to create national, age specific rates of dementia incidence per 1,000 population which were then applied to the National Records of Scotland (NRS) Mid-2021 Population Estimates to obtain the incidence estimates. 

Please note that as estimations are available by calendar year and figures in this report are by financial year, the estimation for the calendar year with the majority of months in the selected financial year is used. For example, analysis for financial year 2018/19 uses estimations for the calendar year 2018.


### **Removal of Duplicate Records**

For a relatively small number of individuals, multiple records have been submitted. To avoid counting these service users more than once, the following rules have been applied to select only one record per CHI Number:

1. Keep record with earliest diagnosis date. If these are the same, then;
2. Keep record with termination reason 04 Service user has moved to a different Health Board area. If no record was terminated for this reason, then;
3. Keep record with earliest first contact date.

There also exists a Service Level Agreement between NHS Highland and NHS Greater Glasgow & Clyde health boards, where some PDS is provided to Argyll & Bute residents by West Dunbartonshire IJB. The support provided to these service users has been apportioned to NHS Highland in this report, as part of the LDP Standard is a population based measure, and so by not including these Argyll & Bute residents this figure may be skewed.

If you have any queries regarding the above, please contact [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot).


Queries/Errors {data-navmenu="Data Quality"}
=================================================

Row
-------------------------------------------------

### <!-- No Title -->

This page includes information about data quality. Any queries/errors outstanding following the resubmission deadline will be included in analytical outputs such as these management reports and annual publication. Therefore, the better quality of data submitted, the more accurate these figures will be.


Row
-------------------------------------------------

### **Queries/Errors**

The table below shows the percentage of records which contain one or more queries/errors. Records with a missing diagnosis date or diagnosis date outwith the reporting period are not included in the below counts. Duplicate records are included.

```{r error summary}
err %>% 
  group_by(fy, health_board) %>% 
  summarise(err_rate = round_half_up(sum(total_errors) / sum(records) * 100, 1),
            .groups = "drop") %>%
  bind_rows(
    err %>% 
    group_by(fy = "All", health_board) %>% 
    summarise(err_rate = round_half_up(sum(total_errors) / sum(records) * 100, 1),
              .groups = "drop")) %>%
  mutate(err_rate = paste0(err_rate, "%")) %>%
  pivot_wider(names_from = fy,
              values_from = err_rate,
              values_fill = list(err_rate = "\\-")) %>%
  rename(`Health Board` = health_board) %>%
  kable() %>%
  kable_styling(full_width = FALSE) %>%
  row_spec(15, bold = TRUE) %>%
  # Add header above table 
  add_header_above(
        c(" " = 1,
          "Financial Year of Diagnosis" = length(all_years),
          " " = 1)) %>%
  add_footnote(label = paste("A dash (\\-) indicates no records were submitted",
                             "for diagnoses in this year."),
               notation = "none")
```


Number of Records Submitted {data-navmenu="Data Quality"}
=================================================

Row
-------------------------------------------------

### <!-- No Title -->

This page includes information about data quality. Any queries/errors outstanding following the resubmission deadline will be included in analytical outputs such as these management reports and annual publication. Therefore, the better quality of data submitted, the more accurate these figures will be.

Row
-------------------------------------------------

### **Number of Records Submitted**

The table below shows the number of records submitted by each Health Board. Records with a missing diagnosis date or diagnosis date outwith the reporting period are not included in the below counts. Duplicate records are included.

```{r record-summary}
err %>%
  filter(str_sub(fy, 1, 4) >= year(start_date)) %>%
  group_by(fy, health_board, ijb) %>% 
  summarise(records = sum(records),
            .groups = "drop") %>%
  bind_rows(
    err %>%
    group_by(fy = "All", health_board, ijb) %>% 
    summarise(records = sum(records),
              .groups = "drop")) %>%
  mutate(records = format(records, big.mark = ",")) %>%
  pivot_wider(names_from = fy, 
              values_from = records,
              values_fill = list(records = "0")) %>%
  arrange(health_board, ijb) %>%
  rename(`Health Board` = health_board,
         `Integration Joint Board (IJB)` = ijb) %>%
  kable(align = c("l", "l", rep("r", length(unique(err$fy)) + 1))) %>%
  kable_styling(full_width = FALSE) %>%
  row_spec(length(unique(paste(err$health_board, err$ijb))), bold = TRUE) %>%
  collapse_rows(columns = 1, valign = "top") %>%
  scroll_box(height = "740px")
```

Data Completion {data-navmenu="Data Quality"}
=================================================

Row
-------------------------------------------------

### <!-- No Title -->

This page includes information about data quality. Any queries/errors outstanding following the resubmission deadline will be included in analytical outputs such as these management reports and annual publication. Therefore, the better quality of data submitted, the more accurate these figures will be.

Row {.tabset data-height=765}
-------------------------------------------------

### **Ethnic Group**

<h2 style="margin-left: 10px; margin-top: 0px; margin-bottom: 0px">Number and Percentage of referrals with NA or code 98/99 entry (Unknown) for Ethnic Group</h2>
```{r ethnic-group-table}
ethnic_comp_data<-comp_data %>%
  filter(field_name == "ethnic_group") %>% 
  select(geog, fy, number_of_records, perc_of_records_missing_not_known) %>% 
  mutate(perc_of_records_missing_not_known = paste0(perc_of_records_missing_not_known, "%")) %>% 
    mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = c(number_of_records, perc_of_records_missing_not_known),
              names_vary = "slowest") 

headers <- htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(colspan = 1, '    '),
      th(rowspan = 2, "Integration Authority Area/Health Board"),
      th(colspan = 2, '    2016/17'),
      th(colspan = 2, '    2017/18'),
      th(colspan = 2, '    2018/19'),
      th(colspan = 2, '    2019/20'),
      th(colspan = 2, '    2020/21'),
      th(colspan = 2, '    2021/22'),
      th(colspan = 2, '    2022/23'),
      th(colspan = 2, '    2023/24'),
      th(colspan = 2, '    2024/25'),
      th(colspan = 2, '    All')
    ),
    tr(
      lapply(c(" ",rep(c("Number of referrals", "% Unknown"), 10)), th)
    )
  )
))


bscols(widths = 12,
       div(style = css(width="98%", height="650px", margin="15px"),
          DT::datatable(ethnic_comp_data,
                        container = headers,
                        rownames = TRUE,
                        extensions = "FixedColumns",
              options = list(pageLength = 46,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = F, targets = 0),
                                                list(className = 'dt-right',
                                                     targets = 2:(2*length(all_years)+3)))
                             )) %>% 
            DT::formatStyle(0, target = "row",
              fontWeight = DT::styleEqual(dim(ethnic_comp_data)[1],"bold")) %>% 
               DT::formatStyle(c(1,3,5,7,9,11,13,15,17,19), `border-right` = "solid 1px")
            )
       )


```

### **Accommodation Type**

<h2 style="margin-left: 10px; margin-top: 0px; margin-bottom: 0px">Percentage of referrals with NA or code 98/99 entry (Unknown) for Accommodation Type</h2>
```{r accommodation-table}
accom_comp_data<-comp_data %>%
  filter(field_name == "accommodation_type") %>% 
  select(geog, fy, number_of_records, perc_of_records_missing_not_known) %>% 
  mutate(perc_of_records_missing_not_known = paste0(perc_of_records_missing_not_known, "%")) %>% 
   mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = c(number_of_records, perc_of_records_missing_not_known),
              names_vary = "slowest") 


bscols(widths = 12,
       div(style = css(width="98%", height="650px", margin="15px"),
          DT::datatable(accom_comp_data,
                        container = headers,
                        rownames = TRUE,
                        extensions = "FixedColumns",
              options = list(pageLength = 46,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = F, targets = 0),
                                                list(className = 'dt-right',
                                                     targets = 2:(2*length(all_years)+3)))
                             )) %>% 
            DT::formatStyle(0, target = "row",
              fontWeight = DT::styleEqual(dim(accom_comp_data)[1],"bold")) %>% 
               DT::formatStyle(c(1,3,5,7,9,11,13,15,17,19), `border-right` = "solid 1px")
            )
       )



```

### **Carer's Support**

<h2 style="margin-left: 10px; margin-top: 0px; margin-bottom: 0px">Percentage of referrals with NA or code 98/99 entry (Unknown) for Carer's Support</h2>
```{r carer-table}
carer_comp_data<-comp_data %>%
  filter(field_name == "carers_support") %>% 
  select(geog, fy, number_of_records, perc_of_records_missing_not_known) %>% 
  mutate(perc_of_records_missing_not_known = paste0(perc_of_records_missing_not_known, "%")) %>% 
   mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = c(number_of_records, perc_of_records_missing_not_known),
              names_vary = "slowest") 


bscols(widths = 12,
       div(style = css(width="98%", height="650px", margin="15px"),
          DT::datatable(carer_comp_data,
                        container = headers,
                        rownames = TRUE,
                        caption = htmltools::tags$caption(
                       style = 'caption-side: bottom; text-align: left;',
                       "Note that Carer's Support is an optional field"),
                        extensions = "FixedColumns",
              options = list(pageLength = 46,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = F, targets = 0),
                                                list(className = 'dt-right',
                                                     targets = 2:(2*length(all_years)+3)))
                             )) %>% 
            DT::formatStyle(0, target = "row",
              fontWeight = DT::styleEqual(dim(carer_comp_data)[1],"bold")) %>% 
               DT::formatStyle(c(1,3,5,7,9,11,13,15,17,19), `border-right` = "solid 1px")
            )
       )


```

### **Subtype of Dementia**

<h2 style="margin-left: 10px; margin-top: 0px; margin-bottom: 0px">Percentage of records with NA or code 98/99 entry (Unknown) and Percentage of records Yet to be determined (YTBD) for Subtype of Dementia</h2>
```{r subtype-table}
subtype_comp_data <- comp_data %>%
  filter(field_name == "subtype_of_dementia") %>% 
  select(geog, fy, number_of_records, perc_of_records_missing_not_known, perc_of_records_ytbd) %>%
  mutate(perc_of_records_missing_not_known = paste0(perc_of_records_missing_not_known, "%")) %>%
  mutate(perc_of_records_ytbd = paste0(perc_of_records_ytbd, "%")) %>%
   mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = c(number_of_records, perc_of_records_missing_not_known, perc_of_records_ytbd),
              names_vary = "slowest")
  
headers_ytbd <- htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(colspan = 1, '    '),
      th(rowspan = 2, "Integration Authority Area/Health Board/"),
      th(colspan = 3, '    2016/17'),
      th(colspan = 3, '    2017/18'),
      th(colspan = 3, '    2018/19'),
      th(colspan = 3, '    2019/20'),
      th(colspan = 3, '    2020/21'),
      th(colspan = 3, '    2021/22'),
      th(colspan = 3, '    2022/23'),
      th(colspan = 3, '    2023/24'),
      th(colspan = 3, '    2024/25'),
      th(colspan = 3, '    All')
    ),
    tr(
      lapply(c(" ",rep(c("Number of referrals", "% Unknown", "% YTBD"), 10)), th)
    )
  )
))


bscols(widths = 12,
       div(style = css(width="98%", height="650px", margin="15px"),
          DT::datatable(subtype_comp_data,
                        container = headers_ytbd,
                        rownames = TRUE,
                        caption = htmltools::tags$caption(
                       style = 'caption-side: bottom; text-align: left;',
                       "Note that Subtype of Dementia is an optional field"),
                        extensions = "FixedColumns",
              options = list(pageLength = 46,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = F, targets = 0),
                                                list(className = 'dt-right',
                                                     targets = 2:(3*length(all_years)+4)))
                             )) %>% 
            DT::formatStyle(0, target = "row",
              fontWeight = DT::styleEqual(dim(subtype_comp_data)[1],"bold")) %>% 
               DT::formatStyle(c(1,4,7,10,13,16,19,22,25,28), `border-right` = "solid 1px")
            )
       )



```

### **Clinical Impression of Stage of Illness**

<h2 style="margin-left: 10px; margin-top: 0px; margin-bottom: 0px">Percentage of records with NA or code 98/99 entry (Unknown) and Percentage of records Yet to be determined (YTBD) for Clinical Impression of Stage of Illness</h2>

```{r stage-table}
stage_comp_data <- comp_data %>%
  filter(field_name == "clinical_impression_of_stage_of_illness") %>% 
  select(geog, fy, number_of_records, perc_of_records_missing_not_known, perc_of_records_ytbd) %>%
  mutate(perc_of_records_missing_not_known = paste0(perc_of_records_missing_not_known, "%")) %>%
  mutate(perc_of_records_ytbd = paste0(perc_of_records_ytbd, "%")) %>%
   mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = c(number_of_records, perc_of_records_missing_not_known, perc_of_records_ytbd),
              names_vary = "slowest")
  

bscols(widths = 12,
       div(style = css(width="98%", height="650px", margin="15px"),
          DT::datatable(stage_comp_data,
                        container = headers_ytbd,
                        rownames = TRUE,
                       # caption = htmltools::tags$caption(
                      # style = 'caption-side: bottom; text-align: left;',
                      # "Note that Subtype of Dementia is an optional field"),
                        extensions = "FixedColumns",
              options = list(pageLength = 46,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = F, targets = 0),
                                                list(className = 'dt-right',
                                                     targets = 2:(3*length(all_years)+4)))
                             )) %>% 
            DT::formatStyle(0, target = "row",
              fontWeight = DT::styleEqual(dim(stage_comp_data)[1],"bold")) %>% 
               DT::formatStyle(c(1,4,7,10,13,16,19,22,25,28), `border-right` = "solid 1px")
            )
       )

```

### **Model of Care**

<h2 style="margin-left: 10px; margin-top: 0px; margin-bottom: 0px">Percentage of referrals with NA or code 98/99 entry (Unknown) and Percentage of records Yet to be determined (YTBD) for Model of Care</h2>
```{r model-table}
model_comp_data <- comp_data %>%
  filter(field_name == "model_of_care") %>% 
  select(geog, fy, number_of_records, perc_of_records_missing_not_known, perc_of_records_ytbd) %>%
  mutate(perc_of_records_missing_not_known = paste0(perc_of_records_missing_not_known, "%")) %>%
  mutate(perc_of_records_ytbd = paste0(perc_of_records_ytbd, "%")) %>%
   mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = c(number_of_records, perc_of_records_missing_not_known, perc_of_records_ytbd),
              names_vary = "slowest")
  

bscols(widths = 12,
       div(style = css(width="98%", height="650px", margin="15px"),
          DT::datatable(model_comp_data,
                        container = headers_ytbd,
                        rownames = TRUE,
                       # caption = htmltools::tags$caption(
                       #style = 'caption-side: bottom; text-align: left;',
                      # "Note that Subtype of Dementia is an optional field"),
                        extensions = "FixedColumns",
              options = list(pageLength = 46,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = F, targets = 0),
                                                list(className = 'dt-right',
                                                     targets = 2:(3*length(all_years)+4)))
                             )) %>% 
            DT::formatStyle(0, target = "row",
              fontWeight = DT::styleEqual(dim(model_comp_data)[1],"bold")) %>% 
               DT::formatStyle(c(1,4,7,10,13,16,19,22,25,28), `border-right` = "solid 1px")
            )
       )

```

```{js }

function filter_default() {

// pathways

  document.getElementById("met_filter_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("met_filter_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("not_met_filter_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("not_met_filter_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("ongoing_filter_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("ongoing_filter_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("exempt_filter_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("exempt_filter_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");

  document.getElementById("wait_filter_ijb_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("wait_filter_ijb_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("wait_filter_hb_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("wait_filter_hb_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("no_contact_filter_year_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("no_contact_filter_year_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("no_contact_filter_year_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("no_contact_filter_year_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("term_filter_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("term_filter_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("term_filter_geog").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("term_filter_geog").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("term_filter_year_2").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("term_filter_year_2").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("term_filter_geog_2").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("term_filter_geog_2").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  
// demographics

    document.getElementById("trend_filter_age_prop_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_age_prop_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("trend_filter_age_prop_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_age_prop_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_trend_age_2_pop").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("filter_trend_age_2_pop").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_pop_age_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_pop_age_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("filter_pop_age_hb_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("NHS Greater Glasgow & Clyde", false);

  document.getElementById("filter_pop_age_hb_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("filter_ldp_age_2").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("filter_ldp_age_2").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_sex_prop_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_sex_prop_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_sex_prop_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_sex_prop_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_trend_sex_pop").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("filter_trend_sex_pop").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("filter_hb_sex_pop").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_hb_sex_pop").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
    document.getElementById("filter_ijb_sex_pop").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_ijb_sex_pop").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_ldp_sex").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("filter_ldp_sex").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("trend_filter_simd_prop_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_simd_prop_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("trend_filter_simd_prop_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_simd_prop_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_trend_simd_pop").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("filter_trend_simd_pop").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("filter_hb_simd_pop").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_hb_simd_pop").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_ijb_simd_pop").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_ijb_simd_pop").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
    document.getElementById("filter_ijb_simd_pop_quintile").getElementsByClassName("selectized") 
  [0].selectize.setValue("All", false);

  document.getElementById("filter_ijb_simd_pop_quintile").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_ldp_simd").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("filter_ldp_simd").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_hb_simd_ldp").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_hb_simd_ldp").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
    document.getElementById("filter_hb_simd_ldp_quintile").getElementsByClassName("selectized") 
  [0].selectize.setValue("All", false);

  document.getElementById("filter_hb_simd_ldp_quintile").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
    document.getElementById("filter_ijb_simd_ldp").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_ijb_simd_ldp").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("filter_ldp_simd_bar").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("filter_ldp_simd_bar").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  
  
// all referrals - trends and rates  
  
    document.getElementById("trend_filter_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue("NHS Ayrshire & Arran", false);

  document.getElementById("trend_filter_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("trend_filter_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("Aberdeen City", false);

  document.getElementById("trend_filter_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
 
   document.getElementById("trend_filter_pop").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("trend_filter_pop").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("trend_filter_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue("NHS Ayrshire & Arran", false);

  document.getElementById("trend_filter_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("trend_filter_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("Aberdeen City", false);

  document.getElementById("trend_filter_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
 
   document.getElementById("trend_filter_pop").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("trend_filter_pop").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("trend_filter_year_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_year_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("trend_filter_year_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_year_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("trend_filter_outcomes_exp").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("trend_filter_outcomes_exp").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
    document.getElementById("trend_filter_outcomes_met").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("trend_filter_outcomes_met").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  
// additional information  

   
  document.getElementById("trend_filter_subtype_prop_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_subtype_prop_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("trend_filter_subtype_prop_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_subtype_prop_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("filter_ldp_subtype").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("filter_ldp_subtype").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("trend_filter_stage_prop_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_stage_prop_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("trend_filter_stage_prop_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_stage_prop_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_ldp_stage").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("filter_ldp_stage").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("trend_filter_model_prop_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_model_prop_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("trend_filter_model_prop_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_model_prop_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_ldp_model").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("filter_ldp_model").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
    document.getElementById("filter_carer_hb_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_carer_hb_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("filter_carer_ijb_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_carer_ijb_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_uptake_hb_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_uptake_hb_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("filter_uptake_ijb_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_uptake_ijb_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  }
  
  window.onload = filter_default;

```

<!-- END OF SCRIPT -->