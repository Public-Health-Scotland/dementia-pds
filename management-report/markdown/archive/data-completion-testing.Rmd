---
title: "DATA COMPLETION TESTING"
output: 
  flexdashboard::flex_dashboard:
    logo: phs-logo.png
    orientation: rows
    vertical_layout: scroll
---

```{r load-setup, include=FALSE}
source(here::here("code", "00_setup-environment.R"))
library(crosstalk) # for drop down menus
library(phsstyles)
library(htmltools)

# Write numbers with thousands separator
knit_hooks$set(inline = function(x){
  if(!is.character(x)){prettyNum(x, big.mark=",")}else{x}
})
```

---
date: "`r paste('Data as at', format(end_date, '%d %B %Y'))`"
---

```{r setup, include=FALSE}

# Remove tidylog
detach("package:tidylog", unload = TRUE)

# Load functions
walk(dir(here::here("functions"), full.names = TRUE), source)


# Load PDS data
pds <- read_rds(get_mi_data_path("final_data", ext = "rds", test_output = test_output)) %>% 
  
  # Remove codes from board and IJB
  mutate(health_board = str_sub(health_board, 3, -1),
         ijb          = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))

# Load expected diagnoses reference file
exp <- read_csv(get_exp_diagnoses_path())


# Load error summary
err <- read_rds(get_mi_data_path("error_data", ext = "rds", test_output = test_output)) %>% 

  mutate(ijb = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))

# calculate referrals for Scotland and health boards
pds_ijb <- pds %>% arrange(ijb)

pds_ijb %<>% rename(geog = ijb) 

pds_ijb$geog<- factor(pds_ijb$geog, levels = unique(pds_ijb$geog))

pds_scot <- pds %>% group_by(health_board = "Scotland", ijb = "Scotland", fy, month, ldp_full, ldp, age_grp_2, age_grp, simd, sex) %>%  summarise(referrals = sum(referrals), .groups = "drop")

pds_scot %<>% rename(geog = ijb) 

pds_scot$geog<- factor(pds_scot$geog, levels = unique(pds_scot$geog))

pds_hb <- pds %>% group_by(health_board, fy, month, ldp_full, ldp, age_grp_2, age_grp, simd, sex) %>% 
  summarise(referrals = sum(referrals), .groups = "drop") %>% mutate(ijb = health_board, .before = fy)

pds_hb %<>% rename(geog = ijb) 

pds_hb$geog<- factor(pds_hb$geog, levels = unique(pds_hb$geog))

# combine data for ijb, hb and Scotland
pds_all <- bind_rows(pds_scot, pds_ijb, pds_hb)

pds_all$geog<- factor(pds_all$geog, levels = unique(pds_all$geog))

#get totals for all geogs, hbs, ijbs, scotland
pds_all_totals <- pds_all %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_ijb_totals <- pds_ijb %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_hb_totals <- pds_hb %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_scot_totals <- pds_scot %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))


#get totals for all geogs, hbs, ijbs, scotland with LARGE AGE GROUPS
pds_all_totals_2 <- bind_rows(pds_all_totals,
  pds_all %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_all_totals_2$age_grp_2<- factor(pds_all_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))

pds_ijb_totals_2 <- bind_rows(pds_ijb_totals,
    pds_ijb %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_ijb_totals_2$age_grp_2<- factor(pds_ijb_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))


pds_hb_totals_2 <- bind_rows(pds_hb_totals,
    pds_hb %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_hb_totals_2$age_grp_2<- factor(pds_hb_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))


pds_scot_totals_2 <- bind_rows(pds_scot_totals,
    pds_scot %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_scot_totals_2$age_grp_2<- factor(pds_scot_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))

#load population rates data
pop_data <- read_rds("//conf/dementia/A&I/Outputs/management-report/lookups/pop_data.rds")

#create year lists
provisional_year <- paste0(as.numeric(substr(last(finalised_years),1,4)) + 1,
                           "/", as.numeric(substr(last(finalised_years),6,7)) + 1)

current_fy <- paste0(substr(fy,1,4),
                           "/", as.numeric(substr(fy,3,4)) + 1)

last_full_year <- if_else(qt == 4, current_fy, paste0(as.numeric(substr(fy,1,4)) - 1,
                           "/", as.numeric(substr(fy,3,4))))

all_years <- unique(pds_all$fy)

if(qt == 4){full_years = all_years}else{full_years = all_years[-length(all_years)]}

#load completion data
comp_data <- read_rds(get_mi_data_path("comp_data", ext = "rds", test_output = test_output))


```

Data Completion {data-navmenu="Data Quality"}
=================================================

Row
-------------------------------------------------

### <!-- No Title -->

This page includes information about data quality. Any queries/errors outstanding following the resubmission deadline will be included in analytical outputs such as these management reports and annual publication. Therefore, the better quality of data submitted, the more accurate these figures will be.

Row {.tabset data-height=765}
-------------------------------------------------

### **Accommodation Type**

<h2 style="margin-left: 10px; margin-top: 0px; margin-bottom: 0px">Percentage of referrals with NA or code 98/99 entry (Unknown) for Accommodation Type</h2>
```{r accommodation-table}
accom_comp_data<-comp_data %>%
  filter(field_name == "accommodation_type") %>% 
  select(geog, fy, number_of_records, perc_of_records_missing_not_known) %>% 
  mutate(perc_of_records_missing_not_known = paste0(perc_of_records_missing_not_known, "%")) %>% 
   mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = c(number_of_records, perc_of_records_missing_not_known),
              names_vary = "slowest") 


headers <- htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(colspan = 1, ' '),
      th(rowspan = 2, "Integration Authority Area/Health Board"),
      lapply(all_years, th, colspan = 2, style = css(textAlign="center")),
      th(colspan = 2, 'All', style = css(textAlign="center"))
    ),
    tr(
      lapply(c(" ",rep(c("Number of referrals", "% Unknown"), 10)), th)
    )
  )
))


bscols(widths = 12,
       div(style = css(width="98%", height="650px", margin="15px"),
          DT::datatable(accom_comp_data,
                        container = headers,
                        rownames = TRUE,
                        extensions = "FixedColumns",
              options = list(pageLength = 46,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = F, targets = 0),
                                                list(className = 'dt-right',
                                                     targets = 2:(2*length(all_years)+3)))
                             )) %>% 
            DT::formatStyle(0, target = "row",
              fontWeight = DT::styleEqual(dim(accom_comp_data)[1],"bold")) %>% 
               DT::formatStyle(c(1,3,5,7,9,11,13,15,17,19), `border-right` = "solid 1px")
            )
       )



```

### **Carer's Support**

<h2 style="margin-left: 10px; margin-top: 0px; margin-bottom: 0px">Percentage of referrals with NA or code 98/99 entry (Unknown) for Carer's Support</h2>
```{r carer-table}
carer_comp_data<-comp_data %>%
  filter(field_name == "carers_support") %>% 
  select(geog, fy, number_of_records, perc_of_records_missing_not_known) %>% 
  mutate(perc_of_records_missing_not_known = paste0(perc_of_records_missing_not_known, "%")) %>% 
   mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = c(number_of_records, perc_of_records_missing_not_known),
              names_vary = "slowest") 


bscols(widths = 12,
       div(style = css(width="98%", height="650px", margin="15px"),
          DT::datatable(carer_comp_data,
                        container = headers,
                        rownames = TRUE,
                        caption = htmltools::tags$caption(
                       style = 'caption-side: bottom; text-align: left;',
                       "Note that Carer's Support is an optional field"),
                        extensions = "FixedColumns",
              options = list(pageLength = 46,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = F, targets = 0),
                                                list(className = 'dt-right',
                                                     targets = 2:(2*length(all_years)+3)))
                             )) %>% 
            DT::formatStyle(0, target = "row",
              fontWeight = DT::styleEqual(dim(carer_comp_data)[1],"bold")) %>% 
               DT::formatStyle(c(1,3,5,7,9,11,13,15,17,19), `border-right` = "solid 1px")
            )
       )


```

### **Subtype of Dementia**

<h2 style="margin-left: 10px; margin-top: 0px; margin-bottom: 0px">Percentage of records with NA or code 98/99 entry (Unknown) and Percentage of records Yet to be determined (YTBD) for Subtype of Dementia</h2>
```{r subtype-table}
subtype_comp_data <- comp_data %>%
  filter(field_name == "subtype_of_dementia") %>% 
  select(geog, fy, number_of_records, perc_of_records_missing_not_known, perc_of_records_ytbd) %>%
  mutate(perc_of_records_missing_not_known = paste0(perc_of_records_missing_not_known, "%")) %>%
  mutate(perc_of_records_ytbd = paste0(perc_of_records_ytbd, "%")) %>%
   mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = c(number_of_records, perc_of_records_missing_not_known, perc_of_records_ytbd),
              names_vary = "slowest")
  
headers_ytbd <- htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
     th(colspan = 1, ' '),
      th(rowspan = 2, "Integration Authority Area/Health Board"),
      lapply(all_years, th, colspan = 3, style = css(textAlign="center")),
      th(colspan = 3, 'All', style = css(textAlign="center"))
    ),
    tr(
      lapply(c(" ",rep(c("Number of referrals", "% Unknown", "% YTBD"), 10)), th)
    )
  )
))


bscols(widths = 12,
       div(style = css(width="98%", height="650px", margin="15px"),
          DT::datatable(subtype_comp_data,
                        container = headers_ytbd,
                        rownames = TRUE,
                        caption = htmltools::tags$caption(
                       style = 'caption-side: bottom; text-align: left;',
                       "Note that Subtype of Dementia is an optional field"),
                        extensions = "FixedColumns",
              options = list(pageLength = 46,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = F, targets = 0),
                                                list(className = 'dt-right',
                                                     targets = 2:(3*length(all_years)+4)))
                             )) %>% 
            DT::formatStyle(0, target = "row",
              fontWeight = DT::styleEqual(dim(subtype_comp_data)[1],"bold")) %>% 
               DT::formatStyle(c(1,4,7,10,13,16,19,22,25,28), `border-right` = "solid 1px")
            )
       )



```

### **Clinical Impression of Stage of Illness**

<h2 style="margin-left: 10px; margin-top: 0px; margin-bottom: 0px">Percentage of records with NA or code 98/99 entry (Unknown) and Percentage of records Yet to be determined (YTBD) for Clinical Impression of Stage of Illness</h2>

```{r stage-table}
stage_comp_data <- comp_data %>%
  filter(field_name == "clinical_impression_of_stage_of_illness") %>% 
  select(geog, fy, number_of_records, perc_of_records_missing_not_known, perc_of_records_ytbd) %>%
  mutate(perc_of_records_missing_not_known = paste0(perc_of_records_missing_not_known, "%")) %>%
  mutate(perc_of_records_ytbd = paste0(perc_of_records_ytbd, "%")) %>%
   mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = c(number_of_records, perc_of_records_missing_not_known, perc_of_records_ytbd),
              names_vary = "slowest")
  

bscols(widths = 12,
       div(style = css(width="98%", height="650px", margin="15px"),
          DT::datatable(stage_comp_data,
                        container = headers_ytbd,
                        rownames = TRUE,
                       # caption = htmltools::tags$caption(
                      # style = 'caption-side: bottom; text-align: left;',
                      # "Note that Subtype of Dementia is an optional field"),
                        extensions = "FixedColumns",
              options = list(pageLength = 46,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = F, targets = 0),
                                                list(className = 'dt-right',
                                                     targets = 2:(3*length(all_years)+4)))
                             )) %>% 
            DT::formatStyle(0, target = "row",
              fontWeight = DT::styleEqual(dim(stage_comp_data)[1],"bold")) %>% 
               DT::formatStyle(c(1,4,7,10,13,16,19,22,25,28), `border-right` = "solid 1px")
            )
       )

```

### **Model of Care**

<h2 style="margin-left: 10px; margin-top: 0px; margin-bottom: 0px">Percentage of referrals with NA or code 98/99 entry (Unknown) and Percentage of records Yet to be determined (YTBD) for Model of Care</h2>
```{r model-table}
model_comp_data <- comp_data %>%
  filter(field_name == "model_of_care") %>% 
  select(geog, fy, number_of_records, perc_of_records_missing_not_known, perc_of_records_ytbd) %>%
  mutate(perc_of_records_missing_not_known = paste0(perc_of_records_missing_not_known, "%")) %>%
  mutate(perc_of_records_ytbd = paste0(perc_of_records_ytbd, "%")) %>%
   mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = c(number_of_records, perc_of_records_missing_not_known, perc_of_records_ytbd),
              names_vary = "slowest")
  

bscols(widths = 12,
       div(style = css(width="98%", height="650px", margin="15px"),
          DT::datatable(model_comp_data,
                        container = headers_ytbd,
                        rownames = TRUE,
                       # caption = htmltools::tags$caption(
                       #style = 'caption-side: bottom; text-align: left;',
                      # "Note that Subtype of Dementia is an optional field"),
                        extensions = "FixedColumns",
              options = list(pageLength = 46,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = F, targets = 0),
                                                list(className = 'dt-right',
                                                     targets = 2:(3*length(all_years)+4)))
                             )) %>% 
            DT::formatStyle(0, target = "row",
              fontWeight = DT::styleEqual(dim(model_comp_data)[1],"bold")) %>% 
               DT::formatStyle(c(1,4,7,10,13,16,19,22,25,28), `border-right` = "solid 1px")
            )
       )

```