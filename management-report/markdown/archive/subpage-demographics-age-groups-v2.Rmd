---
title: "DEMOGRAPHICS DRAFT"
output: 
  flexdashboard::flex_dashboard:
    logo: phs-logo.png
    orientation: rows
    vertical_layout: scroll
---

```{r load-setup, include=FALSE}
source(here::here("code", "00_setup-environment.R"))
library(crosstalk) # for drop down menus
library(phsstyles)
library(htmltools)

# Write numbers with thousands separator
knit_hooks$set(inline = function(x){
  if(!is.character(x)){prettyNum(x, big.mark=",")}else{x}
})
```

---
date: "`r paste('Data as at', format(end_date, '%d %B %Y'))`"
---

```{r setup, include=FALSE}

# Load functions
walk(dir(here::here("functions"), full.names = TRUE), source)


# Load PDS data
pds <- read_rds(get_mi_data_path("final_data", ext = "rds", test_output = test_output)) %>% 
  
  # Remove codes from board and IJB
  mutate(health_board = str_sub(health_board, 3, -1),
         ijb          = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))

# Load expected diagnoses reference file
exp <- read_csv(get_exp_diagnoses_path())


# Load error summary
err <- read_rds(get_mi_data_path("error_data", ext = "rds", test_output = test_output)) %>% 

  mutate(ijb = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))

# calculate referrals for Scotland and health boards
pds_ijb <- pds %>% arrange(ijb)

pds_ijb %<>% rename(geog = ijb) 

pds_ijb$geog<- factor(pds_ijb$geog, levels = unique(pds_ijb$geog))

pds_scot <- pds %>% group_by(health_board = "Scotland", ijb = "Scotland", fy, month, ldp_full, ldp, age_grp_2, age_grp, simd, sex) %>%  summarise(referrals = sum(referrals), .groups = "drop")

pds_scot %<>% rename(geog = ijb) 

pds_scot$geog<- factor(pds_scot$geog, levels = unique(pds_scot$geog))

pds_hb <- pds %>% group_by(health_board, fy, month, ldp_full, ldp, age_grp_2, age_grp, simd, sex) %>% 
  summarise(referrals = sum(referrals), .groups = "drop") %>% mutate(ijb = health_board, .before = fy)

pds_hb %<>% rename(geog = ijb) 

pds_hb$geog<- factor(pds_hb$geog, levels = unique(pds_hb$geog))

# combine data for ijb, hb and Scotland
pds_all <- bind_rows(pds_scot, pds_ijb, pds_hb)

pds_all$geog<- factor(pds_all$geog, levels = unique(pds_all$geog))

#get totals for all geogs, hbs, ijbs, scotland
pds_all_totals <- pds_all %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_ijb_totals <- pds_ijb %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_hb_totals <- pds_hb %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_scot_totals <- pds_scot %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))


#get totals for all geogs, hbs, ijbs, scotland with LARGE AGE GROUPS
pds_all_totals_2 <- bind_rows(pds_all_totals,
  pds_all %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_all_totals_2$age_grp_2<- factor(pds_all_totals_2$age_grp_2, levels = c("All", "85+", "75 to 84" ,"74 and Under"))

pds_ijb_totals_2 <- bind_rows(pds_ijb_totals,
    pds_ijb %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_ijb_totals_2$age_grp_2<- factor(pds_ijb_totals_2$age_grp_2, levels = c("All", "85+", "75 to 84" ,"74 and Under"))


pds_hb_totals_2 <- bind_rows(pds_hb_totals,
    pds_hb %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_hb_totals_2$age_grp_2<- factor(pds_hb_totals_2$age_grp_2, levels = c("All", "85+", "75 to 84" ,"74 and Under"))


pds_scot_totals_2 <- bind_rows(pds_scot_totals,
    pds_scot %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_scot_totals_2$age_grp_2<- factor(pds_scot_totals_2$age_grp_2, levels = c("All", "85+", "75 to 84" ,"74 and Under"))

#load population rates data
pop_data <- read_rds("//conf/dementia/A&I/Outputs/management-report/lookups/pop_data.rds")

#create year lists
provisional_year <- paste0(as.numeric(substr(last(finalised_years),1,4)) + 1,
                           "/", as.numeric(substr(last(finalised_years),6,7)) + 1)

current_fy <- paste0(substr(fy,1,4),
                           "/", as.numeric(substr(fy,3,4)) + 1)

last_full_year <- if_else(qt == 4, current_fy, paste0(as.numeric(substr(fy,1,4)) - 1,
                           "/", as.numeric(substr(fy,3,4))))

all_years <- unique(pds_all$fy)

if(qt == 4){full_years = all_years}else{full_years = all_years[-length(all_years)]}


```
<!-- delete all of above when finished testing -->


```{r data-setup-demo, include=FALSE}

#prepare age data 
ldp_all_age <- pds_all %>%
  filter(fy %in% full_years, age_grp_2 != "Unknown") %>%
  group_by(geog, fy, age_grp_2, ldp) %>%
  summarise(total_referrals = sum(referrals), .groups = "drop") %>% 
  pivot_wider(names_from = ldp, values_from = total_referrals, values_fill = 0) %>% 
  mutate(perc_met = round((complete + exempt)/(complete + exempt + fail)*100,1)) %>% 
complete(nesting(geog, fy), age_grp_2, fill = list(perc_met = NA))

ldp_all_age <- left_join(ldp_all_age,
ldp_all_age %>% filter(geog == "Scotland") %>% select(fy, age_grp_2, perc_met) %>% 
  rename(scot_perc_met = perc_met))

ldp_all_age$age_grp_2<- factor(ldp_all_age$age_grp_2, levels = c("85+", "75 to 84" ,"74 and Under"))

pds_all_age <- pds_all %>% filter(age_grp_2 != "Unknown") #remove 6 unknowns from 2016/17 (add note to charts and tables?)

pds_all_age %<>% group_by(fy, geog, age_grp_2) %>%
  summarise(total_referrals = sum(referrals), .groups = "drop")

pds_all_age$age_grp_2<- factor(pds_all_age$age_grp_2, levels = c("85+", "75 to 84" ,"74 and Under"))

#prepare population rate data 

pop_data_age <- pop_data %>% filter(sex == "All", age_grp == "All") %>% select(-sex, -age_grp)

pds_all_age_cal_year <- pds_all_age %>%
  mutate(year = as.numeric(substr(fy, 1, 4)))

pds_all_age_rates <- left_join(pds_all_age_cal_year, pop_data_age) %>% select(-year) %>%
  mutate(pop_rate_10000 = round((total_referrals/pop_est)*10000, 1)) %>% select(fy, geog, age_grp_2, pop_rate_10000)

pds_all_age_rates$geog<- factor(pds_all_age_rates$geog, levels = unique(pds_all_age_rates$geog)) 
pds_all_age_rates$age_grp_2<- factor(pds_all_age_rates$age_grp_2, levels = c("85+", "75 to 84" ,"74 and Under"))

pds_all_age_rates %<>% complete(nesting(fy, geog), age_grp_2, fill = list(pop_rate_10000 = 0)) 

pds_age_rates_2_data <- left_join(pds_all_age_rates,
pds_all_age_rates %>% filter(geog == "Scotland") %>% select(fy, age_grp_2, pop_rate_10000) %>% rename(scot_pop_rate_10000 = pop_rate_10000))

#prepare gender data

ldp_all_sex <- pds_all %>%
  filter(fy %in% full_years, sex != "98 Not Specified", sex != "99 Not Known", sex != "Unknown") %>% #need note about how many unknowns have been removed
  group_by(geog, fy, sex, ldp) %>%
  summarise(total_referrals = sum(referrals), .groups = "drop") %>% 
  pivot_wider(names_from = ldp, values_from = total_referrals, values_fill = 0) %>% 
  mutate(perc_met = round((complete + exempt)/(complete + exempt + fail)*100,1)) %>% 
complete(nesting(geog, fy), sex, fill = list(perc_met = NA))

ldp_all_sex <- left_join(ldp_all_sex,
ldp_all_sex %>% filter(geog == "Scotland") %>% select(fy, sex, perc_met) %>% 
  rename(scot_perc_met = perc_met)) %>% mutate(sex = substring(sex, 4))

ldp_all_sex$sex<- factor(ldp_all_sex$sex, levels = c("Male", "Female"))

pds_all_sex <- pds_all %>% group_by(geog, fy, sex) %>% filter(sex != "98 Not Specified", sex != "99 Not Known", sex != "Unknown") %>% 
  summarise(total_referrals = sum(referrals), .groups = "drop") %>% 
complete(nesting(geog, fy), sex, fill = list(total_referrals = 0)) %>% mutate(sex = substring(sex, 4))

pds_all_sex$sex<- factor(pds_all_sex$sex, levels = c("Male", "Female"))

#prepare population rate data for gender

pop_data_sex <- pop_data %>% filter(age_grp != "All", age_grp != "59 and Under", age_grp != "60 to 64", age_grp_2 == "All", sex != "All") %>% select(-age_grp_2) %>% mutate(sex = substring(sex, 4)) %>% 
  group_by(geog, year, sex) %>% summarise(pop_est = sum(pop_est)) %>% ungroup()

pds_all_sex_cal_year <- pds_all_sex %>% 
  mutate(year = as.numeric(substr(fy, 1, 4)))

pds_all_sex_rates <- left_join(pds_all_sex_cal_year, pop_data_sex) %>% select(-year) %>%
  mutate(pop_rate_10000 = round((total_referrals/pop_est)*10000, 1))

pds_all_sex_rates$geog <- factor(pds_all_sex_rates$geog, levels = unique(pds_all_sex_rates$geog))
pds_all_sex_rates$sex <- as.factor(pds_all_sex_rates$sex)

pds_all_sex_rates %<>% complete(nesting(geog, fy), sex, fill = list(pop_est = NA, pop_rate_10000 = NA)) 

pds_all_sex_rates <- left_join(pds_all_sex_rates,
pds_all_sex_rates %>% filter(geog == "Scotland") %>% select(fy, sex, pop_rate_10000) %>% rename(scot_pop_rate_10000 = pop_rate_10000))

pds_all_sex_rates$sex<- factor(pds_all_sex_rates$sex, levels = c("Male", "Female"))


#prepare simd data
ldp_all_simd <- pds_all %>%
  filter(fy %in% full_years, simd != "Unknown") %>%
  group_by(geog, fy, simd, ldp) %>%
  summarise(total_referrals = sum(referrals), .groups = "drop") %>% 
  pivot_wider(names_from = ldp, values_from = total_referrals, values_fill = 0) %>% 
  mutate(perc_met = round((complete + exempt)/(complete + exempt + fail)*100,1)) %>% 
complete(nesting(geog, fy), simd, fill = list(perc_met = NA))

ldp_all_simd <- left_join(ldp_all_simd,
ldp_all_simd %>% filter(geog == "Scotland") %>% select(fy, simd, perc_met) %>% 
  rename(scot_perc_met = perc_met))

pds_all_simd <- pds_all %>% group_by(geog, fy, simd) %>% filter(simd != "Unknown") %>% 
  summarise(total_referrals = sum(referrals), .groups = "drop") %>% 
complete(nesting(geog, fy), simd, fill = list(total_referrals = 0))


#prepare population rate data for simd
simd_pop_data <- read_rds("//conf/dementia/A&I/Outputs/management-report/lookups/simd_pop_data.rds")

pop_data_simd <- simd_pop_data %>% filter(age_grp != "All", age_grp != "59 and Under", age_grp != "60 to 64", age_grp_2 == "All", sex != "All") %>% select(-age_grp_2, -sex) %>% 
  group_by(geog, year, simd) %>% summarise(pop = sum(pop)) %>% ungroup()

pds_all_simd_cal_year <- pds_all_simd %>% 
  mutate(year = as.numeric(substr(fy, 1, 4)))

pds_all_simd_rates <- left_join(pds_all_simd_cal_year, pop_data_simd) %>% select(-year) %>%
  mutate(pop_rate_10000 = round((total_referrals/pop)*10000, 1))

pds_all_simd_rates$geog <- factor(pds_all_simd_rates$geog, levels = unique(pds_all_simd_rates$geog))

pds_all_simd_rates$simd <- as.factor(pds_all_simd_rates$simd)

pds_all_simd_rates %<>% complete(nesting(geog, fy), simd, fill = list(pop = NA, pop_rate_10000 = NA)) 

pds_all_simd_rates <- left_join(pds_all_simd_rates,
pds_all_simd_rates %>% filter(geog == "Scotland") %>% select(fy, simd, pop_rate_10000) %>% rename(scot_pop_rate_10000 = pop_rate_10000))

#legend tibble
legend_data <- tibble(
  geog = c("Selected Health Board/Integration Authority Area", "Scotland"),
  x = c(1,2),
  y = c(0,0))

legend_data$geog <- factor(legend_data$geog, levels = unique(legend_data$geog))

# total referrals for tables
hb_totals_table <- bind_rows(pds_scot_totals, pds_hb_totals) %>%
  mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% pivot_wider(names_from = geog, values_from = total_referrals)

ijb_totals_table <- bind_rows(pds_scot_totals, pds_ijb_totals)  %>%
  mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% pivot_wider(names_from = geog, values_from = total_referrals)
   
# colours for simd plots
simd_colours <- c("#005FAD", "#0078D4", "#3393DD", "#80BCEA", "#B3D7F2")#, "#E6F2FB")

# colours for age plots
age_colours <- c("#1E7F84", "#4B999D", "#8FBFC2")
 
```

Age Groups {data-navmenu="Demographics"}
=================================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Age Groups - Rates per 10,000 population 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***
<ul>
  <li>[**Rates per 10,000 population**](#age-groups)</li>
  <li>[Outcomes](#age-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**-**

<!-- **Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.** -->


Row {.tabset data-height=1110}
----------------------------------------------------------------------

### **Integration Authority Areas**

```{r dropdown-ijb-age-pop}
pds_ijb_age_rates <- #bind_rows(
  
  #pds_all_age_rates %>% filter(!grepl("NHS", geog)) %>% 
         #  mutate(age_grp_2_group = age, .before = age_grp_2) %>% 
 # mutate(key = paste0(fy,age_grp_2_group,geog), .before = geog),
  
   pds_all_age_rates %>% filter(!grepl("NHS", geog)) %>% 
         mutate(age_grp_2_group = "All", .before = age_grp_2)  %>% 
  mutate(key = paste0(fy,age_grp_2_group,geog), .before = geog)
#)

pds_pop_age_data_ijb <- SharedData$new(pds_ijb_age_rates, key = ~key, group = "ijb_age_pop")

data_filter_ijb_age_pop <- filter_select(id = "filter_ijb_age_pop",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = pds_pop_age_data_ijb,
                                    multiple = FALSE
                                      )

# data_filter_ijb_age_pop_quintile <- filter_select(id = "filter_ijb_age_pop_quintile",
#                                     label = "Select Age Group:",
#                                     group = ~age_grp_2_group,
#                                     sharedData = pds_pop_age_data_ijb,
#                                     multiple = FALSE
#                                       )

data_filter_ijb_age_pop_geog <- filter_select(id = "filter_ijb_age_pop_geog",
                                    label = "Select Integration Authority Area(s):",
                                    group = ~geog,
                                    sharedData = pds_pop_age_data_ijb,
                                    multiple = TRUE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_ijb_age_pop,
       NULL)

bscols(widths = c(1,10,NA), NULL, data_filter_ijb_age_pop_geog, NULL)
```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Number of people referred to PDS per 10,000 population by Age Group and Integration Authority Area</h2>
```{r plot-ijb-age-legend-pop2}

bscols(widths = 12,
div(style=css(marginBottom="-20px",height="65px"), plot_geog_bar_legend(pds_all_age %>% filter(geog == "Scotland"), measure = age_grp_2, colours = age_colours)))

```


```{r plot-ijb-age-pop2}

bscols(widths = 12,
  div(style = css(width="98%", height="355px", marginBottom="-20px"),
plot_ly(pds_pop_age_data_ijb, x = ~geog, y = ~pop_rate_10000, meta = ~fy, hovertext = ~age_grp_2, type = 'bar', color = ~age_grp_2, colors = age_colours, 
        hovertemplate = paste0("%{x} <br>", "%{meta} <br>", "Age Group: %{hovertext} <br>",
                            "Rate per 10,000 Population: %{y}<extra></extra>")) %>% 
  layout(clickmode = "none", showlegend = FALSE, margin = list(l = -5, b = 10, t = 40),
         xaxis = list(title = "Integration Authority Area", showline = FALSE, linecolor = "#b3b3b3",
                      categoryorder = "trace", tickangle = -45, titlefont = list(size = 16)),
         yaxis = list(title = "Rate per 10,000 Population", linecolor = "#b3b3b3", titlefont = list(size = 16))
      ) %>%
  config(displayModeBar = TRUE, doubleClick = F,
         modeBarButtonsToRemove = list('select2d', 'lasso2d', 'zoomIn2d', 
                                       'zoomOut2d', 'autoScale2d', 
                                       'toggleSpikelines', 
                                       'hoverCompareCartesian', 
                                       'hoverClosestCartesian', 'toImage'), 
         displaylogo = F, editable = F)
  )
)

```


```{r table-ijb-age-pop}

ijb_pop_age_table_data <- #bind_rows(
  
  # pds_all_age_rates %>%
  # filter(!grepl("NHS", geog)) %>%
  # select(geog,fy,age_grp_2,pop_rate_10000) %>%
  #  mutate(age_grp_2_group = age_grp_2, .before = age_grp_2),

  pds_all_age_rates %>%
  filter(!grepl("NHS", geog)) %>%
  select(geog,fy,age_grp_2,pop_rate_10000) %>%
   mutate(age_grp_2_group = "All", .before = age_grp_2
          ) %>% 
  
     mutate(pop_rate_10000 = as.character(pop_rate_10000)) %>%
  arrange(age_grp_2) %>% 
  pivot_wider(names_from = age_grp_2, values_from = pop_rate_10000) %>%
  mutate(key = paste0(fy,age_grp_2_group,geog), .before = geog) %>% 
  mutate(across(everything(), ~if_else(age_grp_2_group == "All", 
                                       replace_na(.x, "-"), 
                                       replace_na(.x, " ")))) %>%
             rename(`Integration Authority Area` = geog) 


ijb_age_table_pop <- SharedData$new(ijb_pop_age_table_data, key = ~key, group = "ijb_age_pop")


bscols(widths = 12,
       div(style = css(width="97%", height="420px", margin="20px"),
DT::datatable(ijb_age_table_pop, rownames = FALSE, selection = 'none',
              options = list(pageLength = 33,
                             scrollX = TRUE,
                            # fixedColumns = list(leftColumns = 1),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,2,3)),
                                               list(className = 'dt-right', targets = 4:6)
                                               ))) %>%
           DT::formatStyle(2, fontWeight = "bold"#, padding = "4px"
                          )
        )
     )


```


### **Health Boards**

```{r dropdown-hb-age-pop}
pds_hb_age_rates <- #bind_rows(
  
  #pds_all_age_rates %>% filter(!grepl("NHS", geog)) %>% 
         #  mutate(age_grp_2_group = age, .before = age_grp_2) %>% 
 # mutate(key = paste0(fy,age_grp_2_group,geog), .before = geog),
  
   pds_all_age_rates %>% filter(grepl("NHS", geog) | geog == "Scotland") %>% 
         mutate(age_grp_2_group = "All", .before = age_grp_2)  %>% 
  mutate(key = paste0(fy,age_grp_2_group,geog), .before = geog)
#)

pds_pop_age_data_hb <- SharedData$new(pds_hb_age_rates, key = ~key, group = "hb_age_pop")

data_filter_hb_age_pop <- filter_select(id = "filter_hb_age_pop",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = pds_pop_age_data_hb,
                                    multiple = FALSE
                                      )

# data_filter_hb_age_pop_quintile <- filter_select(id = "filter_hb_age_pop_quintile",
#                                     label = "Select Age Group:",
#                                     group = ~age_grp_2_group,
#                                     sharedData = pds_pop_age_data_hb,
#                                     multiple = FALSE
#                                       )
# 
# data_filter_hb_age_pop_geog <- filter_select(id = "filter_hb_age_pop_geog",
#                                     label = "Select Integration Authority Area(s):",
#                                     group = ~geog,
#                                     sharedData = pds_pop_age_data_hb,
#                                     multiple = TRUE
#                                       )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_hb_age_pop,
       NULL)

# bscols(widths = c(1,10,NA), NULL, data_filter_hb_age_pop_geog, NULL)
```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Number of people referred to PDS per 10,000 population by Age Group and Health Board</h2>
```{r plot-hb-age-legend-pop2}

bscols(widths = 12,
div(style=css(marginBottom="-20px",height="65px"), plot_geog_bar_legend(pds_all_age %>% filter(geog == "Scotland"), measure = age_grp_2, colours = age_colours)))

```


```{r plot-hb-age-pop2}

bscols(widths = 12,
  div(style = css(width="98%", height="355px", marginBottom="-20px"),
plot_ly(pds_pop_age_data_hb, x = ~geog, y = ~pop_rate_10000, meta = ~fy, hovertext = ~age_grp_2, type = 'bar', color = ~age_grp_2, colors = age_colours, 
        hovertemplate = paste0("%{x} <br>", "%{meta} <br>", "Age Group: %{hovertext} <br>",
                            "Rate per 10,000 Population: %{y}<extra></extra>")) %>% 
  layout(clickmode = "none", showlegend = FALSE, margin = list(l = -5, b = 10, t = 40),
         xaxis = list(title = "Integration Authority Area", showline = FALSE, linecolor = "#b3b3b3",
                      categoryorder = "trace", tickangle = -45, titlefont = list(size = 16)),
         yaxis = list(title = "Rate per 10,000 Population", linecolor = "#b3b3b3", titlefont = list(size = 16))
      ) %>%
  config(displayModeBar = TRUE, doubleClick = F,
         modeBarButtonsToRemove = list('select2d', 'lasso2d', 'zoomIn2d', 
                                       'zoomOut2d', 'autoScale2d', 
                                       'toggleSpikelines', 
                                       'hoverCompareCartesian', 
                                       'hoverClosestCartesian', 'toImage'), 
         displaylogo = F, editable = F)
  )
)

```


```{r table-hb-age-pop}

hb_pop_age_table_data <- #bind_rows(
  
  # pds_all_age_rates %>%
  # filter(!grepl("NHS", geog)) %>%
  # select(geog,fy,age_grp_2,pop_rate_10000) %>%
  #  mutate(age_grp_2_group = age_grp_2, .before = age_grp_2),

  pds_all_age_rates %>%
  filter(grepl("NHS", geog) | geog == "Scotland") %>%
  select(geog,fy,age_grp_2,pop_rate_10000) %>%
   mutate(age_grp_2_group = "All", .before = age_grp_2
          ) %>% 
  
     mutate(pop_rate_10000 = as.character(pop_rate_10000)) %>%
   arrange(age_grp_2) %>% 
  pivot_wider(names_from = age_grp_2, values_from = pop_rate_10000) %>%
  mutate(key = paste0(fy,age_grp_2_group,geog), .before = geog) %>% 
  mutate(across(everything(), ~if_else(age_grp_2_group == "All", 
                                       replace_na(.x, "-"), 
                                       replace_na(.x, " ")))) %>%
             rename(`Integration Authority Area` = geog) 


hb_age_table_pop <- SharedData$new(hb_pop_age_table_data, key = ~key, group = "hb_age_pop")


bscols(widths = 12,
       div(style = css(width="97%", height="460px", margin="20px"),
DT::datatable(hb_age_table_pop, rownames = FALSE, selection = 'none',
              options = list(pageLength = 15,
                             scrollX = TRUE,
                            # fixedColumns = list(leftColumns = 1),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,2,3)),
                                               list(className = 'dt-right', targets = 4:6)
                                               ))) %>%
           DT::formatStyle(2, fontWeight = "bold"#, padding = "4px"
                          )
        )
     )


```

### **Trend**

```{r dropdown-trend-age-pop}

pds_pop_age_data <- SharedData$new(pds_age_rates_2_data,
  key = ~geog, group = "trend_age_pop")

data_filter_trend_age_pop <- filter_select(id = "filter_trend_age_pop",
                                    label = "Select Integration Authority Area or Health Board:",
                                    group = ~geog,
                                    sharedData = pds_pop_age_data,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_trend_age_pop,
       NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 15px"> Number of people referred to PDS per 10,000 population by Age Group and Financial Year</h2> 
```{r plot-trend-age-legend-pop}

bscols(widths = 12,
       div(style = css(height="30px"),
plot_rate_line_legend_1(legend_data)),NULL
)

```

```{r plot-trend-age-pop}

bscols(widths = 12,
  div(style = css(width="98%", height="370px"),
plot_rate_line(pds_pop_age_data, measure = age_grp_2, measure_text = "Age Group: ", y = "Rate per 10,000 Population", scales = "free_y", colours = age_colours, facet_space = -5))
)

```

```{r table-trend-age-pop}

trend_pop_age_table_data <- pds_all_age_rates %>% filter(!is.na(pop_rate_10000)) %>% 
  select(geog,fy,age_grp_2,pop_rate_10000) %>%
  pivot_wider(names_from = fy, values_from = pop_rate_10000) %>%
  arrange(age_grp_2) %>% 
             rename(`Age Group` = age_grp_2)


trend_pop_age_table <- SharedData$new(trend_pop_age_table_data, key = ~geog, group = "trend_age_pop")


bscols(widths = 12,
       div(style = css(width="97%", height="170px", margin="20px"),
DT::datatable(trend_pop_age_table, rownames = FALSE, selection = 'none',
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0)))
              ) %>%
           DT::formatStyle(2, fontWeight = "bold")
        )
     )



```

Age Outcomes {.hidden}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Age Groups - Outcomes 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Rates per 10,000 population](#age-groups)</li>
  <li>[**Outcomes**](#age-outcomes)</li>
</ul>

***

For more information regarding how the LDP Standard is calculated please see the [methodology](#methodology) page.

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

**-**

<!-- **Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.** -->

Row {.tabset data-height=1110}
----------------------------------------------------------------------

### **Integration Authority Areas**

```{r dropdown-ijb-age-ldp}
ldp_ijb_age <- ldp_all_age %>% filter(!grepl("NHS", geog)) %>%  
         mutate(age_grp_2_group = "All", .before = age_grp_2)  %>% 
  mutate(key = paste0(fy,age_grp_2_group,geog), .before = geog)

ldp_age_data_ijb <- SharedData$new(ldp_ijb_age, key = ~key,  group = "ijb_age_ldp")

data_filter_ijb_age_ldp <- filter_select(id = "filter_ijb_age_ldp",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = ldp_age_data_ijb,
                                    multiple = FALSE
                                      )

data_filter_ijb_age_ldp_geog <- filter_select(id = "filter_ijb_age_ldp_geog",
                                    label = "Select Integration Authority Area(s):",
                                    group = ~geog,
                                    sharedData = ldp_age_data_ijb,
                                    multiple = TRUE
                                      )


bscols(widths = c(1,5,NA),
       NULL,
       data_filter_ijb_age_ldp,
       NULL)

bscols(widths = c(1,10,NA), NULL, data_filter_ijb_age_ldp_geog, NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px">Percentage of referrals who received a minimum of one year’s PDS by Age Group and Integration Authority Area</h2>
```{r plot-ijb-age-legend-ldp}

 bscols(widths = 12,
div(style=css(marginBottom="-20px",height="65px"), plot_geog_bar_legend(ldp_all_age %>% filter(geog == "Scotland"), measure = age_grp_2, colours = age_colours)))

```


```{r plot-ijb-age-ldp}
bscols(widths = 12,
  div(style = css(width="98%", height="355px", marginBottom="-20px"),
plot_ly(ldp_age_data_ijb, x = ~geog, y = ~perc_met, meta = ~fy, hovertext = ~age_grp_2, type = 'bar', color = ~age_grp_2, colors = age_colours, 
        hovertemplate = paste0("%{x} <br>", "%{meta} <br>", "Age Group: %{hovertext} <br>",
                            "%{y}<extra></extra>")) %>% 
  layout(clickmode = "none", showlegend = FALSE, margin = list(l = -5, b = 10, t = 40),
         xaxis = list(title = "Integration Authority Area", showline = FALSE, linecolor = "#b3b3b3",
                      categoryorder = "trace", tickangle = -45, titlefont = list(size = 16)),
         yaxis = list(title = "", linecolor = "#b3b3b3", ticksuffix = "%")
      ) %>%
  config(displayModeBar = TRUE, doubleClick = F,
         modeBarButtonsToRemove = list('select2d', 'lasso2d', 'zoomIn2d', 
                                       'zoomOut2d', 'autoScale2d', 
                                       'toggleSpikelines', 
                                       'hoverCompareCartesian', 
                                       'hoverClosestCartesian', 'toImage'), 
         displaylogo = F, editable = F)
  )
)

```


```{r table-ijb-age-ldp}
ijb_age_ldp_data <- bind_rows(
  
  ldp_all_age %>% filter(!grepl("NHS", geog)) %>% 
  select(geog,fy,age_grp_2,perc_met) %>%
   mutate(age_grp_2_group = age_grp_2, .before = age_grp_2),

  ldp_all_age %>% filter(!grepl("NHS", geog)) %>% 
  select(geog,fy,age_grp_2,perc_met) %>%
   mutate(age_grp_2_group = "All", .before = age_grp_2)
) %>% 
 mutate(perc_met = if_else(is.na(perc_met), "-", paste0(perc_met,"%"))) %>%
    arrange(age_grp_2) %>% 
  pivot_wider(names_from = age_grp_2, values_from = perc_met) %>%
  mutate(key = paste0(fy,age_grp_2_group,geog), .before = geog) %>% 
  mutate(across(everything(), ~if_else(age_grp_2_group == "All", 
                                       replace_na(.x, "-"), 
                                       replace_na(.x, " "))))  %>% 
  mutate(type = "% Met Standard/Exempt", .after = age_grp_2_group)



ijb_age_totals_data <- bind_rows(
  
   pds_all_age %>%
  filter(!grepl("NHS", geog)) %>% 
  mutate(age_grp_2_group = age_grp_2, .before = age_grp_2), 

 pds_all_age %>%
  filter(!grepl("NHS", geog)) %>% 
  mutate(age_grp_2_group = "All", .before = age_grp_2)
 ) %>% 
  mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>%
    arrange(age_grp_2) %>% 
  pivot_wider(names_from = age_grp_2, values_from = total_referrals) %>%
  mutate(key = paste0(fy,age_grp_2_group,geog), .before = geog) %>% 
  mutate(across(everything(), ~if_else(age_grp_2_group == "All", 
                                       replace_na(.x, "-"), 
                                       replace_na(.x, " ")))) %>% 
  mutate(type = "Number of Referrals", .after = age_grp_2_group)


         

ijb_ldp_age_table_data <- bind_rows(ijb_age_totals_data, ijb_age_ldp_data) %>% 
  arrange(geog, key, desc(type)) %>% 
  mutate(geog = if_else(type == "% Met Standard/Exempt", " ", geog)) %>% 
 rename(" " = "type") %>% 
    rename(`Integration Authority Area` = geog)


ijb_age_table_ldp <- SharedData$new(ijb_ldp_age_table_data, key = ~key, group = "ijb_age_ldp")


bscols(widths = 12,
       div(style = css(width="97%", height="410px", margin="20px"),
DT::datatable(ijb_age_table_ldp, rownames = FALSE, selection = "none", #extensions = "FixedColumns",
              options = list(pageLength = 66,
                             scrollX = TRUE,
                            # fixedColumns = list(leftColumns = 4),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,1,3)),
                                               list(className = 'dt-right', targets = 5:7)
                                               ))) %>%
           DT::formatStyle(c(3,5), fontWeight = "bold"#, padding = "4px"
                          )
        )
     )
```

### **Health Boards**

```{r dropdown-hb-age-ldp}
ldp_hb_age <- #bind_rows( 
  
 # ldp_all_age %>% filter(!grepl("NHS", geog)) %>% 
        #   mutate(age_grp_2_group = age_grp_2, .before = age_grp_2) %>% 
#  mutate(key = paste0(fy,age_grp_2_group,geog), .before = geog),
  
   ldp_all_age %>% filter(geog == "Scotland" | grepl("NHS", geog)) %>%  
         mutate(age_grp_2_group = "All", .before = age_grp_2)  %>% 
  mutate(key = paste0(fy,age_grp_2_group,geog), .before = geog)
#)

ldp_age_data_hb <- SharedData$new(ldp_hb_age, key = ~key, group = "hb_age_ldp")

data_filter_hb_age_ldp <- filter_select(id = "filter_hb_age_ldp",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = ldp_age_data_hb,
                                    multiple = FALSE
                                      )

# data_filter_hb_age_ldp_quintile <- filter_select(id = "filter_hb_age_ldp_quintile",
#                                     label = "Select Age Group:",
#                                     group = ~age_grp_2_group,
#                                     sharedData = ldp_age_data_hb,
#                                     multiple = FALSE
#                                       )


#data_filter_hb_age_ldp_geog <- filter_select(id = "filter_hb_age_ldp_geog",
                             #       label = "Select Integration Authority Area(s):",
                                  #  group = ~geog,
                                   # sharedData = ldp_age_data_hb,
                                   # multiple = TRUE
                                   #   )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_hb_age_ldp,
       NULL)

#bscols(widths = c(1,10,NA), NULL, data_filter_hb_age_ldp_geog, NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px">Percentage of referrals who received a minimum of one year’s PDS by Age Group and Health Board</h2>
```{r plot-hb-age-legend-ldp}

 bscols(widths = 12,
div(style=css(marginBottom="-20px",height="65px"), plot_geog_bar_legend(ldp_all_age %>% filter(geog == "Scotland"), measure = age_grp_2, colours = age_colours)))

```


```{r plot-hb-age-ldp}

bscols(widths = 12,
  div(style = css(width="98%", height="355px", marginBottom="-20px"),
plot_ly(ldp_age_data_hb, x = ~geog, y = ~perc_met, meta = ~fy, hovertext = ~age_grp_2, type = 'bar', color = ~age_grp_2, colors = age_colours, 
        hovertemplate = paste0("%{x} <br>", "%{meta} <br>", "Age Group: %{hovertext} <br>",
                            "%{y}<extra></extra>")) %>% 
  layout(clickmode = "none", showlegend = FALSE, margin = list(l = -5, b = 10, t = 40),
         xaxis = list(title = "Health Board", showline = FALSE, linecolor = "#b3b3b3",
                      categoryorder = "trace", tickangle = -45, titlefont = list(size = 16)),
         yaxis = list(title = "", linecolor = "#b3b3b3", ticksuffix = "%")
      ) %>%
  config(displayModeBar = TRUE, doubleClick = F,
         modeBarButtonsToRemove = list('select2d', 'lasso2d', 'zoomIn2d', 
                                       'zoomOut2d', 'autoScale2d', 
                                       'toggleSpikelines', 
                                       'hoverCompareCartesian', 
                                       'hoverClosestCartesian', 'toImage'), 
         displaylogo = F, editable = F)
  )
)

```


```{r table-hb-age-ldp}
hb_age_ldp_data <- bind_rows(
  
  ldp_all_age %>% filter(geog == "Scotland" | grepl("NHS", geog)) %>% 
  select(geog,fy,age_grp_2,perc_met) %>%
   mutate(age_grp_2_group = age_grp_2, .before = age_grp_2),

  ldp_all_age %>% filter(geog == "Scotland" | grepl("NHS", geog)) %>% 
  select(geog,fy,age_grp_2,perc_met) %>%
   mutate(age_grp_2_group = "All", .before = age_grp_2)
) %>% 
 mutate(perc_met = if_else(is.na(perc_met), "-", paste0(perc_met,"%"))) %>%
    arrange(age_grp_2) %>% 
  pivot_wider(names_from = age_grp_2, values_from = perc_met) %>%
  mutate(key = paste0(fy,age_grp_2_group,geog), .before = geog) %>% 
  mutate(across(everything(), ~if_else(age_grp_2_group == "All", 
                                       replace_na(.x, "-"), 
                                       replace_na(.x, " "))))  %>% 
  mutate(type = "% Met Standard/Exempt", .after = age_grp_2_group)



hb_age_totals_data <- bind_rows(
  
   pds_all_age %>%
  filter(geog == "Scotland" | grepl("NHS", geog)) %>% 
  mutate(age_grp_2_group = age_grp_2, .before = age_grp_2), 

 pds_all_age %>%
  filter(geog == "Scotland" | grepl("NHS", geog)) %>% 
  mutate(age_grp_2_group = "All", .before = age_grp_2)
 ) %>% 
  mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>%
    arrange(age_grp_2) %>% 
  pivot_wider(names_from = age_grp_2, values_from = total_referrals) %>%
  mutate(key = paste0(fy,age_grp_2_group,geog), .before = geog) %>% 
  mutate(across(everything(), ~if_else(age_grp_2_group == "All", 
                                       replace_na(.x, "-"), 
                                       replace_na(.x, " ")))) %>% 
  mutate(type = "Number of Referrals", .after = age_grp_2_group)


         

hb_ldp_age_table_data <- bind_rows(hb_age_totals_data, hb_age_ldp_data) %>% 
  arrange(geog, key, desc(type)) %>% 
  mutate(geog = if_else(type == "% Met Standard/Exempt", " ", geog)) %>% 
 rename(" " = "type") %>% 
    rename(`Integration Authority Area` = geog)


hb_age_table_ldp <- SharedData$new(hb_ldp_age_table_data, key = ~key, group = "hb_age_ldp")


bscols(widths = 12,
       div(style = css(width="97%", height="470px", margin="20px"),
DT::datatable(hb_age_table_ldp, rownames = FALSE, selection = "none", #extensions = "FixedColumns",
              options = list(pageLength = 30,
                             scrollX = TRUE,
                             #fixedColumns = list(leftColumns = 4),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,1,3)),
                                               list(className = 'dt-right', targets = 5:7)
                                               ))) %>%
           DT::formatStyle(c(3,5), fontWeight = "bold"#, padding = "4px"
                          )
        )
     )



```

### **Trend**

```{r dropdown-ldp-age}

ldp_all_age_data <- SharedData$new(ldp_all_age, key = ~geog, group = "ldp_age")

data_filter_ldp_age <- filter_select(id = "filter_ldp_age",
                                    label = "Select Integration Authority Area or Health Board:",
                                    group = ~geog,
                                    sharedData = ldp_all_age_data,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_ldp_age,
       NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 15px">Percentage of referrals who received a minimum of one year’s PDS by Age Group and Financial Year</h2>
```{r plot-ldp-age-legend}
bscols(widths = 12,
       div(style = css(height="30px"),
plot_ldp_line_legend_1(legend_data)),NULL
)
```

```{r plot-ldp-age}
bscols(widths = 12,
  div(style = css(width="98%", height="370px"),
plot_ldp_line(ldp_all_age_data, measure = age_grp_2, measure_text = "Age Group: ", colours = age_colours))
)

```


```{r table-ldp-age}

ldp_age_trend <- ldp_all_age %>% filter(!is.na(perc_met)) %>%
  select(geog, fy, age_grp_2, perc_met) %>%
   mutate(perc_met = paste0(perc_met, "%")) %>% 
  pivot_wider(names_from = fy, values_from = perc_met) %>%
  mutate(type = "% Met Standard/Exempt", .before = `2016/17`)
  
trend_age_totals <- pds_all_age %>% filter(fy %in% full_years, total_referrals != 0) %>%
  mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = total_referrals, values_fill = "0") %>% 
    mutate(type = "Number of Referrals", .before = `2016/17`)


ldp_age_table_data <- bind_rows(trend_age_totals, ldp_age_trend) %>% arrange(geog, age_grp_2) %>% 
            mutate(across(everything(), ~replace_na(.x, "-"))) %>% 
  mutate(age_grp_2 = if_else(type == "% Met Standard/Exempt", " ", age_grp_2)) %>% 
   rename(`Age Group` = age_grp_2) %>% 
  rename(" " = "type")

            

ldp_age_table <- SharedData$new(ldp_age_table_data, key = ~geog, group = "ldp_age")


bscols(widths = 12,
       div(style = css(width="97%", height="280px", margin="20px"),
DT::datatable(ldp_age_table, rownames = FALSE, selection = 'none',
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right',
                                                    targets = 3:(length(full_years)+2))
                                               ))) %>%
           DT::formatStyle(2:3, fontWeight = "bold")
        )
     )



```




```{js }
function filter_default() {

  document.getElementById("filter_ijb_age_pop").getElementsByClassName("selectized") 
  [0].selectize.setValue("2024/25", false);

  document.getElementById("filter_ijb_age_pop").getElementsByClassName("selectized")
  [0].selectize.removeOption("");

  document.getElementById("filter_ijb_age_pop_geog").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_hb_age_pop").getElementsByClassName("selectized") 
  [0].selectize.setValue("2024/25", false);

  document.getElementById("filter_hb_age_pop").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_trend_age_pop").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("filter_trend_age_pop").getElementsByClassName("selectized")
  [0].selectize.removeOption("");

  document.getElementById("filter_ijb_age_ldp").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_ijb_age_ldp").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_ijb_age_ldp_geog").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_hb_age_ldp").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_hb_age_ldp").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_ldp_age").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("filter_ldp_age").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  

  
  
 
  }
  
  $(document).ready(filter_default);

```

