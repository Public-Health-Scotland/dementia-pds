---
title: "ADDITIONAL ANALYSIS DRAFT"
output: 
  flexdashboard::flex_dashboard:
    logo: phs-logo.png
    orientation: rows
    vertical_layout: scroll
---

```{r load-setup, include=FALSE}
source(here::here("code", "00_setup-environment.R"))
library(crosstalk) # for drop down menus
library(phsstyles)
library(htmltools)

# Write numbers with thousands separator
knit_hooks$set(inline = function(x){
  if(!is.character(x)){prettyNum(x, big.mark=",")}else{x}
})
```

---
date: "`r paste('Data as at', format(end_date, '%d %B %Y'))`"
---

```{r setup, include=FALSE}

# Load functions
walk(dir(here::here("functions"), full.names = TRUE), source)


# Load PDS data
pds <- read_rds(get_mi_data_path("final_data", ext = "rds", test_output = test_output)) %>% 
  
  # Remove codes from board and IJB
  mutate(health_board = str_sub(health_board, 3, -1),
         ijb          = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))

# Load expected diagnoses reference file
exp <- read_csv(get_exp_diagnoses_path())


# Load error summary
err <- read_rds(get_mi_data_path("error_data", ext = "rds", test_output = test_output)) %>% 

  mutate(ijb = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))

# calculate referrals for Scotland and health boards
pds_ijb <- pds %>% arrange(ijb)

pds_ijb %<>% rename(geog = ijb) 

pds_ijb$geog<- factor(pds_ijb$geog, levels = unique(pds_ijb$geog))

pds_scot <- pds %>% group_by(health_board = "Scotland", ijb = "Scotland", fy, month, ldp_full, ldp, age_grp_2, age_grp, simd, sex) %>%  summarise(referrals = sum(referrals), .groups = "drop")

pds_scot %<>% rename(geog = ijb) 

pds_scot$geog<- factor(pds_scot$geog, levels = unique(pds_scot$geog))

pds_hb <- pds %>% group_by(health_board, fy, month, ldp_full, ldp, age_grp_2, age_grp, simd, sex) %>% 
  summarise(referrals = sum(referrals), .groups = "drop") %>% mutate(ijb = health_board, .before = fy)

pds_hb %<>% rename(geog = ijb) 

pds_hb$geog<- factor(pds_hb$geog, levels = unique(pds_hb$geog))

# combine data for ijb, hb and Scotland
pds_all <- bind_rows(pds_scot, pds_ijb, pds_hb)

pds_all$geog<- factor(pds_all$geog, levels = unique(pds_all$geog))

#get totals for all geogs, hbs, ijbs, scotland
pds_all_totals <- pds_all %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_ijb_totals <- pds_ijb %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_hb_totals <- pds_hb %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_scot_totals <- pds_scot %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))


#get totals for all geogs, hbs, ijbs, scotland with LARGE AGE GROUPS
pds_all_totals_2 <- bind_rows(pds_all_totals,
  pds_all %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_all_totals_2$age_grp_2<- factor(pds_all_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))

pds_ijb_totals_2 <- bind_rows(pds_ijb_totals,
    pds_ijb %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_ijb_totals_2$age_grp_2<- factor(pds_ijb_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))


pds_hb_totals_2 <- bind_rows(pds_hb_totals,
    pds_hb %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_hb_totals_2$age_grp_2<- factor(pds_hb_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))


pds_scot_totals_2 <- bind_rows(pds_scot_totals,
    pds_scot %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_scot_totals_2$age_grp_2<- factor(pds_scot_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))



#create year lists
provisional_year <- paste0(as.numeric(substr(last(finalised_years),1,4)) + 1,
                           "/", as.numeric(substr(last(finalised_years),6,7)) + 1)

current_fy <- paste0(substr(fy,1,4),
                           "/", as.numeric(substr(fy,3,4)) + 1)

last_full_year <- if_else(qt == 4, current_fy, paste0(as.numeric(substr(fy,1,4)) - 1,
                           "/", as.numeric(substr(fy,3,4))))

all_years <- unique(pds_all$fy)

if(qt == 4){full_years = all_years}else{full_years = all_years[-length(all_years)]}


```
<!-- delete all of above when finished testing -->


```{r data-setup-additional, include=FALSE}
#prepare subtype of dementia data
subtype_data <- read_rds(get_mi_data_path("subtype_data", ext = "rds", test_output = test_output))

pds_all_subtype <- subtype_data %>% filter(age_grp_2 == "All") %>% 
  select(geog, fy, subtype, total_referrals)

pds_all_subtype$geog <- factor(pds_all_subtype$geog, levels = unique(pds_all$geog))

pds_all_subtype$subtype <- factor(pds_all_subtype$subtype, levels = c(unique(pds_all_subtype$subtype)[-6],unique(pds_all_subtype$subtype)[6]))

ldp_all_subtype <- subtype_data %>% filter(fy %in% full_years, age_grp_2 == "All") %>%
  select(-health_board, -age_grp_2, -total_referrals) %>% 
  complete(nesting(geog, fy), subtype, fill = list(perc_met = NA))

ldp_all_subtype <- left_join(ldp_all_subtype,
ldp_all_subtype %>% filter(geog == "Scotland") %>% select(fy, subtype, perc_met) %>% 
  rename(scot_perc_met = perc_met))

ldp_all_subtype$geog<- factor(ldp_all_subtype$geog, levels = unique(pds_all$geog))

ldp_all_subtype$subtype <- factor(ldp_all_subtype$subtype, levels = c(unique(ldp_all_subtype$subtype)[-6],unique(ldp_all_subtype$subtype)[6]))

# prepare stage of illness data
stage_data <- read_rds(get_mi_data_path("stage_data", ext = "rds", test_output = test_output))

pds_all_stage <- stage_data %>% filter(age_grp_2 == "All") %>% 
  select(geog, fy, stage, total_referrals)

pds_all_stage$geog <- factor(pds_all_stage$geog, levels = unique(pds_all$geog))

pds_all_stage$stage <- factor(pds_all_stage$stage, 
    levels = c(unique(pds_all_stage$stage)[1],unique(pds_all_stage$stage)[3],unique(pds_all_stage$stage)[2],unique(pds_all_stage$stage)[5],unique(pds_all_stage$stage)[4]))
                              
ldp_all_stage <- stage_data %>% filter(fy %in% full_years, age_grp_2 == "All") %>%
  select(-health_board, -age_grp_2, -total_referrals) %>% 
  complete(nesting(geog, fy), stage, fill = list(perc_met = NA))

ldp_all_stage <- left_join(ldp_all_stage,
ldp_all_stage %>% filter(geog == "Scotland") %>% select(fy, stage, perc_met) %>% 
  rename(scot_perc_met = perc_met))

ldp_all_stage$geog<- factor(ldp_all_stage$geog, levels = unique(pds_all$geog))

ldp_all_stage$stage <- factor(ldp_all_stage$stage, 
    levels = c(unique(ldp_all_stage$stage)[1],unique(ldp_all_stage$stage)[3],unique(ldp_all_stage$stage)[2],unique(ldp_all_stage$stage)[5],unique(ldp_all_stage$stage)[4]))
                              

#prepare model of care data
model_data <- read_rds(get_mi_data_path("model_data", ext = "rds", test_output = test_output))

pds_all_model <- model_data %>% filter(age_grp_2 == "All", sex == "All", simd == "All") %>% 
  select(geog, fy, model, total_referrals)

pds_all_model$geog <- factor(pds_all_model$geog, levels = unique(pds_all$geog))

pds_all_model$model <- factor(pds_all_model$model, 
    levels = c(unique(pds_all_model$model)[-1],unique(pds_all_model$model)[1]))
                              
ldp_all_model <- model_data %>% filter(fy %in% full_years, age_grp_2 == "All", sex == "All", simd == "All") %>%
  select(-health_board, -age_grp_2, -total_referrals) %>% 
  complete(nesting(geog, fy), model, fill = list(perc_met = NA))

ldp_all_model <- left_join(ldp_all_model,
ldp_all_model %>% filter(geog == "Scotland") %>% select(fy, model, perc_met) %>% 
  rename(scot_perc_met = perc_met))

ldp_all_model$geog<- factor(ldp_all_model$geog, levels = unique(pds_all$geog))

ldp_all_model$model <- factor(ldp_all_model$model, 
    levels = c(unique(ldp_all_model$model)[-1],unique(ldp_all_model$model)[1]))

#load uptake decision data
uptake_data <- read_rds(get_mi_data_path("uptake_data", ext = "rds", test_output = test_output))

#load carer's support data
carer_data <- read_rds(get_mi_data_path("carer_data", ext = "rds", test_output = test_output))

#legend tibble
legend_data <- tibble(
  geog = c("Selected Health Board/Integration Authority Area", "Scotland"),
  x = c(1,2),
  y = c(0,0))

legend_data$geog <- factor(legend_data$geog, levels = unique(legend_data$geog))

# total referrals for tables
hb_totals_table <- bind_rows(pds_scot_totals, pds_hb_totals) %>%
  mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% pivot_wider(names_from = geog, values_from = total_referrals)

ijb_totals_table <- bind_rows(pds_scot_totals, pds_ijb_totals)  %>%
  mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% pivot_wider(names_from = geog, values_from = total_referrals)

all_totals_table_2 <- bind_rows(

bind_rows(pds_scot_totals_2, pds_ijb_totals_2) %>% group_by(geog, fy = "All", age_grp_2) %>% 
  summarise(`All referrals` = sum(total_referrals), .groups = "drop") %>% 
  mutate(geog_type = "Integration Authority Areas",
         key = paste0(age_grp_2,geog_type), .before= geog) %>% select(-fy),

bind_rows(pds_scot_totals_2, pds_hb_totals_2) %>% group_by(geog, fy = "All", age_grp_2) %>% 
  summarise(`All referrals` = sum(total_referrals), .groups = "drop") %>% 
  mutate(geog_type = "Health Boards",
         key = paste0(age_grp_2,geog_type), .before= geog) %>% select(-fy)
)


 
```

Subtype of Dementia {data-navmenu="Additional Information"}
=================================================

Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Subtype of Dementia - Proportions 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[**Proportions**](#subtype-of-dementia)</li>
  <li>[Outcomes](#subtype-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

**-**

Row {data-height=990}
----------------------------------------------------------------------

### 

<h2 style="margin-left: 70px; margin-top: 10px; margin-bottom: 0px"> Proportion of Referrals by Subtype of Dementia and Financial Year; Scotland</h2>
```{r plot-prop-subtype-legend-scot}
bscols(widths = 12,
div(style=css(marginBottom="-23px",height="95px", width="90%", marginLeft="35px"), plot_prop_legend(pds_all_subtype %>% filter(geog == "Scotland"), measure = subtype, colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#1E7F84", "#6B5C85", "#83BB26", "#C73918"))
    ))

```


```{r plot-prop-subtype-ijb}
pds_subtype_data_scot <- pds_all_subtype %>% filter(geog == "Scotland")

bscols(widths = 12,
  div(style = css(width="98%", height="500px", marginBottom = "-80px"),
      plot_trend_prop(pds_subtype_data_scot, measure = subtype, measure_text = "Subtype of Dementia: ", colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#1E7F84", "#6B5C85", "#83BB26", "#C73918"))
)
)

```


```{r table-prop-subtype-ijb}

pds_prop_subtype_table_data_scot <- bind_rows(
 test1<- pds_scot_totals %>% mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% 
    pivot_wider(names_from = fy, values_from = total_referrals) %>% mutate(age_grp_2 = "All referrals") %>% 
             rename(`Subtype of Dementia` = age_grp_2),
  
 test2<- pds_all_subtype %>%
  arrange(subtype) %>% filter(geog == "Scotland") %>% group_by(geog, fy) %>% 
  mutate(perc_referrals = paste0(round((total_referrals/sum(total_referrals))*100,0),"%")) %>% ungroup() %>%   select(-total_referrals) %>% 
  pivot_wider(names_from = fy, values_from = perc_referrals) %>%
             rename(`Subtype of Dementia` = subtype))

#pds_prop_subtype_table_data_scot[is.na(pds_prop_subtype_table_data_scot)] <- "0%"


bscols(widths = 12,
       div(style = css(width="98%", height="390px", margin="15px"),
          DT::datatable(pds_prop_subtype_table_data_scot, rownames = FALSE, extensions = "FixedColumns",
              options = list(pageLength = 9,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right', targets = 2:(length(all_years)+1))
                             ))) %>%
  DT::formatStyle(1, fontWeight = "bold")
  
            )
       )




```


Subtype Outcomes {.hidden}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Subtype of Dementia - Outcomes 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Proportions](#subtype-of-dementia)</li>
  <li>[**Outcomes**](#subtype-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

**-**

Row {data-height=1260}
----------------------------------------------------------------------

### 

```{r dropdown-ldp-subtype, eval=FALSE, include=FALSE}

# ldp_all_subtype_data <- SharedData$new(ldp_all_subtype %>% filter(fy %in% full_years), key = ~geog, group = "ldp_subtype")

# data_filter_ldp_subtype <- filter_select(id = "filter_ldp_subtype",
#                                     label = "Select Integration Authority Area or Health Board:",
#                                     group = ~geog,
#                                     sharedData = ldp_all_subtype_data,
#                                     multiple = FALSE
#                                       )

# bscols(widths = c(1,5,NA),
#        NULL,
#        data_filter_ldp_subtype,
#        NULL)


```

<h2 style="margin-left: 70px; margin-top: 10px; margin-bottom: 20px">Percentage of referrals who received a minimum of one year’s PDS by Subtype of Dementia and Financial Year; Scotland </h2>
```{r plot-ldp-subtype-legend, eval=FALSE, include=FALSE}
# bscols(widths = 12,
# div(style=css(height="30px"),
# plot_ldp_line_legend_1(legend_data)),NULL
# )

```

```{r plot-ldp-subtype}
ldp_all_subtype_data <- ldp_all_subtype %>% filter(fy %in% full_years, geog == "Scotland")

bscols(widths = 12,
  div(style = css(width="98%", height="450px"),
plot_ldp_line_scot(ldp_all_subtype_data, measure = subtype, measure_text = "Subtype of Dementia: ", ncol = 4, nrow = 2, colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#1E7F84", "#6B5C85", "#83BB26", "#C73918"))
)
)


```


```{r table-ldp-subtype}

ldp_subtype_trend <- ldp_all_subtype %>% filter(!is.na(perc_met), geog == "Scotland") %>%
  select(geog, fy, subtype, perc_met) %>%
   mutate(perc_met = paste0(perc_met, "%")) %>% 
  pivot_wider(names_from = fy, values_from = perc_met) %>%
  mutate(type = "% Met Standard/Exempt", .before = `2016/17`)
  
trend_subtype_totals <- pds_all_subtype %>% filter(fy %in% full_years, total_referrals != 0, geog == "Scotland") %>%
  mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = total_referrals, values_fill = "0") %>% 
    mutate(type = "Number of Referrals", .before = `2016/17`)


ldp_subtype_table_data <- bind_rows(trend_subtype_totals, ldp_subtype_trend) %>% arrange(geog, subtype) %>% 
            mutate(across(everything(), ~replace_na(.x, "-"))) %>% 
  mutate(subtype = if_else(type == "% Met Standard/Exempt", " ", subtype)) %>% 
   rename(`Subtype of Dementia` = subtype) %>% 
  rename(" " = "type")
            


bscols(widths = 12,
       div(style = css(width="97%", height="660px", margin="20px"),
DT::datatable(ldp_subtype_table_data, rownames = FALSE,
              options = list(pageLength = 16,
                             scrollX = TRUE,
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right',
                                                    targets = 3:(length(full_years)+2))
                                               ))) %>%
           DT::formatStyle(2:3, fontWeight = "bold")# %>% 
  #DT::formatStyle(2, padding = "3px") 
        )
     )



```



Stage of Illness {data-navmenu="Additional Information"}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Clinical Impression of Stage of Illness - Proportions 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[**Proportions**](#stage-of-illness)</li>
  <li>[Outcomes](#stage-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**-**


Row {data-height=900}
----------------------------------------------------------------------

### 

<h2 style="margin-left: 70px; margin-top: 10px; margin-bottom: 0px"> Proportion of Referrals by Clinical Impression of Stage of Illness and Financial Year; Scotland</h2>
```{r plot-prop-stage-legend-scot}
bscols(widths = 12,
div(style=css(marginBottom="-23px",height="95px", width="90%", marginLeft="35px"), plot_prop_legend(pds_all_stage %>% filter(geog == "Scotland"), measure = stage, colours = c("#3F3685", "#9B4393", "#0078D4", "#83BB26", "#C73918"))
    ))

```


```{r plot-prop-stage-ijb}
pds_stage_data_scot <- pds_all_stage %>% filter(geog == "Scotland")

bscols(widths = 12,
  div(style = css(width="98%", height="500px", marginBottom = "-80px"),
      plot_trend_prop(pds_stage_data_scot, measure = stage, measure_text = "Stage of Illness: ", colours = c("#3F3685", "#9B4393", "#0078D4", "#83BB26", "#C73918"))
)
)

```


```{r table-prop-stage-ijb}

pds_prop_stage_table_data_scot <- bind_rows(
  pds_scot_totals %>% mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% 
    pivot_wider(names_from = fy, values_from = total_referrals) %>% mutate(age_grp_2 = "All referrals") %>% 
             rename(`Stage of Illness` = age_grp_2),
  
  pds_all_stage %>%
  arrange(stage) %>% filter(geog == "Scotland") %>% group_by(geog, fy) %>% 
  mutate(perc_referrals = paste0(round((total_referrals/sum(total_referrals))*100,0),"%")) %>% ungroup() %>%   select(-total_referrals) %>% 
  pivot_wider(names_from = fy, values_from = perc_referrals) %>%
             rename(`Stage of Illness` = stage))

pds_prop_stage_table_data_scot[is.na(pds_prop_stage_table_data_scot)] <- "0%"


bscols(widths = 12,
       div(style = css(width="98%", height="300px", margin="15px"),
          DT::datatable(pds_prop_stage_table_data_scot, rownames = FALSE, extensions = "FixedColumns",
              options = list(pageLength = 6,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right', targets = 2:(length(all_years)+1))
                             ))) %>%
  DT::formatStyle(1, fontWeight = "bold")
  
            )
       )




```


Stage Outcomes {.hidden}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Clinical Impression of Stage of Illness - Outcomes 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Proportions](#stage-of-illness)</li>
  <li>[**Outcomes**](#stage-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

**-**

Row {data-height=920}
----------------------------------------------------------------------

### 

```{r dropdown-ldp-stage, eval=FALSE, include=FALSE}

# ldp_all_stage_data <- SharedData$new(ldp_all_stage %>% filter(fy %in% full_years), key = ~geog, group = "ldp_stage")

# data_filter_ldp_stage <- filter_select(id = "filter_ldp_stage",
#                                     label = "Select Integration Authority Area or Health Board:",
#                                     group = ~geog,
#                                     sharedData = ldp_all_stage_data,
#                                     multiple = FALSE
#                                       )

# bscols(widths = c(1,5,NA),
#        NULL,
#        data_filter_ldp_stage,
#        NULL)


```

<h2 style="margin-left: 70px; margin-top: 10px; margin-bottom: 20px">Percentage of referrals who received a minimum of one year’s PDS by Clinical Impression of Stage of Illness and Financial Year; Scotland </h2>
```{r plot-ldp-stage-legend, eval=FALSE, include=FALSE}
# bscols(widths = 12,
# div(style=css(height="30px"),
# plot_ldp_line_legend_1(legend_data)),NULL
# )

```

```{r plot-ldp-stage}
ldp_all_stage_data <- ldp_all_stage %>% filter(fy %in% full_years, geog == "Scotland")

bscols(widths = 12,
  div(style = css(width="98%", height="350px"),
plot_ldp_line_scot(ldp_all_stage_data, measure = stage, measure_text = "Stage of Illness: ", ncol = 5, nrow = 1, colours = c("#3F3685", "#9B4393", "#0078D4", "#83BB26", "#C73918"))
)
)


```


```{r table-ldp-stage}

ldp_stage_trend <- ldp_all_stage %>% filter(!is.na(perc_met), geog == "Scotland") %>%
  select(geog, fy, stage, perc_met) %>%
   mutate(perc_met = paste0(perc_met, "%")) %>% 
  pivot_wider(names_from = fy, values_from = perc_met) %>%
  mutate(type = "% Met Standard/Exempt", .before = `2016/17`)
  
trend_stage_totals <- pds_all_stage %>% filter(fy %in% full_years, total_referrals != 0, geog == "Scotland") %>%
  mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = total_referrals, values_fill = "0") %>% 
    mutate(type = "Number of Referrals", .before = `2016/17`)


ldp_stage_table_data <- bind_rows(trend_stage_totals, ldp_stage_trend) %>% arrange(geog, stage) %>% 
            mutate(across(everything(), ~replace_na(.x, "-"))) %>% 
  mutate(stage = if_else(type == "% Met Standard/Exempt", " ", stage)) %>% 
   rename(`Stage of Illness` = stage) %>% 
  rename(" " = "type")
            


bscols(widths = 12,
       div(style = css(width="97%", height="460px", margin="20px"),
DT::datatable(ldp_stage_table_data, rownames = FALSE,
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right',
                                                    targets = 3:(length(full_years)+2))
                                               ))) %>%
           DT::formatStyle(2:3, fontWeight = "bold")# %>% 
  #DT::formatStyle(2, padding = "3px") 
        )
     )



```

Model of Care {data-navmenu="Additional Information"}
=====================================

Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Model of Care - Proportions 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[**Proportions**](#model-of-care)</li>
  <li>[Outcomes](#model-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**-**


Row {data-height=900}
----------------------------------------------------------------------

### 

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Proportion of Referrals by Model of Care and Financial Year; Scotland</h2>
```{r plot-prop-model-legend-scot}
bscols(widths = 12,
div(style=css(marginBottom="-23px",height="95px", width="90%", marginLeft="35px"), plot_prop_legend(pds_all_model %>% filter(geog == "Scotland"), measure = model, colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#83BB26", "#C73918"))
    ))

```


```{r plot-prop-model-ijb}
pds_model_data_scot <- pds_all_model %>% filter(geog == "Scotland")

bscols(widths = 12,
  div(style = css(width="98%", height="500px", marginBottom = "-80px"),
      plot_trend_prop(pds_model_data_scot, measure = model, measure_text = "Model of Care: ", colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#83BB26", "#C73918"))
)
)

```


```{r table-prop-model-ijb}

pds_prop_model_table_data_scot <- bind_rows(
  pds_scot_totals %>% mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% 
    pivot_wider(names_from = fy, values_from = total_referrals) %>% mutate(age_grp_2 = "All referrals") %>% 
             rename(`Model of Care` = age_grp_2),
  
  pds_all_model %>%
  arrange(model) %>% filter(geog == "Scotland") %>% group_by(geog, fy) %>% 
  mutate(perc_referrals = paste0(round((total_referrals/sum(total_referrals))*100,0),"%")) %>% ungroup() %>%   select(-total_referrals) %>% 
  pivot_wider(names_from = fy, values_from = perc_referrals) %>%
             rename(`Model of Care` = model))

pds_prop_model_table_data_scot[is.na(pds_prop_model_table_data_scot)] <- "0%"


bscols(widths = 12,
       div(style = css(width="98%", height="330px", margin="20px"),
          DT::datatable(pds_prop_model_table_data_scot, rownames = FALSE, extensions = "FixedColumns",
              options = list(pageLength = 7,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right', targets = 2:(length(all_years)+1))
                             ))) %>%
  DT::formatStyle(1, fontWeight = "bold")
  
            )
       )




```


Model Outcomes {.hidden}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Model of Care - Outcomes 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Proportions](#model-of-care)</li>
  <li>[**Outcomes**](#model-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

**-**

Row {data-height=1100}
----------------------------------------------------------------------

### 

```{r dropdown-ldp-model, eval=FALSE, include=FALSE}

# ldp_all_model_data <- SharedData$new(ldp_all_model %>% filter(fy %in% full_years), key = ~geog, group = "ldp_model")

# data_filter_ldp_model <- filter_select(id = "filter_ldp_model",
#                                     label = "Select Integration Authority Area or Health Board:",
#                                     group = ~geog,
#                                     sharedData = ldp_all_model_data,
#                                     multiple = FALSE
#                                       )

# bscols(widths = c(1,5,NA),
#        NULL,
#        data_filter_ldp_model,
#        NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 20px">Percentage of referrals who received a minimum of one year’s PDS by Model of Care and Financial Year; Scotland </h2>
```{r plot-ldp-model-legend, eval=FALSE, include=FALSE}
# bscols(widths = 12,
# div(style=css(height="30px"),
# plot_ldp_line_legend_1(legend_data)),NULL
# )

```

```{r plot-ldp-model}
ldp_all_model_data <- ldp_all_model %>% filter(fy %in% full_years, geog == "Scotland")

bscols(widths = 12,
  div(style = css(width="98%", height="450px"),
plot_ldp_line_scot(ldp_all_model_data, measure = model, measure_text = "Model of Care: ", ncol = 3, nrow = 2, colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#83BB26", "#C73918"))
)
)


```


```{r table-ldp-model}

ldp_model_trend <- ldp_all_model %>% filter(!is.na(perc_met), geog == "Scotland") %>%
  select(geog, fy, model, perc_met) %>%
   mutate(perc_met = paste0(perc_met, "%")) %>% 
  pivot_wider(names_from = fy, values_from = perc_met) %>%
  mutate(type = "% Met Standard/Exempt", .before = `2016/17`)
  
trend_model_totals <- pds_all_model %>% filter(fy %in% full_years, total_referrals != 0, geog == "Scotland") %>%
  mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = total_referrals, values_fill = "0") %>% 
    mutate(type = "Number of Referrals", .before = `2016/17`)


ldp_model_table_data <- bind_rows(trend_model_totals, ldp_model_trend) %>% arrange(geog, model) %>% 
            mutate(across(everything(), ~replace_na(.x, "-"))) %>% 
  mutate(model = if_else(type == "% Met Standard/Exempt", " ", model)) %>% 
   rename(`Model of Care` = model) %>% 
  rename(" " = "type")
            


bscols(widths = 12,
       div(style = css(width="97%", height="510px", margin="20px"),
DT::datatable(ldp_model_table_data, rownames = FALSE,
              options = list(pageLength = 12,
                             scrollX = TRUE,
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right',
                                                    targets = 3:(length(full_years)+2))
                                               ))) %>%
           DT::formatStyle(2:3, fontWeight = "bold")# %>% 
  #DT::formatStyle(2, padding = "3px") 
        )
     )



```


Carer's Support {data-navmenu="Additional Information"}
=====================================

Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Carer's Support 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**-**


Row {data-height=430}
----------------------------------------------------------------------

### 

```{r dropdown-carer-ijb}

table_ijb_carer_data <- carer_data %>% 
  filter(age_grp_2 == "All", simd == "All") %>% 
  filter(health_board == "Scotland") %>% 
  select(fy, carers_support, referrals) %>% 
  pivot_wider(names_from = carers_support, values_from = referrals) %>% 
  mutate(across(where(is.numeric), ~ replace(., is.na(.), 0))) %>% 
  adorn_totals("col") %>% 
  mutate(Known = Total - `Not Known`) %>% 
  mutate(perc_known = paste0(round(100*Known/Total,1), "%")) %>%
  mutate(perc_carer = if_else(Known == 0, "-", paste0(round(100*Yes/Known,1), "%"))) %>%
  mutate(perc_no_carer = if_else(Known == 0, "-", paste0(round(100*No/Known,1), "%"))) %>%
  mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  select(fy, Total, perc_known, perc_carer, perc_no_carer) %>% 
  rename("Number of People Referred to PDS" = "Total", 
         "% of referrals where Carer's Support is Recorded" = "perc_known",
         "% with Carer's Support" = "perc_carer",
         "% without Carer's Support" = "perc_no_carer",
         ) %>%
  pivot_longer(!fy, names_to = "measure", values_to = "value") %>% 
  pivot_wider(names_from = fy, values_from = value) %>% 
  rename(" " = "measure")


table_ijb_carer <- SharedData$new(table_ijb_carer_data)

```

<h2 style="margin-left: 70px; margin-top: 20px; margin-bottom: 0px">Percentage of individuals where PDS work is carried out in conjunction with the family/carer; Scotland</h2>
```{r table-carer-ijb}



bscols(widths = 12,
       div(style = css(width="98%", height="260px", margin="20px"),
          DT::datatable(table_ijb_carer_data, rownames = FALSE, caption = htmltools::tags$caption(
                       style = 'caption-side: bottom; text-align: left;',
                       "Note that Carer's Support is an optional field."),
              options = list(pageLength = 4,
                             scrollX = FALSE,
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(className = 'dt-right', targets = 1:(length(full_years)+1))
                             ))) %>%
  DT::formatStyle(1, fontWeight = "bold")
            )
       )


```