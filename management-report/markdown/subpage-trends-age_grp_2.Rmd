---
title: "TRENDS DRAFT"
output: 
  flexdashboard::flex_dashboard:
    logo: phs-logo.png
    orientation: rows
    vertical_layout: scroll
---

```{r load-setup, include=FALSE}
source(here::here("code", "00_setup-environment.R"))
library(crosstalk) # for drop down menus
library(phsstyles)
library(htmltools)


# Write numbers with thousands separator
knit_hooks$set(inline = function(x){
  if(!is.character(x)){prettyNum(x, big.mark=",")}else{x}
})
```

---
date: "`r paste('Data as at', format(end_date, '%d %B %Y'))`"
---

```{r setup, include=FALSE}

# Remove tidylog
detach("package:tidylog", unload = TRUE)

# Load functions
walk(dir(here::here("functions"), full.names = TRUE), source)

current_fy <- paste0(substr(fy,1,4),
                           "/", as.numeric(substr(fy,3,4)) + 1)

# Load PDS data
pds <- read_rds(get_mi_data_path("final_data", ext = "rds", test_output = test_output)) %>% 
  
  # Remove codes from board and IJB
  mutate(health_board = str_sub(health_board, 3, -1),
         ijb          = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))

# Load expected diagnoses reference file
exp <- read_csv(get_exp_diagnoses_path())


# Load error summary
err <- read_rds(get_mi_data_path("error_data", ext = "rds", test_output = test_output)) %>% 

  mutate(ijb = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))

# calculate final data referrals for Scotland and health boards
pds_ijb <- pds %>% arrange(ijb)

pds_scot <- pds %>% group_by(health_board = "Scotland", ijb = "Scotland", fy, month, ldp_full, ldp, age_grp_2, age_grp, simd, sex) %>%   summarise(referrals = sum(referrals), .groups = "drop")

pds_hb <- pds %>% group_by(health_board, fy, month, ldp_full, ldp, age_grp_2, age_grp, simd, sex) %>% 
  summarise(referrals = sum(referrals), .groups = "drop") %>% mutate(ijb = health_board, .before = fy)

# combine data for ijb, hb and Scotland
pds_all <- bind_rows(pds_scot, pds_hb, pds_ijb)

pds_all %<>% rename(geog = ijb) 

pds_all$geog<- factor(pds_all$geog, levels = unique(pds_all$geog))


```
<!-- delete all of above when finished testing -->


```{r data setup, include=FALSE}
# to be automated based on whether current year is complete or not??
#included_years <- c("2016/17", "2017/18", "2018/19", "2019/20", "2020/21", "2021/22", "2022/23", "2023/24")

#get totals for scotland, hbs and ijbs
pds_all_totals <- bind_rows(
  pds_all %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals)),
  pds_all %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
) %>% ungroup()

pds_ijb %<>% rename(geog = ijb) 

pds_ijb$geog<- factor(pds_ijb$geog, levels = unique(pds_ijb$geog))

pds_ijb_totals <- bind_rows(
    pds_ijb %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals)),
  pds_ijb %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
) %>% ungroup()

pds_hb %<>% rename(geog = ijb) 

pds_hb$geog<- factor(pds_hb$geog, levels = unique(pds_hb$geog))

pds_hb_totals <- bind_rows(
    pds_hb %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals)),
  pds_hb %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals)) %>% ungroup()
)

pds_scot %<>% rename(geog = ijb) 

pds_scot$geog<- factor(pds_scot$geog, levels = unique(pds_scot$geog))

pds_scot_totals <- bind_rows(
    pds_scot %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals)),
  pds_scot %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

#prepare population rate data
pop_data <- read_rds("//conf/dementia/A&I/Outputs/management-report/lookups/pop_data.rds")
 
pop_data_trends <- pop_data %>%  filter(age_grp == "All", sex == "All") %>% select(geog, year, age_grp_2, pop_est)

pds_all_cal_year <- pds_all_totals %>% 
  mutate(year = as.numeric(substr(fy, 1, 4)))

pds_all_rates <- left_join(pds_all_cal_year, pop_data_trends) %>% select(geog, fy, age_grp_2, total_referrals, pop_est) %>% 
  mutate(pop_rate_10000 = round((total_referrals/pop_est)*10000, 1)) %>% select(geog, fy, age_grp_2, pop_rate_10000)

pds_all_rates$geog<- factor(pds_all_rates$geog, levels = unique(pds_all_rates$geog))

pds_all_rates$age_grp_2<- factor(pds_all_rates$age_grp_2, levels = c("All", "65+", "64 and Under"))

pds_scot_rates <- pds_all_rates %>% filter(geog == "Scotland")

pds_ijb_rates <- pds_all_rates %>% filter(geog != "Scotland", !grepl("NHS", geog))

pds_hb_rates <- pds_all_rates %>% filter(grepl("NHS", geog))


```
<!-- TO DO: consolidate above into data_prep file -->


All Referrals - Trends & Rates
=================================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### All Referrals - Trend
***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[**All Referrals - Trend**](#all-referrals---trends-rates)</li>
  <li>[All Referrals - Rates per 10,000 population](#pop-trend)</li>
  <li>[All Referrals - Outcomes by Financial Year](#trend-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**


Row {.tabset data-height=565}
----------------------------------------------------------------------

### **Scotland**

<br>
<br>
<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Number of Individuals Diagnosed and Referred for PDS </h2>
<div>
```{r trend-plot}

trends_plot <- plot_trend(pds_scot_totals %>% filter(age_grp_2 == "All"), total_referrals, x ="Financial Year of Diagnosis", y = "Number")

bscols(widths = 12,
        div(style = css(width="98%", height="435px"), 
            trends_plot))

```
</div>

### **Health Boards**

```{r dropdown-hb}
pds_trends_data_hb <- SharedData$new(pds_hb_totals %>% filter(age_grp_2 == "All"))

data_filter_hb <- filter_select(id = "trend_filter_hb",
                                    label = "Select Health Board(s):",
                                    group = ~geog,
                                    sharedData = pds_trends_data_hb
                                   )

bscols(widths = c(1,10,NA), NULL,
data_filter_hb, NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Number of Individuals Diagnosed and Referred for PDS </h2>
```{r trend-plot-hb}

trends_plot_hb <- plot_trend(pds_trends_data_hb, total_referrals, x ="Financial Year of Diagnosis", y = "Number")

bscols(widths = 12,
        div(style = css(width="98%", height="395px"),
trends_plot_hb))

```



### **Integration Authority Areas**

```{r dropdown-ijb}
pds_trends_data_ijb <- SharedData$new(pds_ijb_totals %>% filter(age_grp_2 == "All"))

data_filter_ijb <- filter_select(id = "trend_filter_ijb",
                                    label = "Select Integration Authority Area(s):",
                                    group = ~geog,
                                    sharedData = pds_trends_data_ijb
                                   )

bscols(widths = c(1,10,NA), NULL,
data_filter_ijb, NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Number of Individuals Diagnosed and Referred for PDS </h2>
```{r trend-plot-ijb}

trends_plot_ijb <- plot_trend(pds_trends_data_ijb, total_referrals, x ="Financial Year of Diagnosis", y = "Number")

bscols(widths = 12,
        div(style = css(width="98%", height="395px"),
trends_plot_ijb))

```

Row {.tabset data-height=750}
----------------------------------------------------------------------

### **Health Boards**

```{r trend-table-hb}

pds_all_totals %>% filter(geog == "Scotland" | grepl("NHS", geog), age_grp_2 == "All") %>%
            select(-age_grp_2) %>%
            mutate(total_referrals = format(total_referrals, big.mark = ",")) %>%
            pivot_wider(names_from = fy, values_from = total_referrals) %>%
            rename(`Health Board` = geog) %>%
            kable(align = c("l", rep("r", length(unique(pds$fy))))) %>%
            kable_styling(full_width = FALSE) %>%
            column_spec(1, bold = TRUE) %>%
  # Add header above table
            add_header_above(
                    c(" " = 1,
                     "Financial Year of Diagnosis" = length(unique(pds$fy))))

```

### **Integration Authority Areas**

```{r trend-table-ijb}

pds_all_totals %>% filter(geog == "Scotland" | !grepl("NHS", geog), age_grp_2 == "All") %>%
            select(-age_grp_2) %>%
            mutate(total_referrals = format(total_referrals, big.mark = ",")) %>%
            pivot_wider(names_from = fy, values_from = total_referrals) %>%
            rename(`Integration Authority Area` = geog) %>%
            kable(align = c("l", rep("r", length(unique(pds$fy))))) %>%
            kable_styling(full_width = FALSE) %>%
            column_spec(1, bold = TRUE) %>%
  # Add header above table
            add_header_above(
                       c(" " = 1,
                         "Financial Year of Diagnosis" = length(unique(pds$fy)))) %>%
            scroll_box(height = "740px")


```

Pop Trend {.hidden}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### All Referrals - Rates per 10,000 population 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***
<ul>
  <li>[All Referrals - Trend](#all-referrals---trends-rates)</li>
  <li>[**All Referrals - Rates per 10,000 population**](#pop-trend)</li>
  <li>[All Referrals - Outcomes by Financial Year](#trend-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**


Row {.tabset data-height=2000}
----------------------------------------------------------------------

### **Trend by Financial Year**

```{r dropdown-pop}
pds_all_rates_key <- pds_all_rates %>% mutate(key = paste0(geog,age_grp_2), .before = geog)

pds_trends_pop_data <- SharedData$new(pds_all_rates_key, key = ~key, group = "pop")

data_filter_age_trend <- filter_select(id = "trend_filter_age_grp_2",
                                    label = "Select Age Group:",
                                    group = ~age_grp_2,
                                    sharedData = pds_trends_pop_data,
                                    multiple = FALSE
                                   )


data_filter_hb_ijb_pop <- filter_select(id = "trend_filter_pop_hb_ijb",
                                    label = "Select Health Board(s) or Integration Authority Area(s):",
                                    group = ~geog,
                                    sharedData = pds_trends_pop_data
                                   )
bscols(widths = c(1,10,NA),NULL,
data_filter_hb_ijb_pop,NULL)
bscols(widths = c(1,4,NA),NULL,
data_filter_age_trend,NULL)


```


<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Number of Individuals Diagnosed and Referred for PDS per 10,000 Population (18+) </h2>
```{r trend-plot-pop}

 trends_pop_plot <- plot_trend_2(pds_trends_pop_data, pop_rate_10000, x ="Financial Year of Diagnosis", y = "Rate Per 10,000 Popuation", colours = phs_colours_46)

bscols(widths = 12,
  div(style = css(width="98%", height="300px"),
 trends_pop_plot)
)
```

```{r trend-table-pop}

rates_table_data <- pds_all_rates %>%
            pivot_wider(names_from = fy, values_from = pop_rate_10000) %>%
            mutate(key = paste0(geog,age_grp_2), .before = geog) %>% 
  rename(`Health Board/Integration Authority Area` = geog)

rates_table <- SharedData$new(rates_table_data, key = ~key, group = "pop")
            
  bscols(widths = 12,
       div(style = css(width="98%", height="430px", margin="15px"),
          DT::datatable(rates_table, rownames = FALSE,
              options = list(pageLength = 46,
                             scrollX = FALSE,
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,2)),
                                               list(className = 'dt-right', targets = 3:11)
                             ))) %>%
  DT::formatStyle(2, fontWeight = "bold"
                  )
            )
       )


```

### **Health Boards**

```{r dropdown-pop-hb}
pds_hb_pop_data <- SharedData$new(pds_all_rates %>% filter(geog == "Scotland" | grepl("NHS", geog)) %>% mutate(key = paste0(fy,age_grp_2), .before = geog),
                                  key = ~key,
                                 group = "grouphb")

data_filter_age_pop_hb <- filter_select(id = "pop_filter_age_grp_2_hb",
                                    label = "Select Age Group:",
                                    group = ~age_grp_2,
                                    sharedData = pds_hb_pop_data,
                                    multiple = FALSE
                                   )

data_filter_year_pop_hb <- filter_select(id = "pop_filter_year_hb",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = pds_hb_pop_data,
                                    multiple = FALSE
                                   )

bscols(widths = c(1,4,NA),NULL,
data_filter_year_pop_hb,NULL)
bscols(widths = c(1,4,NA),NULL,
data_filter_age_pop_hb,NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Number of Individuals Diagnosed and Referred for PDS per 10,000 Population (18+) by Health Board</h2>
```{r plot-hb-pop}
# pds_scot_pop_data <- SharedData$new(pds_scot_rates %>% mutate(key = paste0(fy,age_grp_2), .before = geog),
#                                     key = ~key, group = "grouphb")
 
 hb_rates_plot <- plot_bar_pop_rate_2(pds_hb_pop_data)
 
 bscols(widths = 12,
         div(style = css(width="98%", height="425px"),
  hb_rates_plot))

```

```{r table-hb-pop}

hb_table_pop_data <- left_join(pds_all_rates %>% filter(geog == "Scotland" | grepl("NHS", geog)) %>% 
  complete(nesting(geog, fy), age_grp_2, fill = list(pop_rate_10000 = 0)) %>% 
  mutate(key = paste0(fy,age_grp_2), .before = geog) %>% 
  select(key, geog, age_grp_2),

pds_all_rates %>% filter(geog == "Scotland" | grepl("NHS", geog)) %>%
  pivot_wider(names_from = fy, values_from = pop_rate_10000, values_fill = 0)) %>% 
  
  rename(`Health Board` = geog) %>% arrange(key)

hb_table_pop <- SharedData$new(hb_table_pop_data, key = ~key,
                               group = "grouphb")
       
hb_table_header <- htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(colspan = 2, '    '),
      th(rowspan = 2, "Health Board"),
      th(colspan = 4, ' '),
      th(colspan = 3, 'Financial Year of Diagnosis'),
      th(colspan = 3, ' '),
    ),
    tr(
      lapply(c(" "," "," ",unique(pds_all_rates$fy)), th)
    )
  )
))



bscols(widths = 12,
       div(style = css(width="98%", height="670px", margin="15px"),
          DT::datatable(hb_table_pop,
                        container = hb_table_header,
                        rownames = TRUE,
                        extensions = "FixedColumns",
              options = list(pageLength = 15,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = F, targets =c(0,1,3)),
                                                list(className = 'dt-right', targets = 4:12))
                             )) %>% 
          DT::formatStyle(2, fontWeight = "bold")
            )
       )

```
### **Integration Authority Areas**

```{r dropdown-pop-ijb}

pds_ijb_pop_data <- SharedData$new(pds_all_rates %>% filter(!grepl("NHS", geog)) %>% mutate(key = paste0(fy,age_grp_2), .before = geog),
                                  key = ~key, group = "groupijb")


data_filter_year_ijb <- filter_select(id = "pop_filter_year_ijb",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = pds_ijb_pop_data,
                                    multiple = FALSE
                                   )

data_filter_age_trend_ijb <- filter_select(id = "pop_filter_age_grp_2_ijb",
                                    label = "Select Age Group:",
                                    group = ~age_grp_2,
                                    sharedData = pds_ijb_pop_data,
                                    multiple = FALSE
                                   )


bscols(widths = c(1,4,NA),NULL,
data_filter_year_ijb,NULL)
bscols(widths = c(1,4,NA),NULL,
data_filter_age_trend_ijb,NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Number of Individuals Diagnosed and Referred for PDS per 10,000 Population (18+) by Integration Authority Area</h2>
```{r plot-ijb-pop}

ijb_rates_plot <- plot_bar_pop_rate_2(pds_ijb_pop_data, geogs = 31)

bscols(widths = 12,
        div(style = css(width="98%", height="425px"),
 ijb_rates_plot))

```

```{r table-ijb-pop}

ijb_table_pop_data <- left_join(pds_all_rates %>% filter(!grepl("NHS", geog)) %>%
  complete(nesting(geog, fy), age_grp_2, fill = list(pop_rate_10000 = 0)) %>%
  mutate(key = paste0(fy,age_grp_2), .before = geog) %>%
  select(key, geog, age_grp_2),

pds_all_rates %>% filter(!grepl("NHS", geog)) %>%
  pivot_wider(names_from = fy, values_from = pop_rate_10000, values_fill = 0)) %>%

  rename(`Integration Authority Area` = geog) %>% arrange(key)

ijb_table_pop <- SharedData$new(ijb_table_pop_data, key = ~key,
                               group = "groupijb")

ijb_table_header <- htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(colspan = 2, '    '),
      th(rowspan = 2, "Integration Authority Area"),
      th(colspan = 4, ' '),
      th(colspan = 3, 'Financial Year of Diagnosis'),
      th(colspan = 3, ' '),
    ),
    tr(
      lapply(c(" "," "," ",unique(pds_all_rates$fy)), th)
    )
  )
))

ijb_table_pop_data <- pds_all_rates %>% filter(!grepl("NHS", geog)) %>% 
   complete(nesting(geog, fy), age_grp_2, fill = list(pop_rate_10000 = 0))


bscols(widths = 12,
       div(style = css(width="98%", height="670px", margin="15px"),
          DT::datatable(ijb_table_pop,
                        container = ijb_table_header,
                        rownames = TRUE,
                        extensions = "FixedColumns",
              options = list(pageLength = 32,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = F, targets =c(0,1,3)),
                                                list(className = 'dt-right', targets = 4:12))
                             )) %>% 
          DT::formatStyle(2, fontWeight = "bold")
            )
       )

```

Trend Outcomes {.hidden}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### All Referrals - Outcomes by Financial Year 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***
<ul>
  <li>[All Referrals - Trend](#all-referrals---trends-rates)</li>
  <li>[All Referrals - Rates per 10,000 population](#pop-trend)</li>
  <li>[**All Referrals - Outcomes by Financial Year**](#trend-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**


Row {.tabset data-height=1240}
----------------------------------------------------------------------

### **Percentage of LDP Standard achieved**

```{r dropdown-met-ldp}
pds_met_rates <-
  pds_all %>% filter(age_grp_2 != "Unknown", ldp != "ongoing", fy != current_fy) %>% 
  group_by(geog, fy, ldp) %>% 
  summarise(referrals = sum(referrals)) %>% pivot_wider(names_from = ldp, values_from = referrals, values_fill = 0) %>% 
  mutate(perc_met = round(100*(complete + exempt)/(complete + exempt + fail), 1))

pds_met_rates$geog<- factor(pds_met_rates$geog, levels = unique(pds_met_rates$geog))

pds_met_rates_data <- SharedData$new(pds_met_rates)

data_filter_met_trend <- filter_select(id = "trend_filter_outcomes_met",
                                    label = "Select Health Board(s) or Integration Authority Area(s):",
                                    group = ~geog,
                                    sharedData = pds_met_rates_data
                                   )
bscols(widths = c(1,10,NA),NULL,
data_filter_met_trend,NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Percentage of people referred for post-diagnostic support where PDS met LDP Standard</h2>
```{r plot-med-ldp}
 trends_met_plot <- plot_trend_perc(pds_met_rates_data, perc_met, x ="Financial Year of Diagnosis", colours = phs_colours_46)

bscols(widths = 12,
        div(style = css(width="98%", height="385px"),
 trends_met_plot)
)

```


```{r trend-table-met}

pds_met_rates %>% select(geog, fy, perc_met) %>% 
            pivot_wider(names_from = fy, values_from = perc_met) %>%
            mutate(across(where(is.numeric), ~paste0(.,"%"))) %>% 
            rename(`Health Board/Integration Authority Area` = geog) %>%
            kable(align = c("l", rep("r", length(unique(pds_met_rates$fy))))) %>%
            kable_styling(full_width = TRUE) %>%
            column_spec(1, bold = TRUE) %>%
  # Add header above table
            add_header_above(
                    c(" " = 1,
                     "Financial Year of Diagnosis" = length(unique(pds_met_rates$fy)))) %>% 
  scroll_box(height = "670px")

```

### **Percentage of estimated diagnoses referred to PDS**

```{r dropdown-exp}
pds_exp_rates <- left_join(
bind_rows(pds_scot_totals, pds_hb_totals) %>% filter(fy != current_fy, age_grp_2 == "All") %>% 
            select(-age_grp_2),
exp %>% select(-health_board) %>% rename(geog = health_board_label)) %>% 
  mutate(exp_rate = round(100*total_referrals/diagnoses,1))

pds_exp_rates$geog<- factor(pds_exp_rates$geog, levels = unique(pds_exp_rates$geog))

pds_exp_rates_data <- SharedData$new(pds_exp_rates)

data_filter_exp_trend <- filter_select(id = "trend_filter_outcomes_exp",
                                    label = "Select Health Board(s):",
                                    group = ~geog,
                                    sharedData = pds_exp_rates_data
                                   )
bscols(widths = c(1,10,NA),NULL,
data_filter_exp_trend,NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Percentage of people estimated to be newly diagnosed with dementia who were referred for post-diagnostic support</h2>
```{r trend-plot-exp}

 trends_exp_plot <- plot_trend_perc(pds_exp_rates_data, exp_rate, x ="Financial Year of Diagnosis", colours = phs_colours_46)

bscols(widths = 12,
        div(style = css(width="98%", height="385px"),
 trends_exp_plot)
)
```

```{r trend-table-exp}

pds_exp_rates %>% select(geog, fy, exp_rate) %>% 
            pivot_wider(names_from = fy, values_from = exp_rate) %>%
            mutate(across(where(is.numeric), ~paste0(.,"%"))) %>% 
            rename(`Health Board` = geog) %>%
            kable(align = c("l", rep("r", length(unique(pds_exp_rates$fy))))) %>%
            kable_styling(full_width = TRUE) %>%
            column_spec(1, bold = TRUE) %>%
  # Add header above table
            add_header_above(
                    c(" " = 1,
                     "Financial Year of Diagnosis" = length(unique(pds_exp_rates$fy))))

```

```{js }
function filter_default() {
    document.getElementById("trend_filter_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue("NHS Ayrshire & Arran", false);

  document.getElementById("trend_filter_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("trend_filter_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("Aberdeen City", false);

  document.getElementById("trend_filter_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("trend_filter_age_grp_2").getElementsByClassName("selectized") 
  [0].selectize.setValue("All", false);

  document.getElementById("trend_filter_age_grp_2").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
 
   document.getElementById("trend_filter_pop_hb_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);
  
  document.getElementById("pop_filter_year_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("pop_filter_year_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("pop_filter_age_grp_2_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue("All", false);

  document.getElementById("pop_filter_age_grp_2_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("pop_filter_year_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("pop_filter_year_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("pop_filter_age_grp_2_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("All", false);

  document.getElementById("pop_filter_age_grp_2_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
    document.getElementById("trend_filter_outcomes_exp").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("trend_filter_outcomes_exp").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
    document.getElementById("trend_filter_outcomes_met").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("trend_filter_outcomes_met").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  
  }
  
  window.onload = filter_default;

```