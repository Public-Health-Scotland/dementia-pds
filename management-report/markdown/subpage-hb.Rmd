`r if_else(max_fy == sel_fy, paste0(hb, '{data-navmenu="Health Boards"}'), paste0(hb, " ", str_replace(sel_fy, "/", ""), ' {.hidden}'))`
=================================================

```{r summary figures, include=FALSE}

# Expected vs Referrals
ref <- sum(subpage_data$referrals)
exp_rate <- (ref / exp) * 100

# 12 Months Complete
num <- subpage_data %>% filter(ldp %in% c("complete", "exempt")) %>% {sum(.$referrals)}
den <- subpage_data %>% filter(ldp %in% c("complete", "exempt", "fail")) %>% {sum(.$referrals)}
pds_rate <- (num / den) * 100

complete_year <- if_else(max_fy == sel_fy & qt != 4, FALSE, TRUE)
```

Sidebar {.sidebar}
-----------------------------------------------------------------------

### `r hb`
#### Financial Year `r sel_fy`

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

Select Financial Year

<!-- For some reason need '-2' on end of 1819 links - check why this is -->
|     `r paste0("[2019/20](#", hb %>% tolower() %>% str_replace_all(" &", "") %>% str_replace_all(" ", "-"), "-3)")`
|     `r paste0("[2018/19](#", hb %>% tolower() %>% str_replace_all(" &", "") %>% str_replace_all(" ", "-"), "-", "201819)")`
|     `r paste0("[2017/18](#", hb %>% tolower() %>% str_replace_all(" &", "") %>% str_replace_all(" ", "-"), "-", "201718)")`
|     `r paste0("[2016/17](#", hb %>% tolower() %>% str_replace_all(" &", "") %>% str_replace_all(" ", "-"), "-", "201617)")`

***

<!-- Reword this and try and force to bottom of sidebar -->
Please get in touch with any comments, suggestions and feedback: [NSS.ISDDementiaPDS@nhs.net](mailto:NSS.ISDDementiaPDS@nhs.net)


Row
----------------------------------------------------------------------

### **Note**

`r if_else(hb == "NHS Greater Glasgow & Clyde", "Data for some IJBs in NHS Greater Glasgow & Clyde are currently unavailable and therefore board level figures should be treated with caution.", "")`

These reports are an ongoing development following the implementation of the revised [Dementia PDS dataset](https://www.isdscotland.org/Health-Topics/Mental-Health/Dementia-Post-diagnostic-Support/_docs/Dementia-PDS-Definitions-and-Recording-Guidance.pdf) effective 01 April 2019. As such, they are currently marked as **DRAFT** and may be subject to change in future versions.


Row `r if(complete_year == FALSE)"{.hidden}"`
----------------------------------------------------------------------

`r ifelse(complete_year == TRUE, "### Expected Value Box", "")`
```{r Expected Value Box, include = complete_year}
valueBox(paste0(round_half_up(exp_rate, 1), "%"), 
         icon = "fa-percent",
         caption = glue("The percentage of the expected number of new ",
                        "dementia diagnoses ({exp}) who were actually ",
                        "referred to post diagnostic support ({ref})."))
```

`r ifelse(complete_year == TRUE, "### <span style='color:CornflowerBlue'>**How is this figure calculated?**</span>", "")`

`r ifelse(complete_year == TRUE, glue("The expected number of new dementia diagnoses is <span style='color:CornflowerBlue'>**{exp}**</span>."), "")` 

`r ifelse(complete_year == TRUE, glue("The number of referrals to post diagnostic support is <span style='color:CornflowerBlue'>**{ref}**</span>."), "")`


Row `r if(complete_year == FALSE)"{.hidden}"`
---------------------------------------------------------------------

`r ifelse(complete_year == TRUE, "### 12 Months Value Box", "")`
```{r 12 Months Value Box, include = complete_year}
valueBox(paste0(round_half_up(pds_rate, 1), "%"), 
         icon = "fa-percent",
         caption = glue("of those referred for post diagnostic support ",
                        "received 12 months of support."))
```

`r ifelse(complete_year == TRUE, "### <span style='color:CornflowerBlue'>**How is this figure calculated?**</span>", "")`

`r ifelse(complete_year == TRUE, glue("Of the {ref} referrals to post diagnostic support, {ref - den} are still undergoing PDS. Of the remaining {den}, {num} have met the LDP standard. This includes those who have completed 12 months of PDS and those who are exempt."), "")`


Row {data-height=450}
----------------------------------------------------------------------

### **Number of Individuals relating to LDP Standard**

For more information regarding how the LDP Standard is calculated, see the [methodology](#methodology) page.


```{r ldp-table}

subpage_data %>%
  group_by(ijb = hb, ldp) %>%
  summarise(referrals = sum(referrals)) %>%
  bind_rows(subpage_data %>%
              group_by(ijb = hb, ldp = "Total") %>%
              summarise(referrals = sum(referrals)),
            subpage_data %>%
              group_by(ijb, ldp) %>%
              summarise(referrals = sum(referrals)),
            subpage_data %>%
              group_by(ijb, ldp = "Total") %>%
              summarise(referrals = sum(referrals))) %>%
  ungroup() %>%
  complete(ijb, ldp = c("complete", "fail", "exempt", "ongoing", "Total"),
           fill = list(referrals = 0)) %>%
  mutate(ldp = 
           case_when(
             ldp == "complete" ~ "Standard Met",
             ldp == "fail" ~ "Standard Not Met",
             ldp == "ongoing" ~ "PDS Ongoing",
             TRUE ~ str_to_title(ldp)
           )) %>%
  pivot_wider(names_from = ldp, values_from = referrals) %>%
  mutate_all(~ replace_na(., 0)) %>%
  select(ijb, "Standard Met", "Standard Not Met", "PDS Ongoing", "Exempt", "Total") %>%
  arrange(match(ijb, c(subpage_data$health_board, unique(subpage_data$ijb)))) %>%
  kable(col.names = c("", "Standard Met", "Standard Not Met", "PDS Ongoing", "Exempt", "Total")) %>%
  kable_styling(full_width = FALSE)
```


### **Number of Individuals Diagnosed and Referred for PDS** {data-width=800}

```{r Referrals Plot}

plot_referrals(subpage_data, 
               scotland = FALSE,
               quarter = ifelse(max_fy == sel_fy, qt, NA))

```

