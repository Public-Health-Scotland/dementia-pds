---
title: "ADDITIONAL ANALYSIS DRAFT"
output: 
  flexdashboard::flex_dashboard:
    logo: phs-logo.png
    orientation: rows
    vertical_layout: scroll
---

```{r load-setup, include=FALSE}
source(here::here("code", "00_setup-environment.R"))
library(crosstalk) # for drop down menus
library(phsstyles)
library(htmltools)

# Write numbers with thousands separator
knit_hooks$set(inline = function(x){
  if(!is.character(x)){prettyNum(x, big.mark=",")}else{x}
})
```

---
date: "`r paste('Data as at', format(end_date, '%d %B %Y'))`"
---

```{r setup, include=FALSE}

# Load functions
walk(dir(here::here("functions"), full.names = TRUE), source)


# Load PDS data
pds <- read_rds(get_mi_data_path("final_data", ext = "rds", test_output = test_output)) %>% 
  
  # Remove codes from board and IJB
  mutate(health_board = str_sub(health_board, 3, -1),
         ijb          = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))

# Load expected diagnoses reference file
exp <- read_csv(get_exp_diagnoses_path())


# Load error summary
err <- read_rds(get_mi_data_path("error_data", ext = "rds", test_output = test_output)) %>% 

  mutate(ijb = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))

# calculate referrals for Scotland and health boards
pds_ijb <- pds %>% arrange(ijb)

pds_ijb %<>% rename(geog = ijb) 

pds_ijb$geog<- factor(pds_ijb$geog, levels = unique(pds_ijb$geog))

pds_scot <- pds %>% group_by(health_board = "Scotland", ijb = "Scotland", fy, month, ldp_full, ldp, age_grp_2, age_grp, simd, sex) %>%  summarise(referrals = sum(referrals), .groups = "drop")

pds_scot %<>% rename(geog = ijb) 

pds_scot$geog<- factor(pds_scot$geog, levels = unique(pds_scot$geog))

pds_hb <- pds %>% group_by(health_board, fy, month, ldp_full, ldp, age_grp_2, age_grp, simd, sex) %>% 
  summarise(referrals = sum(referrals), .groups = "drop") %>% mutate(ijb = health_board, .before = fy)

pds_hb %<>% rename(geog = ijb) 

pds_hb$geog<- factor(pds_hb$geog, levels = unique(pds_hb$geog))

# combine data for ijb, hb and Scotland
pds_all <- bind_rows(pds_scot, pds_hb, pds_ijb)

pds_all$geog<- factor(pds_all$geog, levels = unique(pds_all$geog))

#get totals for all geogs, hbs, ijbs, scotland
pds_all_totals <- pds_all %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_ijb_totals <- pds_ijb %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_hb_totals <- pds_hb %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))

pds_scot_totals <- pds_scot %>% group_by(geog, fy, age_grp_2 = "All") %>% summarise(total_referrals = sum(referrals))


#get totals for all geogs, hbs, ijbs, scotland with LARGE AGE GROUPS
pds_all_totals_2 <- bind_rows(pds_all_totals,
  pds_all %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_all_totals_2$age_grp_2<- factor(pds_all_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))

pds_ijb_totals_2 <- bind_rows(pds_ijb_totals,
    pds_ijb %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_ijb_totals_2$age_grp_2<- factor(pds_ijb_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))


pds_hb_totals_2 <- bind_rows(pds_hb_totals,
    pds_hb %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_hb_totals_2$age_grp_2<- factor(pds_hb_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))


pds_scot_totals_2 <- bind_rows(pds_scot_totals,
    pds_scot %>% filter(age_grp_2 != "Unknown") %>% group_by(geog, fy, age_grp_2) %>% summarise(total_referrals = sum(referrals))
)

pds_scot_totals_2$age_grp_2<- factor(pds_scot_totals_2$age_grp_2, levels = c("All", "65+", "64 and Under"))



#create year lists
provisional_year <- paste0(as.numeric(substr(last(finalised_years),1,4)) + 1,
                           "/", as.numeric(substr(last(finalised_years),6,7)) + 1)

current_fy <- paste0(substr(fy,1,4),
                           "/", as.numeric(substr(fy,3,4)) + 1)

last_full_year <- if_else(qt == 4, current_fy, paste0(as.numeric(substr(fy,1,4)) - 1,
                           "/", as.numeric(substr(fy,3,4))))

all_years <- unique(pds_all$fy)

if(qt == 4){full_years = all_years}else{full_years = all_years[-length(all_years)]}


```
<!-- delete all of above when finished testing -->


```{r data-setup-additional, include=FALSE}
#prepare subtype of dementia data
subtype_data <- read_rds(get_mi_data_path("subtype_data", ext = "rds", test_output = test_output))

pds_all_subtype <- subtype_data %>% filter(age_grp_2 == "All") %>% 
  select(geog, fy, subtype, total_referrals)

pds_all_subtype$geog <- factor(pds_all_subtype$geog, levels = unique(pds_all$geog))

pds_all_subtype$subtype <- factor(pds_all_subtype$subtype, levels = c(unique(pds_all_subtype$subtype)[-6],unique(pds_all_subtype$subtype)[6]))

ldp_all_subtype <- subtype_data %>% filter(fy %in% full_years, age_grp_2 == "All") %>%
  select(-health_board, -age_grp_2, -total_referrals) %>% 
  complete(nesting(geog, fy), subtype, fill = list(perc_met = NA))

ldp_all_subtype <- left_join(ldp_all_subtype,
ldp_all_subtype %>% filter(geog == "Scotland") %>% select(fy, subtype, perc_met) %>% 
  rename(scot_perc_met = perc_met))

ldp_all_subtype$geog<- factor(ldp_all_subtype$geog, levels = unique(pds_all$geog))

ldp_all_subtype$subtype <- factor(ldp_all_subtype$subtype, levels = c(unique(ldp_all_subtype$subtype)[-6],unique(ldp_all_subtype$subtype)[6]))

# prepare stage of illness data
stage_data <- read_rds(get_mi_data_path("stage_data", ext = "rds", test_output = test_output))

pds_all_stage <- stage_data %>% filter(age_grp_2 == "All") %>% 
  select(geog, fy, stage, total_referrals)

pds_all_stage$geog <- factor(pds_all_stage$geog, levels = unique(pds_all$geog))

pds_all_stage$stage <- factor(pds_all_stage$stage, 
    levels = c(unique(pds_all_stage$stage)[1],unique(pds_all_stage$stage)[3],unique(pds_all_stage$stage)[2],unique(pds_all_stage$stage)[5],unique(pds_all_stage$stage)[4]))
                              
ldp_all_stage <- stage_data %>% filter(fy %in% full_years, age_grp_2 == "All") %>%
  select(-health_board, -age_grp_2, -total_referrals) %>% 
  complete(nesting(geog, fy), stage, fill = list(perc_met = NA))

ldp_all_stage <- left_join(ldp_all_stage,
ldp_all_stage %>% filter(geog == "Scotland") %>% select(fy, stage, perc_met) %>% 
  rename(scot_perc_met = perc_met))

ldp_all_stage$geog<- factor(ldp_all_stage$geog, levels = unique(pds_all$geog))

ldp_all_stage$stage <- factor(ldp_all_stage$stage, 
    levels = c(unique(ldp_all_stage$stage)[1],unique(ldp_all_stage$stage)[3],unique(ldp_all_stage$stage)[2],unique(ldp_all_stage$stage)[5],unique(ldp_all_stage$stage)[4]))
                              

#prepare model of care data
model_data <- read_rds(get_mi_data_path("model_data", ext = "rds", test_output = test_output))

pds_all_model <- model_data %>% filter(age_grp_2 == "All", sex == "All", simd == "All") %>% 
  select(geog, fy, model, total_referrals)

pds_all_model$geog <- factor(pds_all_model$geog, levels = unique(pds_all$geog))

pds_all_model$model <- factor(pds_all_model$model, 
    levels = c(unique(pds_all_model$model)[-1],unique(pds_all_model$model)[1]))
                              
ldp_all_model <- model_data %>% filter(fy %in% full_years, age_grp_2 == "All", sex == "All", simd == "All") %>%
  select(-health_board, -age_grp_2, -total_referrals) %>% 
  complete(nesting(geog, fy), model, fill = list(perc_met = NA))

ldp_all_model <- left_join(ldp_all_model,
ldp_all_model %>% filter(geog == "Scotland") %>% select(fy, model, perc_met) %>% 
  rename(scot_perc_met = perc_met))

ldp_all_model$geog<- factor(ldp_all_model$geog, levels = unique(pds_all$geog))

ldp_all_model$model <- factor(ldp_all_model$model, 
    levels = c(unique(ldp_all_model$model)[-1],unique(ldp_all_model$model)[1]))

#load uptake decision data
uptake_data <- read_rds(get_mi_data_path("uptake_data", ext = "rds", test_output = test_output))

#load carer's support data
carer_data <- read_rds(get_mi_data_path("carer_data", ext = "rds", test_output = test_output))

#legend tibble
legend_data <- tibble(
  geog = c("Selected Health Board/Integration Authority Area", "Scotland"),
  x = c(1,2),
  y = c(0,0))

legend_data$geog <- factor(legend_data$geog, levels = unique(legend_data$geog))

# total referrals for tables
hb_totals_table <- bind_rows(pds_scot_totals, pds_hb_totals) %>%
  mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% pivot_wider(names_from = geog, values_from = total_referrals)

ijb_totals_table <- bind_rows(pds_scot_totals, pds_ijb_totals)  %>%
  mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% pivot_wider(names_from = geog, values_from = total_referrals)

all_totals_table_2 <- bind_rows(

bind_rows(pds_scot_totals_2, pds_ijb_totals_2) %>% group_by(geog, fy = "All", age_grp_2) %>% 
  summarise(`All referrals` = sum(total_referrals), .groups = "drop") %>% 
  mutate(geog_type = "Integration Authority Areas",
         key = paste0(age_grp_2,geog_type), .before= geog) %>% select(-fy),

bind_rows(pds_scot_totals_2, pds_hb_totals_2) %>% group_by(geog, fy = "All", age_grp_2) %>% 
  summarise(`All referrals` = sum(total_referrals), .groups = "drop") %>% 
  mutate(geog_type = "Health Boards",
         key = paste0(age_grp_2,geog_type), .before= geog) %>% select(-fy)
)


 
```

Subtype of Dementia {data-navmenu="Additional Information"}
=================================================

Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Subtype of Dementia - Proportions 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[**Proportions**](#subtype-of-dementia)</li>
  <li>[Outcomes](#subtype-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**


Row {.tabset data-height=1250}
----------------------------------------------------------------------

### **Integration Authority Areas**
```{r dropdown-prop-subtype-ijb}
pds_subtype_data_ijb <- SharedData$new(pds_all_subtype %>% filter(!grepl("NHS", geog)), key = ~fy, group = "subtype_prop_ijb")

data_filter_subtype_prop <- filter_select(id = "trend_filter_subtype_prop_ijb",
                                    label = "Select Financial Year of Diagnosis:",
                                    group = ~fy,
                                    sharedData = pds_subtype_data_ijb,
                                    multiple = FALSE
                                   )
bscols(widths = c(1,5,NA),
       NULL,
       data_filter_subtype_prop,
       NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Proportion of Referrals by Subtype of Dementia and Integration Authority Area</h2>
```{r plot-prop-subtype-legend-ijb}
bscols(widths = 12,
div(style=css(marginBottom="-23px",height="95px", width="90%"), plot_prop_legend(pds_all_subtype %>% filter(geog == "Scotland"), measure = subtype, colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#1E7F84", "#6B5C85", "#83BB26", "#C73918")))
)
```

```{r plot-prop-subtype-ijb}
bscols(widths = 12,
  div(style = css(width="98%", height="400px"),
      plot_prop(pds_subtype_data_ijb, measure = subtype, measure_text = "Subtype of Dementia: ", xlabel = "Integration Authority Area", colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#1E7F84", "#6B5C85", "#83BB26", "#C73918"))
)
)

```

```{r table-prop-subtype-ijb}

pds_prop_table_data_ijb <- bind_rows(
  
  ijb_totals_table %>% mutate(age_grp_2 = "All referrals",
                              across(everything(), as.character)) %>% rename(`Subtype of Dementia` = age_grp_2),
  
  pds_all_subtype %>%
  arrange(subtype) %>% filter(!grepl("NHS", geog)) %>% group_by(geog, fy) %>% 
  mutate(perc_referrals = paste0(round((total_referrals/sum(total_referrals))*100,0),"%")) %>% ungroup() %>%   select(-total_referrals) %>% 
  pivot_wider(names_from = geog, values_from = perc_referrals) %>%
             rename(`Subtype of Dementia` = subtype))

pds_prop_table_data_ijb[is.na(pds_prop_table_data_ijb)] <- "0%"


pds_prop_table_ijb <- SharedData$new(pds_prop_table_data_ijb, key = ~fy, group = "subtype_prop_ijb")

bscols(widths = 12,
       div(style = css(width="98%", height="580px", margin="15px"),
          DT::datatable(pds_prop_table_ijb, rownames = FALSE, extensions = "FixedColumns",
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right', targets = 2:33)
                             ))) %>%
  DT::formatStyle(2, fontWeight = "bold")
            )
       )




```

### **Health Boards**

```{r dropdown-prop-subtype-hb}
pds_subtype_data_hb <- SharedData$new(pds_all_subtype %>% filter(grepl("NHS", geog) | geog == "Scotland"), key = ~fy, group = "subtype_prop_hb")

data_filter_subtype_prop <- filter_select(id = "trend_filter_subtype_prop_hb",
                                    label = "Select Financial Year of Diagnosis:",
                                    group = ~fy,
                                    sharedData = pds_subtype_data_hb,
                                    multiple = FALSE
                                   )
bscols(widths = c(1,5,NA),
       NULL,
       data_filter_subtype_prop,
       NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px">Proportion of Referrals by Subtype of Dementia and Health Board </h2>
```{r plot-prop-subtype-legend-hb}
bscols(widths = 12,
div(style=css(marginBottom="-23px",height="95px", width="90%"), plot_prop_legend(pds_all_subtype %>% filter(geog == "Scotland"), measure = subtype, colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#1E7F84", "#6B5C85", "#83BB26", "#C73918"))
    ))
```

```{r plot-prop-subtype-hb}
bscols(widths = 12,
  div(style = css(width="98%", height="400px"),
      plot_prop(pds_subtype_data_hb, measure = subtype, measure_text = "Subtype of Dementia: ", xlabel = "Health Board", colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#1E7F84", "#6B5C85", "#83BB26", "#C73918"))
)
)

```

```{r table-prop-subtype-hb}

pds_prop_table_data_hb <- bind_rows(
  
  hb_totals_table %>% mutate(age_grp_2 = "All referrals",
                              across(everything(), as.character)) %>% rename(`Subtype of Dementia` = age_grp_2),
  
  pds_all_subtype %>% 
  arrange(subtype) %>% filter(geog == "Scotland" | grepl("NHS", geog)) %>%
  group_by(geog, fy) %>% 
    mutate(perc_referrals = paste0(round((total_referrals/sum(total_referrals))*100,0),"%")) %>%
    ungroup() %>% 
  select(-total_referrals) %>% 
  pivot_wider(names_from = geog, values_from = perc_referrals) %>%
    rename(`Subtype of Dementia` = subtype))

pds_prop_table_data_hb[is.na(pds_prop_table_data_hb)] <- "0%"


pds_prop_table_hb <- SharedData$new(pds_prop_table_data_hb, key = ~fy, group = "subtype_prop_hb")

bscols(widths = 12,
       div(style = css(width="98%", height="600px", margin="15px", marginTop="0px"),
          DT::datatable(pds_prop_table_hb, rownames = FALSE, extensions = "FixedColumns",
              options = list(psubtypeLength = 10,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right', targets = 2:16)
                             ))) %>%
  DT::formatStyle(2, fontWeight = "bold")
            )
       )




```

Subtype Outcomes {.hidden}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Subtype of Dementia - Outcomes 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Proportions](#subtype-of-dementia)</li>
  <li>[**Outcomes**](#subtype-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**

Row {data-height=1220}
----------------------------------------------------------------------

### **Trend**

```{r dropdown-ldp-subtype}

ldp_all_subtype_data <- SharedData$new(ldp_all_subtype, key = ~geog, group = "ldp_subtype")

data_filter_ldp_subtype <- filter_select(id = "filter_ldp_subtype",
                                    label = "Select Health Board or Integration Authority Area:",
                                    group = ~geog,
                                    sharedData = ldp_all_subtype_data,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_ldp_subtype,
       NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 15px">Percentage of referrals who received a minimum of one year’s PDS by Subtype of Dementia and Financial Year</h2>
```{r plot-ldp-subtype-legend}
bscols(widths = 12,
       div(style = css(height="30px"),
plot_ldp_line_legend_1(legend_data)),NULL
)

```

```{r plot-ldp-subtype}
bscols(widths = 12,
  div(style = css(width="98%", height="450px"),
plot_ldp_line(ldp_all_subtype_data, measure = subtype, measure_text = "Subtype of Dementia: ", ncol = 4, nrow = 2, colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#1E7F84", "#6B5C85", "#83BB26", "#C73918"))
)
)

```


```{r table-ldp-subtype}

ldp_subtype_trend <- ldp_all_subtype %>% filter(!is.na(perc_met)) %>%
  select(geog, fy, subtype, perc_met) %>%
   mutate(perc_met = paste0(perc_met, "%")) %>% 
  pivot_wider(names_from = fy, values_from = perc_met) %>%
  mutate(type = "% Met Standard/Exempt", .before = `2016/17`)
  
trend_subtype_totals <- pds_all_subtype %>% filter(fy %in% full_years, total_referrals != 0) %>%
  mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = total_referrals, values_fill = "0") %>% 
    mutate(type = "Number of Referrals", .before = `2016/17`)


ldp_subtype_table_data <- bind_rows(trend_subtype_totals, ldp_subtype_trend) %>% arrange(geog, subtype) %>% 
            mutate(across(everything(), ~replace_na(.x, "-"))) %>% 
  mutate(subtype = if_else(type == "% Met Standard/Exempt", " ", subtype)) %>% 
   rename(`Subtype of Dementia` = subtype) %>% 
  rename(" " = "type")
            

ldp_subtype_table <- SharedData$new(ldp_subtype_table_data, key = ~geog, group = "ldp_subtype")


bscols(widths = 12,
       div(style = css(width="97%", height="510px", margin="20px"),
DT::datatable(ldp_subtype_table, rownames = FALSE,
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right',
                                                    targets = 3:(length(full_years)+2))
                                               ))) %>%
           DT::formatStyle(2:3, fontWeight = "bold") 
        )
     )




```

Stage of Illness {data-navmenu="Additional Information"}
=====================================

Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Clinical Impression of Stage of Illness - Proportions 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[**Proportions**](#stage-of-illness)</li>
  <li>[Outcomes](#stage-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**


Row {.tabset data-height=1100}
----------------------------------------------------------------------

### **Integration Authority Areas**
```{r dropdown-prop-stage-ijb}
pds_stage_data_ijb <- SharedData$new(pds_all_stage %>% filter(!grepl("NHS", geog)), key = ~fy, group = "stage_prop_ijb")

data_filter_stage_prop <- filter_select(id = "trend_filter_stage_prop_ijb",
                                    label = "Select Financial Year of Diagnosis:",
                                    group = ~fy,
                                    sharedData = pds_stage_data_ijb,
                                    multiple = FALSE
                                   )
bscols(widths = c(1,5,NA),
       NULL,
       data_filter_stage_prop,
       NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Proportion of Referrals by Clinical Impression of Stage of Illness and Integration Authority Area</h2>
```{r plot-prop-stage-legend-ijb}

bscols(widths = 12,
div(style=css(marginBottom="-20px",height="70px"), plot_prop_legend(pds_all_stage %>% filter(geog == "Scotland"), measure = stage, colours = c("#3F3685", "#9B4393", "#0078D4", "#83BB26", "#C73918"))
    ))

```


```{r plot-prop-stage-ijb}
bscols(widths = 12,
  div(style = css(width="98%", height="400px"),
      plot_prop(pds_stage_data_ijb, measure = stage, measure_text = "Stage of Illness: ", xlabel = "Integration Authority Area", colours = c("#3F3685", "#9B4393", "#0078D4", "#83BB26", "#C73918"))
  )
)

```


```{r table-prop-stage-ijb}

pds_prop_stage_table_data_ijb <- bind_rows(
  
  ijb_totals_table %>% mutate(age_grp_2 = "All referrals",
                              across(everything(), as.character)) %>% rename(`Stage of Illness` = age_grp_2),
  
  pds_all_stage %>% filter(!grepl("NHS", geog)) %>% 
arrange(stage) %>% group_by(geog, fy) %>% 
  mutate(perc_referrals = paste0(round((total_referrals/sum(total_referrals))*100,0),"%")) %>% ungroup() %>%   select(-total_referrals) %>% 
  pivot_wider(names_from = geog, values_from = perc_referrals) %>%
             rename(`Stage of Illness` = stage))

pds_prop_stage_table_data_ijb[is.na(pds_prop_stage_table_data_ijb)] <- "0%"


pds_prop_stage_table_ijb <- SharedData$new(pds_prop_stage_table_data_ijb, key = ~fy, group = "stage_prop_ijb")

bscols(widths = 12,
       div(style = css(width="98%", height="440px", margin="15px"),
          DT::datatable(pds_prop_stage_table_ijb, rownames = FALSE, extensions = "FixedColumns",
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right', targets = 2:33)
                             ))) %>%
  DT::formatStyle(2, fontWeight = "bold")
            )
       )




```

### **Health Boards**

```{r dropdown-prop-stage-hb}
pds_stage_data_hb <- SharedData$new(pds_all_stage %>% filter(geog == "Scotland" | grepl("NHS", geog)),
                                   key = ~fy, group = "stage_prop_hb")

data_filter_stage_prop <- filter_select(id = "trend_filter_stage_prop_hb",
                                    label = "Select Financial Year of Diagnosis:",
                                    group = ~fy,
                                    sharedData = pds_stage_data_hb,
                                    multiple = FALSE
                                   )
bscols(widths = c(1,5,NA),
       NULL,
       data_filter_stage_prop,
       NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Proportion of Referrals by Clinical Impression of Stage of Illness and Health Board </h2>
```{r plot-prop-stage-legend-hb}

bscols(widths = 12,
div(style=css(marginBottom="-20px",height="70px"), plot_prop_legend(pds_all_stage %>% filter(geog == "Scotland"), measure = stage, colours = c("#3F3685", "#9B4393", "#0078D4", "#83BB26", "#C73918"))
    ))

```


```{r plot-prop-stage-hb}
bscols(widths = 12,
  div(style = css(width="98%", height="400px"),
      plot_prop(pds_stage_data_hb, measure = stage, measure_text = "Stage of Illness: ", xlabel = "Health Board", colours = c("#3F3685", "#9B4393", "#0078D4", "#83BB26", "#C73918"))
  )
)

```


```{r table-prop-stage-hb}

pds_prop_stage_table_data_hb <- bind_rows(
  
  hb_totals_table %>% mutate(age_grp_2 = "All referrals",
                              across(everything(), as.character)) %>% rename(`Stage of Illness` = age_grp_2),
  
  pds_all_stage %>% filter(geog == "Scotland" | grepl("NHS", geog)) %>%
  arrange(stage) %>% 
  group_by(geog, fy) %>% 
    mutate(perc_referrals = paste0(round((total_referrals/sum(total_referrals))*100,0),"%")) %>%
    ungroup() %>% 
  select(-total_referrals) %>% 
  pivot_wider(names_from = geog, values_from = perc_referrals) %>%
    rename(`Stage of Illness` = stage))

pds_prop_stage_table_data_hb[is.na(pds_prop_stage_table_data_hb)] <- "0%"


pds_prop_stage_table_hb <- SharedData$new(pds_prop_stage_table_data_hb, key = ~fy, group = "stage_prop_hb")

bscols(widths = 12,
       div(style = css(width="98%", height="460px", margin="15px", marginTop="0px"),
          DT::datatable(pds_prop_stage_table_hb, rownames = FALSE, extensions = "FixedColumns",
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right', targets = 2:16)
                             ))) %>%
  DT::formatStyle(2, fontWeight = "bold"#, padding = "4px"
                  )
            )
       )




```

Stage Outcomes {.hidden}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Clinical Impression of Stage of Illness - Outcomes 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Proportions](#stage-of-illness)</li>
  <li>[**Outcomes**](#stage-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**

Row {data-height=1030}
----------------------------------------------------------------------

### **Trend**

```{r dropdown-ldp-stage}

ldp_all_stage_data <- SharedData$new(ldp_all_stage %>% filter(fy %in% full_years), key = ~geog, group = "ldp_stage")

data_filter_ldp_stage <- filter_select(id = "filter_ldp_stage",
                                    label = "Select Health Board or Integration Authority Area:",
                                    group = ~geog,
                                    sharedData = ldp_all_stage_data,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_ldp_stage,
       NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 20px">Percentage of referrals who received a minimum of one year’s PDS by Clinical Impression of Stage of Illness and Financial Year </h2>
```{r plot-ldp-stage-legend}
bscols(widths = 12,
div(style=css(height="30px"),
plot_ldp_line_legend_1(legend_data)),NULL
)

```

```{r plot-ldp-stage}
bscols(widths = 12,
  div(style = css(width="98%", height="350px"),
plot_ldp_line(ldp_all_stage_data, measure = stage, measure_text = "Stage of Illness: ", colours = c("#3F3685", "#9B4393", "#0078D4", "#83BB26", "#C73918"))
)
)

# bscols(widths = 12,
#   div(style = css(width="98%", height="385px"),
# plot_ldp_stage(ldp_all_stage_data))
# )

```


```{r table-ldp-stage}

ldp_stage_trend <- ldp_all_stage %>% filter(!is.na(perc_met)) %>%
  select(geog, fy, stage, perc_met) %>%
   mutate(perc_met = paste0(perc_met, "%")) %>% 
  pivot_wider(names_from = fy, values_from = perc_met) %>%
  mutate(type = "% Met Standard/Exempt", .before = `2016/17`)
  
trend_stage_totals <- pds_all_stage %>% filter(fy %in% full_years, total_referrals != 0) %>%
  mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = total_referrals, values_fill = "0") %>% 
    mutate(type = "Number of Referrals", .before = `2016/17`)


ldp_stage_table_data <- bind_rows(trend_stage_totals, ldp_stage_trend) %>% arrange(geog, stage) %>% 
            mutate(across(everything(), ~replace_na(.x, "-"))) %>% 
  mutate(stage = if_else(type == "% Met Standard/Exempt", " ", stage)) %>% 
   rename(`Stage of Illness` = stage) %>% 
  rename(" " = "type")
            

ldp_stage_table <- SharedData$new(ldp_stage_table_data, key = ~geog, group = "ldp_stage")


bscols(widths = 12,
       div(style = css(width="97%", height="430px", margin="20px"),
DT::datatable(ldp_stage_table, rownames = FALSE,
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right',
                                                    targets = 3:(length(full_years)+2))
                                               ))) %>%
           DT::formatStyle(2:3, fontWeight = "bold")
        )
     )



```

Model of Care {data-navmenu="Additional Information"}
=====================================

Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Model of Care - Proportions 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[**Proportions**](#model-of-care)</li>
  <li>[Outcomes](#model-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**


Row {.tabset data-height=1200}
----------------------------------------------------------------------

### **Integration Authority Areas**
```{r dropdown-prop-model-ijb}
pds_model_data_ijb <- SharedData$new(pds_all_model %>% filter(!grepl("NHS", geog)), key = ~fy, group = "model_prop_ijb")

data_filter_model_prop <- filter_select(id = "trend_filter_model_prop_ijb",
                                    label = "Select Financial Year of Diagnosis:",
                                    group = ~fy,
                                    sharedData = pds_model_data_ijb,
                                    multiple = FALSE
                                   )
bscols(widths = c(1,5,NA),
       NULL,
       data_filter_model_prop,
       NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Proportion of Referrals by Model of Care and Integration Authority Area</h2>
```{r plot-prop-model-legend-ijb}
bscols(widths = 12,
div(style=css(marginBottom="-23px",height="95px", width="90%", marginLeft="35px"), plot_prop_legend(pds_all_model %>% filter(geog == "Scotland"), measure = model, colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#83BB26", "#C73918"))
    ))

```


```{r plot-prop-model-ijb}
bscols(widths = 12,
  div(style = css(width="98%", height="400px"),
      plot_prop(pds_model_data_ijb, measure = model, measure_text = "Model of Care: ", xlabel = "Integration Authority Area", colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#83BB26", "#C73918"))
)
)

```


```{r table-prop-model-ijb}

pds_prop_model_table_data_ijb <- bind_rows(
  
  ijb_totals_table %>% mutate(age_grp_2 = "All referrals",
                              across(everything(), as.character)) %>% rename(`Model of Care` = age_grp_2),
  
  pds_all_model %>%
  arrange(model) %>% filter(!grepl("NHS", geog)) %>% group_by(geog, fy) %>% 
  mutate(perc_referrals = paste0(round((total_referrals/sum(total_referrals))*100,0),"%")) %>% ungroup() %>%   select(-total_referrals) %>% 
  pivot_wider(names_from = geog, values_from = perc_referrals) %>%
             rename(`Model of Care` = model))

pds_prop_model_table_data_ijb[is.na(pds_prop_model_table_data_ijb)] <- "0%"


pds_prop_model_table_ijb <- SharedData$new(pds_prop_model_table_data_ijb, key = ~fy, group = "model_prop_ijb")

bscols(widths = 12,
       div(style = css(width="98%", height="520px", margin="15px"),
          DT::datatable(pds_prop_model_table_ijb, rownames = FALSE, extensions = "FixedColumns",
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right', targets = 2:33)
                             ))) %>%
  DT::formatStyle(2, fontWeight = "bold")
  
            )
       )




```

### **Health Boards**

```{r dropdown-prop-model-hb}
pds_model_data_hb <- SharedData$new(pds_all_model %>% filter(geog == "Scotland" | grepl("NHS", geog)),
                                   key = ~fy, group = "model_prop_hb")

data_filter_model_prop <- filter_select(id = "trend_filter_model_prop_hb",
                                    label = "Select Financial Year of Diagnosis:",
                                    group = ~fy,
                                    sharedData = pds_model_data_hb,
                                    multiple = FALSE
                                   )
bscols(widths = c(1,5,NA),
       NULL,
       data_filter_model_prop,
       NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Proportion of Referrals by Model of Care and Health Board </h2>
```{r plot-prop-model-legend-hb}
bscols(widths = 12,
div(style=css(marginBottom="-23px",height="95px", width="90%", marginLeft="35px"), plot_prop_legend(pds_all_model %>% filter(geog == "Scotland"), measure = model, colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#83BB26", "#C73918"))
    ))


```


```{r plot-prop-model-hb}
bscols(widths = 12,
  div(style = css(width="98%", height="400px"),
      plot_prop(pds_model_data_hb, measure = model, measure_text = "Model of Care: ", xlabel = "Health Board", colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#83BB26", "#C73918"))
)
)

```


```{r table-prop-model-hb}

pds_prop_model_table_data_hb <- bind_rows(
  
  hb_totals_table %>% mutate(age_grp_2 = "All referrals",
                              across(everything(), as.character)) %>% rename(`Model of Care` = age_grp_2), 
  
  pds_all_model %>% 
  arrange(model) %>% filter(geog == "Scotland" | grepl("NHS", geog)) %>%
  group_by(geog, fy) %>% 
    mutate(perc_referrals = paste0(round((total_referrals/sum(total_referrals))*100,0),"%")) %>%
    ungroup() %>% 
  select(-total_referrals) %>% 
  pivot_wider(names_from = geog, values_from = perc_referrals) %>%
    rename(`Model of Care` = model))

pds_prop_model_table_data_hb[is.na(pds_prop_model_table_data_hb)] <- "0%"


pds_prop_model_table_hb <- SharedData$new(pds_prop_model_table_data_hb, key = ~fy, group = "model_prop_hb")

bscols(widths = 12,
       div(style = css(width="98%", height="520px", margin="15px", marginTop="0px"),
          DT::datatable(pds_prop_model_table_hb, rownames = FALSE, extensions = "FixedColumns",
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 1),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right', targets = 2:16)
                             ))) %>%
  DT::formatStyle(2, fontWeight = "bold"#, padding = "4px"
                  )
            )
       )




```

### **Age Groups**

```{r dropdown-prop-model-age}
pds_all_model_age <- bind_rows(
  
  model_data %>% filter(age_grp_2 != "Unknown", sex == "All", simd == "All", geog == "Scotland") %>% 
  select(geog, fy, age_grp_2, model, total_referrals) %>% 
  mutate(geog_type = "Health Boards", .before = fy),
  
  model_data %>% filter(age_grp_2 != "Unknown", sex == "All", simd == "All") %>% 
  select(geog, fy, age_grp_2, model, total_referrals) %>% 
  mutate(geog_type = if_else(grepl("NHS", geog), "Health Boards", "Integration Authority Areas"), .before = fy)
)

pds_all_model_age %<>% group_by(geog, geog_type, fy = "All", age_grp_2, model) %>% summarise(total_referrals = sum(total_referrals), .groups = "drop") %>% select(-fy)

pds_all_model_age$geog <- factor(pds_all_model_age$geog, levels = unique(pds_all$geog))

pds_all_model_age$geog_type <- factor(pds_all_model_age$geog_type, levels = unique(pds_all_model_age$geog_type))

pds_all_model_age$age_grp_2<- factor(pds_all_model_age$age_grp_2, levels = c("All", "65+", "64 and Under"))

pds_all_model_age$model <- factor(pds_all_model_age$model, 
    levels = c(unique(pds_all_model$model)[-1],unique(pds_all_model$model)[1]))

pds_model_age_data <- SharedData$new(pds_all_model_age %>% mutate(key = paste0(age_grp_2, geog_type)),
                                   key = ~key, group = "model_prop_age")


data_filter_prop_model_geog <- filter_select(id = "filter_prop_model_age_geog",
                                    label = "Select Integration Authority Areas or Health Boards",
                                    group = ~geog_type,
                                    sharedData = pds_model_age_data,
                                    multiple = FALSE
                                   )

data_filter_prop_model_age <- filter_select(id = "filter_prop_model_age",
                                    label = "Select Age Group:",
                                    group = ~age_grp_2,
                                    sharedData = pds_model_age_data,
                                    multiple = FALSE
                                   )

bscols(widths = c(1,5,5,NA),NULL,
data_filter_prop_model_geog,
data_filter_prop_model_age,NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px">Proportion of Referrals by Model of Care for All Financial Years (2016/17 - `r current_fy`)</h2>
```{r plot-prop-model-legend-age}

bscols(widths = 12, div(style=css(marginBottom="-23px",height="95px", width="90%", marginLeft="35px"), plot_prop_legend(pds_all_model %>% filter(geog == "Scotland"), measure = model, colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#83BB26", "#C73918"))
                        ))

```


```{r plot-prop-model-age}
bscols(widths = 12,
  div(style = css(width="98%", height="400px"),
      plot_prop_2(pds_model_age_data, measure = model, measure_text = "Model of Care: ", measure_2 = age_grp_2, colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#83BB26", "#C73918"))
)
)
```

```{r plot-prop-model-age-label}

xlabel_data_age <- tibble(
 geog_type = c(rep("Integration Authority Areas", 3), rep("Health Boards",3)),
  geog_type_2 = c(rep("Integration Authority Area", 3), rep("Health Board",3)),
  age_grp_2 = rep(c("All", "65+", "64 and Under"),2),
  x = c(1,2,3,4,5,6),
  y = c(0,0,0,0,0,0))

xlabel_data_age_shared <- SharedData$new(xlabel_data_age %>% mutate(key = paste0(age_grp_2, geog_type)),
                                   key = ~key, group = "model_prop_age")

bscols(widths = c(6,3,NA), NULL, div(style=css(marginBottom="20px", marginTop="-35px",marginLeft="-107px",height="30px",width="250px"),plot_prop_2_label(xlabel_data_age_shared)),NULL)

```


```{r table-prop-model-age}

prop_model_age_table_data <- left_join(
  
  pds_all_model_age %>% mutate(key = paste0(age_grp_2,geog_type), .before = geog) %>% 
   mutate(geog = if_else(geog == "Scotland" & geog_type == "Health Boards", 
                         "ScotlandHB",
                         geog)) %>% 
  group_by(geog_type, key, geog, age_grp_2) %>%
    summarise(total_referrals = sum(total_referrals), .groups = "drop") %>% 
   mutate(geog = if_else(geog == "ScotlandHB", 
                         "Scotland",
                         geog)),
  
pds_all_model_age %>%
  mutate(key = paste0(age_grp_2,geog_type)) %>%
   mutate(geog = if_else(geog == "Scotland" & geog_type == "Health Boards", 
                         "ScotlandHB",
                         geog)) %>% 
  group_by(geog, age_grp_2) %>%
    mutate(perc_referrals = paste0(round((total_referrals/sum(total_referrals))*100,0),"%")) %>%
    mutate(perc_referrals = if_else(perc_referrals == "NaN%", "-", perc_referrals)) %>%
    ungroup() %>%
   mutate(geog = if_else(geog == "ScotlandHB", 
                         "Scotland",
                         geog)) %>% 
   arrange(model) %>% 
  select(-total_referrals) %>%
  pivot_wider(names_from = model, values_from = perc_referrals, values_fill = "0%") 
) %>% 
  mutate(total_referrals = format(total_referrals, big.mark = ","))

prop_model_age_table_data$geog <- factor(prop_model_age_table_data$geog, levels = unique(pds_all$geog))

prop_model_age_table_data %<>% arrange(geog)

prop_model_age_table <- SharedData$new(prop_model_age_table_data, key = ~key, group = "model_prop_age")

headers_model <- htmltools::withTags(table(
  class = 'display',
  thead(
    tr( 
      th(colspan = 2, " "),
      th(rowspan = 2, " "),
      th(colspan = 1, " "),
      th(rowspan = 2, "All referrals"),
      th(colspan = 2, " "),
      th(colspan = 2, "Model of Care"),
      th(colspan = 2, " ")
    ),
    tr(
      th(colspan = 1, " "),
      th(colspan = 1, " "),
      th(colspan = 1, " "),
      th(colspan = 1, "PDS - 5 Pillar Model"),
      th(colspan = 1, "PDS - 8 Pillar Model"), 
      th(colspan = 1, "PDS - Advanced Dementia Practice Model"),
      th(colspan = 1, "PDS Not Appropriate"),
      th(colspan = 1, "Yet to be determined"),
      th(colspan = 1, "Not Known")
    )
  )
))

bscols(widths = 12,
       div(style = css(width="98%", height="510px", margin="15px", marginTop="0px"),
          DT::datatable(prop_model_age_table, 
                        container = headers_model,
                        rownames = FALSE,
                        extensions = "FixedColumns",
              options = list(pageLength = 46,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 2),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,1,3)),
                                               list(className = 'dt-right', targets = 4:10)
                             ))) %>%
  DT::formatStyle(3, fontWeight = "bold")
            )
       )


```

### **Gender**

```{r dropdown-prop-model-sex}
pds_all_model_sex <- bind_rows(
  
  model_data %>% filter(sex != "Unknown", sex != "Not Specified", age_grp_2 == "All", simd == "All", geog == "Scotland") %>% 
  select(geog, fy, sex, model, total_referrals) %>% 
  mutate(geog_type = "Health Boards", .before = fy),
  
  model_data %>% filter(sex != "Unknown", sex != "Not Specified", age_grp_2 == "All", simd == "All") %>% 
  select(geog, fy, sex, model, total_referrals) %>% 
  mutate(geog_type = if_else(grepl("NHS", geog), "Health Boards", "Integration Authority Areas"), .before = fy)
)

pds_all_model_sex %<>% group_by(geog, geog_type, fy = "All", sex, model) %>% summarise(total_referrals = sum(total_referrals), .groups = "drop") %>% select(-fy)

pds_all_model_sex$geog <- factor(pds_all_model_sex$geog, levels = unique(pds_all$geog))

pds_all_model_sex$geog_type <- factor(pds_all_model_sex$geog_type, levels = unique(pds_all_model_sex$geog_type))

pds_all_model_sex$sex<- factor(pds_all_model_sex$sex, levels = c("All", "Male", "Female"))

pds_all_model_sex$model <- factor(pds_all_model_sex$model, 
    levels = c(unique(pds_all_model$model)[-1],unique(pds_all_model$model)[1]))

pds_model_sex_data <- SharedData$new(pds_all_model_sex %>% mutate(key = paste0(sex, geog_type)),
                                   key = ~key, group = "model_prop_sex")


data_filter_prop_model_sex_geog <- filter_select(id = "filter_prop_model_sex_geog",
                                    label = "Select Integration Authority Areas or Health Boards",
                                    group = ~geog_type,
                                    sharedData = pds_model_sex_data,
                                    multiple = FALSE
                                   )

data_filter_prop_model_sex <- filter_select(id = "filter_prop_model_sex",
                                    label = "Select Gender:",
                                    group = ~sex,
                                    sharedData = pds_model_sex_data,
                                    multiple = FALSE
                                   )

bscols(widths = c(1,5,5,NA),NULL,
data_filter_prop_model_sex_geog,
data_filter_prop_model_sex,NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px">Proportion of Referrals by Model of Care for All Financial Years (2016/17 - `r current_fy`)</h2>
```{r plot-prop-model-legend-sex}

bscols(widths = 12, div(style=css(marginBottom="-23px",height="95px", width="90%", marginLeft="35px"), plot_prop_legend(pds_all_model %>% filter(geog == "Scotland"), measure = model, colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#83BB26", "#C73918"))
                        ))

```


```{r plot-prop-model-sex}
bscols(widths = 12,
  div(style = css(width="98%", height="400px"),
      plot_prop_2(pds_model_sex_data, measure = model, measure_text = "Model of Care: ", measure_2 = sex, colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#83BB26", "#C73918"))
)
)
```

```{r plot-prop-model-sex-label}

xlabel_data_sex <- tibble(
   geog_type = c(rep("Integration Authority Areas", 3), rep("Health Boards",3)),
  geog_type_2 = c(rep("Integration Authority Area", 3), rep("Health Board",3)),
  sex = rep(c("All", "Male", "Female"),2),
  x = c(1,2,3,4,5,6),
  y = c(0,0,0,0,0,0))

xlabel_data_sex_shared <- SharedData$new(xlabel_data_sex %>% mutate(key = paste0(sex, geog_type)),
                                   key = ~key, group = "model_prop_sex")

bscols(widths = c(6,3,NA), NULL, div(style=css(marginBottom="20px",marginTop="-35px",marginLeft="-107px",height="30px",width="250px"),plot_prop_2_label(xlabel_data_sex_shared)),NULL)

```


```{r table-prop-model-sex}

prop_model_sex_table_data <- left_join(
  
pds_all_model_sex %>% mutate(key = paste0(sex,geog_type), .before = geog) %>% 
   mutate(geog = if_else(geog == "Scotland" & geog_type == "Health Boards", 
                         "ScotlandHB",
                         geog)) %>% 
  group_by(geog_type, key, geog, sex) %>%
    summarise(total_referrals = sum(total_referrals), .groups = "drop") %>% 
   mutate(geog = if_else(geog == "ScotlandHB", 
                         "Scotland",
                         geog)),
  
pds_all_model_sex %>%
  mutate(key = paste0(sex, geog_type)) %>%
   mutate(geog = if_else(geog == "Scotland" & geog_type == "Health Boards", 
                         "ScotlandHB",
                         geog)) %>% 
  group_by(geog, sex) %>%
    mutate(perc_referrals = paste0(round((total_referrals/sum(total_referrals))*100,0),"%")) %>%
    mutate(perc_referrals = if_else(perc_referrals == "NaN%", "-", perc_referrals)) %>%
    ungroup() %>%
   mutate(geog = if_else(geog == "ScotlandHB", 
                         "Scotland",
                         geog)) %>% 
   arrange(model) %>% 
  select(-total_referrals) %>%
  pivot_wider(names_from = model, values_from = perc_referrals, values_fill = "0%") 
)%>% 
  mutate(total_referrals = format(total_referrals, big.mark = ","))

prop_model_sex_table_data$geog <- factor(prop_model_sex_table_data$geog, levels = unique(pds_all$geog))

prop_model_sex_table_data %<>% arrange(geog)

prop_model_sex_table <- SharedData$new(prop_model_sex_table_data, key = ~key, group = "model_prop_sex")

bscols(widths = 12,
       div(style = css(width="98%", height="500px", margin="15px", marginTop="0px"),
          DT::datatable(prop_model_sex_table, 
                        container = headers_model,
                        rownames = FALSE,
                        extensions = "FixedColumns",
              options = list(pageLength = 46,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 2),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,1,3)),
                                               list(className = 'dt-right', targets = 4:10)
                             ))) %>%
  DT::formatStyle(3, fontWeight = "bold")
            )
       )


```

### **Deprivation (SIMD)**

```{r dropdown-prop-model-simd}
pds_all_model_simd <- bind_rows(
  
  model_data %>% filter(simd != "Unknown", simd != "Not Specified", age_grp_2 == "All", sex == "All", geog == "Scotland") %>% 
  select(geog, fy, simd, model, total_referrals) %>% 
  mutate(geog_type = "Health Boards", .before = fy),
  
  model_data %>% filter(simd != "Unknown", simd != "Not Specified", age_grp_2 == "All", sex == "All") %>% 
  select(geog, fy, simd, model, total_referrals) %>% 
  mutate(geog_type = if_else(grepl("NHS", geog), "Health Boards", "Integration Authority Areas"), .before = fy)
)

pds_all_model_simd %<>% group_by(geog, geog_type, fy = "All", simd, model) %>% summarise(total_referrals = sum(total_referrals), .groups = "drop") %>% select(-fy)

pds_all_model_simd %<>% 
  complete(nesting(geog,geog_type), simd, model, fill = list(total_referrals = 0))


pds_all_model_simd$geog <- factor(pds_all_model_simd$geog, levels = unique(pds_all$geog))

pds_all_model_simd$geog_type <- factor(pds_all_model_simd$geog_type, levels = unique(pds_all_model_simd$geog_type))

pds_all_model_simd$simd <- factor(pds_all_model_simd$simd, levels = c(unique(pds_all_model_simd$simd)[6],unique(pds_all_model_simd$simd)[-6]))

pds_all_model_simd$model <- factor(pds_all_model_simd$model, 
    levels = c(unique(pds_all_model$model)[-1],unique(pds_all_model$model)[1]))

pds_model_simd_data <- SharedData$new(pds_all_model_simd %>% mutate(key = paste0(simd, geog_type)),
                                   key = ~key, group = "model_prop_simd")


data_filter_prop_model_simd_geog <- filter_select(id = "filter_prop_model_simd_geog",
                                    label = "Select Integration Authority Areas or Health Boards",
                                    group = ~geog_type,
                                    sharedData = pds_model_simd_data,
                                    multiple = FALSE
                                   )

data_filter_prop_model_simd <- filter_select(id = "filter_prop_model_simd",
                                    label = "Select SIMD Quintile:",
                                    group = ~simd,
                                    sharedData = pds_model_simd_data,
                                    multiple = FALSE
                                   )

bscols(widths = c(1,5,5,NA),NULL,
data_filter_prop_model_simd_geog,
data_filter_prop_model_simd,NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px">Proportion of Referrals by Model of Care for All Financial Years (2016/17 - `r current_fy`)</h2>
```{r plot-prop-model-legend-simd}

bscols(widths = 12, div(style=css(marginBottom="-23px",height="95px", width="90%", marginLeft="35px"), plot_prop_legend(pds_all_model %>% filter(geog == "Scotland"), measure = model, colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#83BB26", "#C73918"))
             ))

```


```{r plot-prop-model-simd}
bscols(widths = 12,
  div(style = css(width="98%", height="400px"),
      plot_prop_2(pds_model_simd_data, measure = model, measure_text = "Model of Care: ", measure_2 = simd, colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#83BB26", "#C73918"))
)
)
```

```{r plot-prop-model-simd-label}

xlabel_data_simd <- tibble(
  geog_type = c(rep("Integration Authority Areas", 6), rep("Health Boards",6)),
  geog_type_2 = c(rep("Integration Authority Area", 6), rep("Health Board",6)),
  simd = rep(c(unique(pds_all_model_simd$simd)[6],unique(pds_all_model_simd$simd)[-6]),2),
  x = c(1:12),
  y = rep(c(0),12))

xlabel_data_simd_shared <- SharedData$new(xlabel_data_simd %>% mutate(key = paste0(simd, geog_type)),
                                   key = ~key, group = "model_prop_simd")

bscols(widths = c(6,3,NA), NULL, div(style=css(marginBottom="20px",marginTop="-35px",marginLeft="-107px",height="30px",width="250px"),plot_prop_2_label(xlabel_data_simd_shared)),NULL)

```


```{r table-prop-model-simd}

prop_model_simd_table_data <- left_join(
  
pds_all_model_simd %>% mutate(key = paste0(simd,geog_type), .before = geog) %>% 
   mutate(geog = if_else(geog == "Scotland" & geog_type == "Health Boards", 
                         "ScotlandHB",
                         geog)) %>% 
  group_by(geog_type, key, geog, simd) %>%
    summarise(total_referrals = sum(total_referrals), .groups = "drop") %>% 
   mutate(geog = if_else(geog == "ScotlandHB", 
                         "Scotland",
                         geog)),
  
pds_all_model_simd %>%
  mutate(key = paste0(simd, geog_type)) %>%
   mutate(geog = if_else(geog == "Scotland" & geog_type == "Health Boards", 
                         "ScotlandHB",
                         geog)) %>% 
  group_by(geog, simd) %>%
    mutate(perc_referrals = paste0(round((total_referrals/sum(total_referrals))*100,0),"%")) %>%
    mutate(perc_referrals = if_else(perc_referrals == "NaN%", "-", perc_referrals)) %>%
    ungroup() %>%
   mutate(geog = if_else(geog == "ScotlandHB", 
                         "Scotland",
                         geog)) %>% 
   arrange(model) %>% 
  select(-total_referrals) %>%
  pivot_wider(names_from = model, values_from = perc_referrals, values_fill = "0%") 
)%>% 
  mutate(total_referrals = format(total_referrals, big.mark = ","))

prop_model_simd_table_data$geog <- factor(prop_model_simd_table_data$geog, levels = unique(pds_all$geog))

prop_model_simd_table_data %<>% arrange(geog)

prop_model_simd_table <- SharedData$new(prop_model_simd_table_data, key = ~key, group = "model_prop_simd")

bscols(widths = 12,
       div(style = css(width="98%", height="490px", margin="15px", marginTop="0px"),
          DT::datatable(prop_model_simd_table, 
                        container = headers_model,
                        rownames = FALSE,
                        extensions = "FixedColumns",
              options = list(pageLength = 46,
                             scrollX = TRUE,
                             fixedColumns = list(leftColumns = 2),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,1,3)),
                                               list(className = 'dt-right', targets = 4:10)
                             ))) %>%
  DT::formatStyle(3, fontWeight = "bold")
            )
       )


```

Model Outcomes {.hidden}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Model of Care - Outcomes 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Proportions](#model-of-care)</li>
  <li>[**Outcomes**](#model-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**

Row {data-height=1200}
----------------------------------------------------------------------

### **Trend**

```{r dropdown-ldp-model}

ldp_all_model_data <- SharedData$new(ldp_all_model %>% filter(fy %in% full_years), key = ~geog, group = "ldp_model")

data_filter_ldp_model <- filter_select(id = "filter_ldp_model",
                                    label = "Select Health Board or Integration Authority Area:",
                                    group = ~geog,
                                    sharedData = ldp_all_model_data,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_ldp_model,
       NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 20px">Percentage of referrals who received a minimum of one year’s PDS by Model of Care and Financial Year </h2>
```{r plot-ldp-model-legend}
bscols(widths = 12,
div(style=css(height="30px"),
plot_ldp_line_legend_1(legend_data)),NULL
)

```

```{r plot-ldp-model}
bscols(widths = 12,
  div(style = css(width="98%", height="400px"),
plot_ldp_line(ldp_all_model_data, measure = model, measure_text = "Model of Care: ", ncol = 3, nrow = 2, colours = c("#3F3685", "#9B4393", "#0078D4", "#948DA3", "#83BB26", "#C73918"))
)
)

# bscols(widths = 12,
#   div(style = css(width="98%", height="385px"),
# plot_ldp_model(ldp_all_model_data))
# )

```


```{r table-ldp-model}

ldp_model_trend <- ldp_all_model %>% filter(!is.na(perc_met)) %>%
  select(geog, fy, model, perc_met) %>%
   mutate(perc_met = paste0(perc_met, "%")) %>% 
  pivot_wider(names_from = fy, values_from = perc_met) %>%
  mutate(type = "% Met Standard/Exempt", .before = `2016/17`)
  
trend_model_totals <- pds_all_model %>% filter(fy %in% full_years, total_referrals != 0) %>%
  mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  pivot_wider(names_from = fy, values_from = total_referrals, values_fill = "0") %>% 
    mutate(type = "Number of Referrals", .before = `2016/17`)


ldp_model_table_data <- bind_rows(trend_model_totals, ldp_model_trend) %>% arrange(geog, model) %>% 
            mutate(across(everything(), ~replace_na(.x, "-"))) %>% 
  mutate(model = if_else(type == "% Met Standard/Exempt", " ", model)) %>% 
   rename(`Model of Care` = model) %>% 
  rename(" " = "type")
            

ldp_model_table <- SharedData$new(ldp_model_table_data, key = ~geog, group = "ldp_model")


bscols(widths = 12,
       div(style = css(width="97%", height="530px", margin="20px"),
DT::datatable(ldp_model_table, rownames = FALSE,
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right',
                                                    targets = 3:(length(full_years)+2))
                                               ))) %>%
           DT::formatStyle(2:3, fontWeight = "bold")# %>% 
  #DT::formatStyle(2, padding = "3px") 
        )
     )



```


Carer's Support {data-navmenu="Additional Information"}
=====================================

Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Carer's Support 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**

**Please note:** *Aberdeen City Health & Social Care Partnership changed to provide PDS in 2019 to an inhouse hybrid model. This change in model, and process of receiving referrals and recording, resulted in data quality issues for financial years 2019/20 and 2020/21. This should be taken into account when interpreting figures for Aberdeen City and NHS Grampian.*

Row {.tabset data-height=920}
----------------------------------------------------------------------

### **Integration Authority Areas**

```{r dropdown-carer-ijb}

 # table_ijb_carer_data <- carer_data %>% 
 #      filter(age_grp_2 == "All", simd == "All") %>% 
 #      mutate(ijb = if_else(health_board == "Scotland", "AAA", ijb)) %>%
 #      arrange(ijb) %>% 
 #      filter(ijb != "All") %>% 
 #      mutate(ijb = if_else(ijb == "AAA", "Scotland", ijb)) %>%
 #        pivot_wider(names_from = carers_support, values_from = referrals) %>% 
 #      mutate(across(where(is.numeric), ~ replace(., is.na(.), 0))) %>% 
 #      adorn_totals("col") %>% 
 #      mutate(perc_carer = paste0(round(100*Yes/Total,1), "%")) %>%
 #      mutate(perc_no_carer = paste0(round(100*No/Total,1), "%")) %>%
 #      mutate(perc_unknown = paste0(round(100*`Not Known`/Total,1), "%")) %>%
 #      mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
 #      select(ijb, fy, Total, perc_carer, perc_no_carer, perc_unknown) %>% 
 #  rename("Number of People Referred to PDS" = "Total", 
 #             "Integration Authority Area" = "ijb",
 #             "% with Carer's Support" = "perc_carer",
 #             "% without Carer's Support" = "perc_no_carer",
 #             "% where Carer's Support is Unknown" = "perc_unknown")

table_ijb_carer_data <- carer_data %>% 
  filter(age_grp_2 == "All", simd == "All") %>% 
  mutate(ijb = if_else(health_board == "Scotland", "AAA", ijb)) %>%
  arrange(ijb) %>% 
  filter(ijb != "All") %>% 
  mutate(ijb = if_else(ijb == "AAA", "Scotland", ijb)) %>%
  pivot_wider(names_from = carers_support, values_from = referrals) %>% 
  mutate(across(where(is.numeric), ~ replace(., is.na(.), 0))) %>% 
  adorn_totals("col") %>% 
  mutate(Known = Total - `Not Known`) %>% 
  mutate(perc_known = paste0(round(100*Known/Total,1), "%")) %>%
  mutate(perc_carer = if_else(Known == 0, "-", paste0(round(100*Yes/Known,1), "%"))) %>%
  mutate(perc_no_carer = if_else(Known == 0, "-", paste0(round(100*No/Known,1), "%"))) %>%
  mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  select(ijb, fy, Total, perc_known, perc_carer, perc_no_carer) %>% 
  rename("Number of People Referred to PDS" = "Total", 
         "Integration Authority Area" = "ijb",
         "% of referrals where Carer's Support is Recorded" = "perc_known",
         "% with Carer's Support" = "perc_carer",
         "% without Carer's Support" = "perc_no_carer",
         )


table_ijb_carer <- SharedData$new(table_ijb_carer_data)

data_filter_carer_ijb <- filter_select(id = "filter_carer_ijb_year",
                                    label = "Select Financial Year of Diagnosis:",
                                    group = ~fy,
                                    sharedData = table_ijb_carer,
                                    multiple = FALSE
                                   )
bscols(widths = c(1,5,NA),
       NULL,
       data_filter_carer_ijb,
       NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px">Percentage of individuals where PDS work is carried out in conjunction with the family/carer; Integration Authority Areas</h2>
```{r table-carer-ijb}



bscols(widths = 12,
       div(style = css(width="98%", height="710px", margin="15px"),
          DT::datatable(table_ijb_carer, rownames = FALSE,
              options = list(pageLength = 32,
                             scrollX = FALSE,
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 1),
                                               list(className = 'dt-right', targets = 2:5)
                             ))) %>%
  DT::formatStyle(1, fontWeight = "bold")
            )
       )




```

### **Health Boards**

```{r dropdown-carer-hb}
# 
#  table_hb_carer_data <- carer_data %>% 
#       filter(age_grp_2 == "All", simd == "All") %>% 
#       filter(ijb == "All" | ijb == "Scotland") %>% 
#       pivot_wider(names_from = carers_support, values_from = referrals) %>% 
#       mutate(across(where(is.numeric), ~ replace(., is.na(.), 0))) %>% 
#       adorn_totals("col") %>% 
#        mutate(perc_carer = paste0(round(100*Yes/Total,1), "%")) %>%
#       mutate(perc_no_carer = paste0(round(100*No/Total,1), "%")) %>%
#       mutate(perc_unknown = paste0(round(100*`Not Known`/Total,1), "%")) %>%
#       mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
#       select(health_board, fy, Total, perc_carer, perc_no_carer, perc_unknown) %>% 
#   rename("Number of People Referred to PDS" = "Total", 
#              "Health Board" = "health_board",
#              "% with Carer's Support" = "perc_carer",
#              "% without Carer's Support" = "perc_no_carer",
#              "% where Carer's Support is Unknown" = "perc_unknown")


table_hb_carer_data <- carer_data %>% 
      filter(age_grp_2 == "All", simd == "All") %>% 
      filter(ijb == "All" | ijb == "Scotland") %>% 
      pivot_wider(names_from = carers_support, values_from = referrals) %>% 
      mutate(across(where(is.numeric), ~ replace(., is.na(.), 0))) %>% 
      adorn_totals("col") %>% 
  mutate(Known = Total - `Not Known`) %>% 
  mutate(perc_known = paste0(round(100*Known/Total,1), "%")) %>%
  mutate(perc_carer = if_else(Known == 0, "-", paste0(round(100*Yes/Known,1), "%"))) %>%
  mutate(perc_no_carer = if_else(Known == 0, "-", paste0(round(100*No/Known,1), "%"))) %>%
  mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  select(health_board, fy, Total, perc_known, perc_carer, perc_no_carer) %>% 
  rename("Number of People Referred to PDS" = "Total", 
          "Health Board" = "health_board",
         "% of referrals where Carer's Support is Recorded" = "perc_known",
         "% with Carer's Support" = "perc_carer",
         "% without Carer's Support" = "perc_no_carer",
         )
 


table_hb_carer <- SharedData$new(table_hb_carer_data)

data_filter_carer_hb <- filter_select(id = "filter_carer_hb_year",
                                    label = "Select Financial Year of Diagnosis:",
                                    group = ~fy,
                                    sharedData = table_hb_carer,
                                    multiple = FALSE
                                   )
bscols(widths = c(1,5,NA),
       NULL,
       data_filter_carer_hb,
       NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px">Percentage of individuals where PDS work is carried out in conjunction with the family/carer; Health Boards</h2>
```{r table-carer-hb}

bscols(widths = 12,
       div(style = css(width="98%", height="660px", margin="15px"),
          DT::datatable(table_hb_carer, rownames = FALSE,
              options = list(pageLength = 15,
                             scrollX = FALSE,
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 1),
                                               list(className = 'dt-right', targets = 2:5)
                             ))) %>%
  DT::formatStyle(1, fontWeight = "bold")
            )
       )


```


Uptake Decision {data-navmenu="Additional Information"}
=====================================

Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Uptake Decision 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**

**Please note:** *Aberdeen City Health & Social Care Partnership changed to provide PDS in 2019 to an inhouse hybrid model. This change in model, and process of receiving referrals and recording, resulted in data quality issues for financial years 2019/20 and 2020/21. This should be taken into account when interpreting figures for Aberdeen City and NHS Grampian.*

Row {.tabset data-height=920}
----------------------------------------------------------------------

### **Integration Authority Areas**

```{r dropdown-uptake-ijb}

 table_ijb_uptake_data <- left_join(bind_rows(pds_scot_totals, pds_ijb_totals),
  
  uptake_data %>% 
      filter(age_grp_2 == "All", simd == "All") %>% 
      mutate(ijb = if_else(health_board == "Scotland", "AAA", ijb)) %>%
      arrange(ijb) %>% 
      filter(ijb != "All") %>% 
      mutate(ijb = if_else(ijb == "AAA", "Scotland", ijb)) %>%
      pivot_wider(names_from = pds_uptake_decision, values_from = referrals) %>% 
      mutate(across(where(is.numeric), ~ replace(., is.na(.), 0))) %>% rename("geog" = "ijb")
  ) %>% 
       mutate(Known = total_referrals - `Not Known`) %>% 
       mutate(perc_known = paste0(round(100*Known/total_referrals,1), "%")) %>%
      select(2,1,4,7,8,9,10,11,12) %>% 
  mutate(perc_declined = if_else(Known == 0, "-", paste0(round(100*Declined/Known,1), "%"))) %>%
  mutate(perc_accepted = if_else(Known == 0, "-", paste0(round((Accepted + `Accepted, but Initially Declined`)/Known*100,1), "%"))) %>%  
          mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  select(fy, geog, total_referrals, perc_known, perc_accepted, perc_declined) %>% 
  rename("Number of People Referred to PDS" = "total_referrals",
         "% of referrals where Uptake Decision is Recorded" = "perc_known",
             "% Accepted (includes those initially declined)" = "perc_accepted",
         "% Declined" = "perc_declined") %>% 
  #remove Aberdeen City 2019/20 and 2020/21 data
  mutate(across(starts_with("%"), ~if_else(geog == "Aberdeen City" & fy %in% c("2019/20","2020/21"), "-", .))) %>% 
    rename("Integration Authority Area" = "geog")


table_ijb_uptake <- SharedData$new(table_ijb_uptake_data)

data_filter_uptake_ijb <- filter_select(id = "filter_uptake_ijb_year",
                                    label = "Select Financial Year of Diagnosis:",
                                    group = ~fy,
                                    sharedData = table_ijb_uptake,
                                    multiple = FALSE
                                   )
bscols(widths = c(1,5,NA),
       NULL,
       data_filter_uptake_ijb,
       NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Referrals by PDS Uptake Decision, Integration Authority Areas</h2>
```{r table-uptake-ijb}



bscols(widths = 12,
       div(style = css(width="98%", height="710px", margin="15px"),
          DT::datatable(table_ijb_uptake, rownames = FALSE,
              options = list(pageLength = 32,
                             scrollX = FALSE,
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right', targets = 2:5)
                             ))) %>%
  DT::formatStyle(2, fontWeight = "bold")
            )
       )




```

### **Health Boards**

```{r dropdown-uptake-hb}

 table_hb_uptake_data <- left_join(bind_rows(pds_scot_totals, pds_hb_totals),
  
  test<-uptake_data %>% 
      filter(age_grp_2 == "All", simd == "All") %>% 
     filter(ijb == "All" | ijb == "Scotland") %>% 
      pivot_wider(names_from = pds_uptake_decision, values_from = referrals) %>% 
      mutate(across(where(is.numeric), ~ replace(., is.na(.), 0))) %>% rename("geog" = "health_board")
  ) %>% 
       mutate(Known = total_referrals - `Not Known`) %>% 
       mutate(perc_known = paste0(round(100*Known/total_referrals,1), "%")) %>%
      select(2,1,4,7,8,9,10,11,12) %>% 
  mutate(perc_declined = if_else(Known == 0, "-", paste0(round(100*Declined/Known,1), "%"))) %>%
  mutate(perc_accepted = if_else(Known == 0, "-", paste0(round((Accepted + `Accepted, but Initially Declined`)/Known*100,1), "%"))) %>%  
          mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
  select(fy, geog, total_referrals, perc_known, perc_accepted, perc_declined) %>% 
  rename("Number of People Referred to PDS" = "total_referrals",
         "% of referrals where Uptake Decision is Recorded" = "perc_known",
             "% Accepted (includes those initially declined)" = "perc_accepted",
         "% Declined" = "perc_declined") %>% 
   rename("Health Board" = "geog")




 # table_hb_uptake_data <- uptake_data %>% 
 #      filter(age_grp_2 == "All", simd == "All") %>% 
 #      filter(ijb == "All" | ijb == "Scotland") %>% 
 #      pivot_wider(names_from = pds_uptake_decision, values_from = referrals) %>% 
 #      mutate(across(where(is.numeric), ~ replace(., is.na(.), 0))) %>% 
 #      adorn_totals("col") %>% 
 #      select(3,1,10,6,7,8,9) %>% 
 #      rowwise() %>% 
 #  mutate(perc_accepted = paste0(round(sum(c_across(4:5))/sum(c_across(3))*100,1), "%")) %>%   
 #      mutate(across(where(is.numeric), ~format(., big.mark = ","))) %>% 
 #  rename("Number of People Referred to PDS" = "Total", 
 #             "Health Board" = "health_board",
 #             "% Accepted (includes those initially declined)" = "perc_accepted")


table_hb_uptake <- SharedData$new(table_hb_uptake_data)

data_filter_uptake_hb <- filter_select(id = "filter_uptake_hb_year",
                                    label = "Select Financial Year of Diagnosis:",
                                    group = ~fy,
                                    sharedData = table_hb_uptake,
                                    multiple = FALSE
                                   )
bscols(widths = c(1,5,NA),
       NULL,
       data_filter_uptake_hb,
       NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Referrals by PDS Uptake Decision, Health Boards</h2>
```{r table-uptake-hb}

bscols(widths = 12,
       div(style = css(width="98%", height="710px", margin="15px"),
          DT::datatable(table_hb_uptake, rownames = FALSE,
              options = list(pageLength = 15,
                             scrollX = FALSE,
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right', targets = 2:5)
                             ))) %>%
  DT::formatStyle(2, fontWeight = "bold")
            )
       )


```


```{js }
function filter_default() {

  document.getElementById("trend_filter_subtype_prop_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_subtype_prop_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("trend_filter_subtype_prop_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_subtype_prop_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("filter_ldp_subtype").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("filter_ldp_subtype").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("trend_filter_stage_prop_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_stage_prop_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("trend_filter_stage_prop_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_stage_prop_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_ldp_stage").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("filter_ldp_stage").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("trend_filter_model_prop_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_model_prop_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("trend_filter_model_prop_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_model_prop_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_prop_model_age_geog").getElementsByClassName("selectized") 
  [0].selectize.setValue("Integration Authority Areas", false);

  document.getElementById("filter_prop_model_age_geog").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
    document.getElementById("filter_prop_model_age").getElementsByClassName("selectized") 
  [0].selectize.setValue("All", false);

  document.getElementById("filter_prop_model_age").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_prop_model_sex_geog").getElementsByClassName("selectized") 
  [0].selectize.setValue("Integration Authority Areas", false);

  document.getElementById("filter_prop_model_sex_geog").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
    document.getElementById("filter_prop_model_sex").getElementsByClassName("selectized") 
  [0].selectize.setValue("All", false);

  document.getElementById("filter_prop_model_sex").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_prop_model_simd_geog").getElementsByClassName("selectized") 
  [0].selectize.setValue("Integration Authority Areas", false);

  document.getElementById("filter_prop_model_simd_geog").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
    document.getElementById("filter_prop_model_simd").getElementsByClassName("selectized") 
  [0].selectize.setValue("All", false);

  document.getElementById("filter_prop_model_simd").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_ldp_model").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("filter_ldp_model").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
    document.getElementById("filter_carer_hb_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_carer_hb_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("filter_carer_ijb_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_carer_ijb_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_uptake_hb_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_uptake_hb_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("filter_uptake_ijb_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_uptake_ijb_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
 
  }
  
  $(document).ready(filter_default);

```

