---
title: "DEMOGRAPHICS DRAFT"
output: 
  flexdashboard::flex_dashboard:
    logo: phs-logo.png
    orientation: rows
    vertical_layout: scroll
---

```{r load-setup, include=FALSE}
source(here::here("code", "00_setup-environment.R"))
library(crosstalk) # for drop down menus
library(phsstyles)
library(htmltools)

# Write numbers with thousands separator
knit_hooks$set(inline = function(x){
  if(!is.character(x)){prettyNum(x, big.mark=",")}else{x}
})
```

---
date: "`r paste('Data as at', format(end_date, '%d %B %Y'))`"
---

```{r setup, include=FALSE}

# Remove tidylog
detach("package:tidylog", unload = TRUE)

# Load functions
walk(dir(here::here("functions"), full.names = TRUE), source)

# Load PDS data
pds <- read_rds(get_mi_data_path("final_data", ext = "rds", test_output = test_output)) %>% 
  
  # Remove codes from board and IJB
  mutate(health_board = str_sub(health_board, 3, -1),
         ijb          = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))

# Load expected diagnoses reference file
exp <- read_csv(get_exp_diagnoses_path())


# Load error summary
err <- read_rds(get_mi_data_path("error_data", ext = "rds", test_output = test_output)) %>% 

  mutate(ijb = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))
```
<!-- delete all of above when finished testing -->

```{r data setup-demo, include=FALSE}
# to be automated based on whether current year is complete or not??
#included_years <- c("2016/17", "2017/18", "2018/19", "2019/20", "2020/21", "2021/22", "2022/23", "2023/24")

#prepare referrals data for plot functions
pds_ijb <- pds %>% arrange(ijb)

pds_scot <- pds %>% group_by(health_board = "Scotland", ijb = "Scotland", fy, month, ldp, age_grp, simd) %>% 
  summarise(referrals = sum(referrals), .groups = "drop")

pds_hb <- pds %>% group_by(health_board, fy, month, ldp, age_grp, simd) %>% 
  summarise(referrals = sum(referrals), .groups = "drop") %>% mutate(ijb = health_board, .before = fy)

pds_all <- bind_rows(pds_scot, pds_hb, pds_ijb)

pds_all %<>% rename(geog = ijb) 

pds_all$geog<- factor(pds_all$geog, levels = unique(pds_all$geog))

#above can be REMOVED when pages are linked (copied from subpage-trends)

#prepare age data
pds_all_age <- pds_all %>% filter(age_grp != "Unknown") #remove 6 unknowns from 2016/17 (add note to charts and tables?)

pds_all_age %<>% group_by(geog, fy, age_grp) %>%
  summarise(total_referrals = sum(referrals), .groups = "drop")

#prepare population rate data with age groups
pop_data <- read_rds("//conf/dementia/A&I/Outputs/management-report/lookups/pop_data.rds")
#above can be REMOVED when pages are linked (copied from subpage-trends)

pop_data_age <- pop_data %>% filter(sex == "All") %>% select(-sex)

pds_all_age_totals <- bind_rows(pds_all_age,
pds_all_age %>% group_by(geog, fy, age_grp = "All") %>% summarise(total_referrals = sum(total_referrals), .groups = "drop"))

pds_all_age_cal_year <- pds_all_age_totals %>%
  mutate(year = as.numeric(substr(fy, 1, 4)))

pds_all_age_rates <- left_join(pds_all_age_cal_year, pop_data_age) %>% select(-year) %>%
  mutate(pop_rate_10000 = round((total_referrals/pop_est)*10000, 2)) %>% select(fy, geog, age_grp, pop_rate_10000)

pds_all_age_rates$geog<- factor(pds_all_age_rates$geog, levels = unique(pds_all_age_rates$geog))

pds_age_rates_data <- left_join(pds_all_age_rates,
pds_all_age_rates %>% filter(geog == "Scotland") %>% select(fy,age_grp, pop_rate_10000) %>% rename(scot_pop_rate_10000 = pop_rate_10000))

legend_data <- tibble(
  geog = c("Scotland", paste0("Selected Health Board/", "<br>", "Integration Authority Area")),
  y = c(0,0))

#prepare simd data
ldp_all_simd <- pds_all %>%
  filter(fy != "2024/25", simd != "Unknown") %>%
  group_by(geog, fy, simd, ldp) %>%
  summarise(total_referrals = sum(referrals), .groups = "drop") %>% 
  pivot_wider(names_from = ldp, values_from = total_referrals, values_fill = 0) %>% 
  mutate(perc_met = round((complete + exempt)/(complete + exempt + fail)*100,1))

pds_all_simd <- pds_all %>% group_by(geog, fy, simd) %>% filter(simd != "Unknown") %>% 
  summarise(total_referrals = sum(referrals), .groups = "drop")

#prepare population rate data with age groups
simd_pop_data <- read_rds("//conf/dementia/A&I/Outputs/management-report/lookups/simd_pop_data.rds")
#above can be REMOVED when pages are linked (copied from subpage-trends)

pop_data_simd <- simd_pop_data %>% filter(sex == "All", age_grp == "All") %>% select(-sex, -age_grp)

pds_all_simd_cal_year <- pds_all_simd %>% 
  mutate(year = as.numeric(substr(fy, 1, 4)))

pds_all_simd_rates <- left_join(pds_all_simd_cal_year, pop_data_simd) %>% select(-year) %>%
  mutate(pop_rate_10000 = round((total_referrals/pop)*10000, 2)) %>% select(fy, geog, simd, pop_rate_10000)

pds_all_simd_rates$geog <- factor(pds_all_simd_rates$geog, levels = unique(pds_all_simd_rates$geog))
pds_all_simd_rates$simd <- as.factor(pds_all_simd_rates$simd)

# assigns data to filter_selects


# pds_trends_data_hb <- SharedData$new(pds_hb)
# pds_trends_pop_data <- SharedData$new(pds_all_rates)
# pds_ijb_pop_data <- SharedData$new(pds_ijb_rates, group = "group1")
# pds_scot_pop_data <- SharedData$new(pds_scot_rates, group = "group1")
   
 
```

Age Groups {data-navmenu="Demographics"}
=================================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Age Groups - Trend
***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Trend](#age-groups)</li>
  <li>[Proportions](#age-proportions)</li>
  <li>[Rates per 10,000 population](#age-rates)</li>
  <li>[Outcomes](#age-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**


Row {.tabset data-height=600}
----------------------------------------------------------------------

### **Scotland**

```{r trend-plot-age}

# trends_plot <- plot_trend(pds_scot, total_referrals)
# trends_plot

```

### **Health Boards**
<div>
```{r dropdown-hb-age, fig.width=2, fig.align='left'}
# data_filter_hb <- filter_select(id = "trend_filter_hb",
#                                     label = "Select Health Board:",
#                                     group = ~geog,
#                                     sharedData = pds_trends_data_hb
#                                    )
# data_filter_hb

```
</div>

<div class="trend-plot-hb">
```{r trend-plot-hb-age, fig.height=5}

# trends_plot_hb <- plot_trend(pds_trends_data_hb, total_referrals)
# trends_plot_hb

```
</div>


### **Integration Authority Areas**

```{r dropdown-ijb-age, fig.height=5}
# data_filter_ijb <- filter_select(id = "trend_filter_ijb",
#                                     label = "Select Integration Authority Area:",
#                                     group = ~geog,
#                                     sharedData = pds_trends_data_ijb
#                                    )
# data_filter_ijb

```

<div>
```{r trend-plot-ijb-age, fig.height=5}

# trends_plot_ijb <- plot_trend(pds_trends_data_ijb, total_referrals)
# trends_plot_ijb

```
</div>

Row {.tabset data-height=750}
----------------------------------------------------------------------

### **Health Boards**

```{r trend-table-hb-age}

# pds_all %>% filter(geog == "Scotland" | grepl("NHS", geog)) %>% 
#             mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% 
#             pivot_wider(names_from = fy, values_from = total_referrals) %>%
#             rename(`Health Board` = geog) %>%
#             kable(align = c("l", rep("r", length(unique(pds$fy))))) %>%
#             kable_styling(full_width = FALSE) %>%
#             column_spec(1, bold = TRUE) %>%
#   # Add header above table 
#             add_header_above(
#                     c(" " = 1,
#                      "Financial Year of Diagnosis" = length(unique(pds$fy))))

```

### **Integration Authority Areas**

```{r trend-table-ijb-age}

# pds_all %>% filter(geog == "Scotland" | !grepl("NHS", geog)) %>% 
#             mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% 
#             pivot_wider(names_from = fy, values_from = total_referrals) %>% 
#             rename(`Integration Authority Area` = geog) %>%
#             kable(align = c("l", rep("r", length(unique(pds$fy))))) %>% 
#             kable_styling(full_width = FALSE) %>%
#             column_spec(1, bold = TRUE) %>%
#   # Add header above table 
#             add_header_above(
#                        c(" " = 1,
#                          "Financial Year of Diagnosis" = length(unique(pds$fy)))) %>%
#             scroll_box(height = "740px")
#  

```

Age Proportions {.hidden}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Age Groups - Proportions 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Trend](#age-groups)</li>
  <li>[Proportions](#age-proportions)</li>
  <li>[Rates per 10,000 population](#age-rates)</li>
  <li>[Outcomes](#age-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**


Row {.tabset data-height=900}
----------------------------------------------------------------------

### **Trend by Financial Year**
```{r dropdown-prop-age}
pds_age_data <- SharedData$new(pds_all_age, key = ~geog, group = "trend_prop")

data_filter_age_prop <- filter_select(id = "trend_filter_age_prop",
                                    label = "Select Health Board or Integration Authority Area:",
                                    group = ~geog,
                                    sharedData = pds_age_data,
                                    multiple = FALSE
                                   )
bscols(widths = c(1,5,NA),
       NULL,
       data_filter_age_prop,
       NULL)

```

<h2 style="margin-left: 50px; margin-top: 0px; margin-bottom: 0px"> Proportion of Referrals by Age Group </h2>
```{r plot-prop-age}
bscols(widths = c(10,2),
  plot_trend_prop(pds_age_data),
  plot_trend_prop_legend(pds_all_age)
)

```


```{r trend-table-prop-age}

pds_prop_table_data <- pds_all_age %>% group_by(geog, fy) %>% 
  mutate(perc_referrals = paste0(round((total_referrals/sum(total_referrals))*100,0),"%")) %>% ungroup() %>% 
  select(-total_referrals) %>% 
  pivot_wider(names_from = fy, values_from = perc_referrals) %>%
             rename(`Age Group` = age_grp)
pds_prop_table_data[is.na(pds_prop_table_data)] <- "0%"


pds_prop_table <- SharedData$new(pds_prop_table_data, key = ~geog, group = "trend_prop")


DT::datatable(pds_prop_table, rownames = FALSE,
              options = list(pageLength = 10,
                             scrollX = FALSE,
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right', targets = 2:10),
                                               list(width = '10px', targets = 1:10)
                                               )))



```

### **Integration Authority Areas**

```{r dropdown-prop-iaa-age}
# data_filter_year <- filter_select(id = "trend_filter_year",
#                                     label = "Select Financial Year:",
#                                     group = ~fy,
#                                     sharedData = pds_ijb_pop_data,
#                                     multiple = FALSE
#                                    )
# data_filter_year
# 

```

<div>
```{r plot-ijb-prop-age, fig.height=5}

 # ijb_rates_plot <- plot_bar_pop_rate(pds_ijb_pop_data, pds_scot_pop_data)
 # ijb_rates_plot

```
</div>

Age Rates {.hidden}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Age Groups - Rates per 10,000 population 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***
<ul>
  <li>[Trend](#age-groups)</li>
  <li>[Proportions](#age-proportions)</li>
  <li>[Rates per 10,000 population](#age-rates)</li>
  <li>[Outcomes](#age-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**


Row {data-height=1000}
----------------------------------------------------------------------

###

```{r dropdown-pop-age}

pds_age_pop_data <- SharedData$new(pds_age_rates_data)

data_filter_pop_year <- filter_select(id = "filter_pop_age_year",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = pds_age_pop_data,
                                    multiple = FALSE
                                   )


data_filter_pop_hb_ijb <- filter_select(id = "filter_pop_age_hb_ijb",
                                    label = "Select Health Board/Integration Authority Area:",
                                    group = ~geog,
                                    sharedData = pds_age_pop_data,
                                    multiple = FALSE
 
                                                                      )
bscols(widths = c(1,5,5,NA),
       NULL,
       data_filter_pop_year,
       data_filter_pop_hb_ijb,
       NULL)


```

<h2 style="margin-left: 50px; margin-top: 0px; margin-bottom: 0px"> People referred to PDS per 10,000 population by Age Group </h2>
```{r plot-pop-age}

bscols(widths = c(10,2),
plot_bar_age_pop(pds_age_pop_data),
plot_bar_age_pop_legend(legend_data))

```


```{r table-pop-age}

# pds_prop_table_data <- pds_all_age %>% group_by(geog, fy) %>% 
#   mutate(perc_referrals = paste0(round((total_referrals/sum(total_referrals))*100,0),"%")) %>% ungroup() %>% 
#   select(-total_referrals) %>% 
#   pivot_wider(names_from = fy, values_from = perc_referrals) %>%
#              rename(`Age Group` = age_grp)
# pds_prop_table_data[is.na(pds_prop_table_data)] <- "0%"
# 
# 
# pds_prop_table <- SharedData$new(pds_prop_table_data, key = ~geog, group = "trend_prop")
# 
# 
# DT::datatable(pds_prop_table, rownames = FALSE,
#               options = list(pageLength = 10,
#                              scrollX = FALSE,
#                              scrollY = FALSE,
#                              dom = "t",
#                              ordering = FALSE,
#                              columnDefs = list(list(visible = FALSE, targets = 0),
#                                                list(className = 'dt-right', targets = 2:10),
#                                                list(width = '10px', targets = 1:10)
#                                                )))
# 


```


Age Outcomes {.hidden}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Age Groups - Outcomes 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Trend](#age-groups)</li>
  <li>[Proportions](#age-proportions)</li>
  <li>[Rates per 10,000 population](#age-rates)</li>
  <li>[Outcomes](#age-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Gender {data-navmenu="Demographics"}
=================================================

Deprivation (SIMD) {data-navmenu="Demographics"}
=================================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Deprivation - Trend
***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Trend](#deprivation-simd)</li>
  <li>[Proportions](#simd-proportions)</li>
  <li>[Rates per 10,000 population](#simd-rates)</li>
  <li>[Outcomes](#simd-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**


Row {.tabset data-height=600}
----------------------------------------------------------------------

### **Scotland**

```{r trend-plot-simd}

# trends_plot <- plot_trend(pds_scot, total_referrals)
# trends_plot

```

### **Health Boards**
<div>
```{r dropdown-hb-simd, fig.width=2, fig.align='left'}
# data_filter_hb <- filter_select(id = "trend_filter_hb",
#                                     label = "Select Health Board:",
#                                     group = ~geog,
#                                     sharedData = pds_trends_data_hb
#                                    )
# data_filter_hb

```
</div>

<div class="trend-plot-hb">
```{r trend-plot-hb-simd, fig.height=5}

# trends_plot_hb <- plot_trend(pds_trends_data_hb, total_referrals)
# trends_plot_hb

```
</div>


### **Integration Authority Areas**

```{r dropdown-ijb-simd, fig.height=5}
# data_filter_ijb <- filter_select(id = "trend_filter_ijb",
#                                     label = "Select Integration Authority Area:",
#                                     group = ~geog,
#                                     sharedData = pds_trends_data_ijb
#                                    )
# data_filter_ijb

```

<div>
```{r trend-plot-ijb-simd, fig.height=5}

# trends_plot_ijb <- plot_trend(pds_trends_data_ijb, total_referrals)
# trends_plot_ijb

```
</div>

Row {.tabset data-height=750}
----------------------------------------------------------------------

### **Health Boards**

```{r trend-table-hb-simd}

# pds_all %>% filter(geog == "Scotland" | grepl("NHS", geog)) %>% 
#             mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% 
#             pivot_wider(names_from = fy, values_from = total_referrals) %>%
#             rename(`Health Board` = geog) %>%
#             kable(align = c("l", rep("r", length(unique(pds$fy))))) %>%
#             kable_styling(full_width = FALSE) %>%
#             column_spec(1, bold = TRUE) %>%
#   # Add header above table 
#             add_header_above(
#                     c(" " = 1,
#                      "Financial Year of Diagnosis" = length(unique(pds$fy))))

```

### **Integration Authority Areas**

```{r trend-table-ijb-simd}

# pds_all %>% filter(geog == "Scotland" | !grepl("NHS", geog)) %>% 
#             mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% 
#             pivot_wider(names_from = fy, values_from = total_referrals) %>% 
#             rename(`Integration Authority Area` = geog) %>%
#             kable(align = c("l", rep("r", length(unique(pds$fy))))) %>% 
#             kable_styling(full_width = FALSE) %>%
#             column_spec(1, bold = TRUE) %>%
#   # Add header above table 
#             add_header_above(
#                        c(" " = 1,
#                          "Financial Year of Diagnosis" = length(unique(pds$fy)))) %>%
#             scroll_box(height = "740px")
#  

```

SIMD Proportions {.hidden}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Deprivation - Proportions 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Trend](#deprivation-simd)</li>
  <li>[Proportions](#simd-proportions)</li>
  <li>[Rates per 10,000 population](#simd-rates)</li>
  <li>[Outcomes](#simd-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**


Row {.tabset data-height=900}
----------------------------------------------------------------------

### **Trend by Financial Year**
```{r dropdown-prop-simd}

# data_filter_simd_prop <- filter_select(id = "trend_filter_simd_prop",
#                                     label = "Select Health Board or Integration Authority Area:",
#                                     group = ~geog,
#                                     sharedData = pds_simd_data,
#                                     multiple = FALSE
#                                    )
# bscols(widths = c(1,4,NA),
#        NULL,
#        data_filter_simd_prop,
#        NULL)


```


```{r plot-prop-simd}
# bscols(widths = c(10,2),
#   plot_trend_prop(pds_simd_data),
#   plot_trend_prop_legend(pds_simd_data)
# )

```


```{r trend-table-prop-simd}

# pds_prop_table_data <- pds_all_simd %>% group_by(geog, fy) %>% 
#   mutate(perc_referrals = paste0(round((total_referrals/sum(total_referrals))*100,0),"%")) %>% ungroup() %>% 
#   select(-total_referrals) %>% 
#   pivot_wider(names_from = fy, values_from = perc_referrals) %>%
#              rename(`Age Group` = age_grp)
# pds_prop_table_data[is.na(pds_prop_table_data)] <- "0%"
# 
# 
# pds_prop_table <- SharedData$new(pds_prop_table_data, key = ~geog, group = "trend_prop")
# 
# 
# DT::datatable(pds_prop_table, rownames = FALSE,
#               options = list(pageLength = 10,
#                              scrollX = FALSE,
#                              scrollY = FALSE,
#                              dom = "t",
#                              ordering = FALSE,
#                              columnDefs = list(list(visible = FALSE, targets = 0),
#                                                list(className = 'dt-right', targets = 2:10),
#                                                list(width = '10px', targets = 1:10)
#                                                )))



```

### **Integration Authority Areas**

```{r dropdown-prop-iaa-simd}
# data_filter_year <- filter_select(id = "trend_filter_year",
#                                     label = "Select Financial Year:",
#                                     group = ~fy,
#                                     sharedData = pds_ijb_pop_data,
#                                     multiple = FALSE
#                                    )
# data_filter_year
# 

```

<div>
```{r plot-ijb-prop-simd, fig.height=5}

 # ijb_rates_plot <- plot_bar_pop_rate(pds_ijb_pop_data, pds_scot_pop_data)
 # ijb_rates_plot

```
</div>

SIMD Rates {.hidden}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Deprivation - Rates per 10,000 population 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***
<ul>
  <li>[Trend](#deprivation-simd)</li>
  <li>[Proportions](#simd-proportions)</li>
  <li>[Rates per 10,000 population](#simd-rates)</li>
  <li>[Outcomes](#simd-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**


Row {data-height=1000}
----------------------------------------------------------------------

###

```{r dropdown-pop-simd}
# data_filter_pop_year <- filter_select(id = "filter_pop_simd_year",
#                                     label = "Select Financial Year:",
#                                     group = ~fy,
#                                     sharedData = pds_simd_pop_data,
#                                     multiple = FALSE
#                                    )
# 
# 
# data_filter_pop_hb_ijb <- filter_select(id = "filter_pop_simd_hb_ijb",
#                                     label = "Select Health Board/Integration Authority Area:",
#                                     group = ~geog,
#                                     sharedData = pds_simd_pop_data,
#                                     multiple = FALSE
#  
#                                                                       )
# bscols(widths = c(1,4,4,NA),
#        NULL,
#        data_filter_pop_year,
#        data_filter_pop_hb_ijb,
#        NULL)


```


```{r plot-pop-simd}

# bscols(widths = c(10,2),
# plot_bar_simd_pop(pds_simd_pop_data),
# plot_bar_simd_pop_legend(legend_data))

```


```{r table-pop-simd}

# pds_prop_table_data <- pds_all_age %>% group_by(geog, fy) %>% 
#   mutate(perc_referrals = paste0(round((total_referrals/sum(total_referrals))*100,0),"%")) %>% ungroup() %>% 
#   select(-total_referrals) %>% 
#   pivot_wider(names_from = fy, values_from = perc_referrals) %>%
#              rename(`Age Group` = age_grp)
# pds_prop_table_data[is.na(pds_prop_table_data)] <- "0%"
# 
# 
# pds_prop_table <- SharedData$new(pds_prop_table_data, key = ~geog, group = "trend_prop")
# 
# 
# DT::datatable(pds_prop_table, rownames = FALSE,
#               options = list(pageLength = 10,
#                              scrollX = FALSE,
#                              scrollY = FALSE,
#                              dom = "t",
#                              ordering = FALSE,
#                              columnDefs = list(list(visible = FALSE, targets = 0),
#                                                list(className = 'dt-right', targets = 2:10),
#                                                list(width = '10px', targets = 1:10)
#                                                )))
# 


```


SIMD Outcomes {.hidden}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

<br>

### Deprivation - Outcomes 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Trend](#deprivation-simd)</li>
  <li>[Proportions](#simd-proportions)</li>
  <li>[Rates per 10,000 population](#simd-rates)</li>
  <li>[Outcomes](#simd-outcomes)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**

Row {data-height=1000}
----------------------------------------------------------------------

### 

```{r dropdown-ldp-simd}

ldp_all_simd_data <- SharedData$new(ldp_all_simd)

data_filter_ldp_simd <- filter_select(id = "filter_ldp_simd",
                                    label = "Select Health Board/Integration Authority Area:",
                                    group = ~geog,
                                    sharedData = ldp_all_simd_data,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_ldp_simd,
       NULL)


```

<h2 style="margin-left: 50px; margin-top: 0px; margin-bottom: 0px"> Percentage of LDP standard achieved by SIMD Quintile and Financial Year </h2>


```{r plot-ldp-simd-legend}

bscols(widths = 12,
div(id="ldpsimdlegend",plot_ldp_simd_legend(ldp_all_simd), style="margin-bottom:-353px"))

```


```{r plot-ldp-simd}
bscols(widths = 12,
plot_ldp_simd(ldp_all_simd_data))

```


```{r table-ldp-simd}

# pds_prop_table_data <- pds_all_simd %>% group_by(geog, fy) %>% 
#   mutate(perc_referrals = paste0(round((total_referrals/sum(total_referrals))*100,0),"%")) %>% ungroup() %>% 
#   select(-total_referrals) %>% 
#   pivot_wider(names_from = fy, values_from = perc_referrals) %>%
#              rename(`Age Group` = age_grp)
# pds_prop_table_data[is.na(pds_prop_table_data)] <- "0%"
# 
# 
# pds_prop_table <- SharedData$new(pds_prop_table_data, key = ~geog, group = "trend_prop")
# 
# 
# DT::datatable(pds_prop_table, rownames = FALSE,
#               options = list(pageLength = 10,
#                              scrollX = FALSE,
#                              scrollY = FALSE,
#                              dom = "t",
#                              ordering = FALSE,
#                              columnDefs = list(list(visible = FALSE, targets = 0),
#                                                list(className = 'dt-right', targets = 2:10),
#                                                list(width = '10px', targets = 1:10)
#                                                )))
# 


```

```{js }
function filter_default() {

  document.getElementById("trend_filter_age_prop").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("trend_filter_age_prop").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("filter_pop_age_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("filter_pop_age_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("filter_pop_age_hb_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("NHS Ayrshire & Arran", false);

  document.getElementById("filter_pop_age_hb_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
    document.getElementById("filter_ldp_simd").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("filter_ldp_simd").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
    document.getElementById("trend_filter_hb").getElementsByClassName("selectized") 
  [0].selectize.setValue("NHS Ayrshire & Arran", false);

  document.getElementById("trend_filter_hb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("trend_filter_ijb").getElementsByClassName("selectized") 
  [0].selectize.setValue("Aberdeen City", false);

  document.getElementById("trend_filter_ijb").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
 
   document.getElementById("trend_filter_pop").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("trend_filter_pop").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  document.getElementById("trend_filter_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("2023/24", false);

  document.getElementById("trend_filter_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  }
  
  window.onload = filter_default;

```

