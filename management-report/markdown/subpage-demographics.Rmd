Age Groups {data-navmenu="Demographics"}
=================================================

```{r data-setup-demo, include=FALSE}

#prepare age data 
ldp_all_age <- pds_all %>%
  filter(fy %in% full_years, age_grp_2 != "Unknown") %>%
  group_by(geog, fy, age_grp_2, ldp) %>%
  summarise(total_referrals = sum(referrals), .groups = "drop") %>% 
  pivot_wider(names_from = ldp, values_from = total_referrals, values_fill = 0) %>% 
  mutate(perc_met = round((complete + exempt)/(complete + exempt + fail)*100,1)) %>% 
complete(nesting(geog, fy), age_grp_2, fill = list(perc_met = NA))

ldp_all_age <- left_join(ldp_all_age,
ldp_all_age %>% filter(geog == "Scotland") %>% select(fy, age_grp_2, perc_met) %>% 
  rename(scot_perc_met = perc_met))

ldp_all_age$age_grp_2<- factor(ldp_all_age$age_grp_2, levels = c("79 and Under", "80 to 84", "85+"))

pds_all_age <- pds_all %>% filter(age_grp_2 != "Unknown") 

pds_all_age %<>% group_by(fy, geog, age_grp_2) %>%
  summarise(total_referrals = sum(referrals), .groups = "drop")

pds_all_age$age_grp_2<- factor(pds_all_age$age_grp_2, levels = c("79 and Under", "80 to 84", "85+"))

#prepare population rate data 

pop_data_age <- pop_data %>% filter(sex == "All", age_grp == "All") %>% select(-sex, -age_grp)

pds_all_age_cal_year <- pds_all_age %>%
  mutate(year = as.numeric(substr(fy, 1, 4)))

pds_all_age_rates <- left_join(pds_all_age_cal_year, pop_data_age) %>% select(-year) %>%
  mutate(pop_rate_10000 = round((total_referrals/pop_est)*10000, 1)) %>% select(fy, geog, age_grp_2, pop_rate_10000)

pds_all_age_rates$geog<- factor(pds_all_age_rates$geog, levels = unique(pds_all_age_rates$geog)) 
pds_all_age_rates$age_grp_2<- factor(pds_all_age_rates$age_grp_2, levels = c("79 and Under", "80 to 84", "85+"))

pds_all_age_rates %<>% complete(nesting(fy, geog), age_grp_2, fill = list(pop_rate_10000 = 0)) 

pds_all_age_rates <- left_join(pds_all_age_rates,
pds_all_age_rates %>% filter(geog == "Scotland") %>% select(fy, age_grp_2, pop_rate_10000) %>% rename(scot_pop_rate_10000 = pop_rate_10000)) 

#prepare gender data

ldp_all_sex <- pds_all %>%
  filter(fy %in% full_years, sex != "98 Not Specified", sex != "99 Not Known", sex != "Unknown") %>% 
  group_by(geog, fy, sex, ldp) %>%
  summarise(total_referrals = sum(referrals), .groups = "drop") %>% 
  pivot_wider(names_from = ldp, values_from = total_referrals, values_fill = 0) %>% 
  mutate(perc_met = round((complete + exempt)/(complete + exempt + fail)*100,1)) %>% 
complete(nesting(geog, fy), sex, fill = list(perc_met = NA))

ldp_all_sex <- left_join(ldp_all_sex,
ldp_all_sex %>% filter(geog == "Scotland") %>% select(fy, sex, perc_met) %>% 
  rename(scot_perc_met = perc_met)) %>% mutate(sex = substring(sex, 4))

ldp_all_sex$sex<- factor(ldp_all_sex$sex, levels = c("Male", "Female"))

pds_all_sex <- pds_all %>% group_by(geog, fy, sex) %>% filter(sex != "98 Not Specified", sex != "99 Not Known", sex != "Unknown") %>% 
  summarise(total_referrals = sum(referrals), .groups = "drop") %>% 
complete(nesting(geog, fy), sex, fill = list(total_referrals = 0)) %>% mutate(sex = substring(sex, 4))

pds_all_sex$sex<- factor(pds_all_sex$sex, levels = c("Male", "Female"))

#prepare population rate data for gender

pop_data_sex <- pop_data %>% filter(age_grp != "All", age_grp != "59 and Under", age_grp != "60 to 64", age_grp_2 == "All", sex != "All") %>% select(-age_grp_2) %>% mutate(sex = substring(sex, 4)) %>% 
  group_by(geog, year, sex) %>% summarise(pop_est = sum(pop_est)) %>% ungroup()

pds_all_sex_cal_year <- pds_all_sex %>% 
  mutate(year = as.numeric(substr(fy, 1, 4)))

pds_all_sex_rates <- left_join(pds_all_sex_cal_year, pop_data_sex) %>% select(-year) %>%
  mutate(pop_rate_10000 = round((total_referrals/pop_est)*10000, 1))

pds_all_sex_rates$geog <- factor(pds_all_sex_rates$geog, levels = unique(pds_all_sex_rates$geog))
pds_all_sex_rates$sex <- as.factor(pds_all_sex_rates$sex)

pds_all_sex_rates %<>% complete(nesting(geog, fy), sex, fill = list(pop_est = NA, pop_rate_10000 = NA)) 

pds_all_sex_rates <- left_join(pds_all_sex_rates,
pds_all_sex_rates %>% filter(geog == "Scotland") %>% select(fy, sex, pop_rate_10000) %>% rename(scot_pop_rate_10000 = pop_rate_10000)) 

pds_all_sex_rates$sex<- factor(pds_all_sex_rates$sex, levels = c("Male", "Female"))


#prepare simd data
ldp_all_simd <- pds_all %>%
  filter(fy %in% full_years, simd != "Unknown") %>%
  group_by(geog, fy, simd, ldp) %>%
  summarise(total_referrals = sum(referrals), .groups = "drop") %>% 
  pivot_wider(names_from = ldp, values_from = total_referrals, values_fill = 0) %>% 
  mutate(perc_met = round((complete + exempt)/(complete + exempt + fail)*100,1)) %>% 
complete(nesting(geog, fy), simd, fill = list(perc_met = NA))

ldp_all_simd <- left_join(ldp_all_simd,
ldp_all_simd %>% filter(geog == "Scotland") %>% select(fy, simd, perc_met) %>% 
  rename(scot_perc_met = perc_met))

pds_all_simd <- pds_all %>% group_by(geog, fy, simd) %>% filter(simd != "Unknown") %>% 
  summarise(total_referrals = sum(referrals), .groups = "drop") %>% 
complete(nesting(geog, fy), simd, fill = list(total_referrals = 0))


#prepare population rate data for simd
simd_pop_data <- read_rds("//conf/dementia/A&I/Outputs/management-report/lookups/simd_pop_data.rds")

pop_data_simd <- simd_pop_data %>% filter(age_grp != "All", age_grp != "59 and Under", age_grp != "60 to 64", age_grp_2 == "All", sex != "All") %>% select(-age_grp_2, -sex) %>% 
  group_by(geog, year, simd) %>% summarise(pop = sum(pop)) %>% ungroup()

pds_all_simd_cal_year <- pds_all_simd %>% 
  mutate(year = as.numeric(substr(fy, 1, 4)))

pds_all_simd_rates <- left_join(pds_all_simd_cal_year, pop_data_simd) %>% select(-year) %>%
  mutate(pop_rate_10000 = round((total_referrals/pop)*10000, 1))

pds_all_simd_rates$geog <- factor(pds_all_simd_rates$geog, levels = unique(pds_all_simd_rates$geog))

pds_all_simd_rates$simd <- as.factor(pds_all_simd_rates$simd)

pds_all_simd_rates %<>% complete(nesting(geog, fy), simd, fill = list(pop = NA, pop_rate_10000 = NA)) 

pds_all_simd_rates <- left_join(pds_all_simd_rates,
pds_all_simd_rates %>% filter(geog == "Scotland") %>% select(fy, simd, pop_rate_10000) %>% rename(scot_pop_rate_10000 = pop_rate_10000)) 

#legend tibble
legend_data_1 <- tibble(
  geog = unique(pds_all$geog),
  legend = c(" ", rep("Scotland",45)),
  x = 1,
  y = 0)

legend_data_2 <- tibble(
  geog = unique(pds_all$geog),
  legend = unique(pds_all$geog),
  x = 1,
  y = 0)

legend_data <- bind_rows(legend_data_2, legend_data_1) %>% filter(legend != " ")

legend_data$legend <- factor(legend_data$legend, levels = c(unique(legend_data$legend)))

legend_data$legend <-fct_relevel(legend_data$legend, "Scotland", after = Inf)

# total referrals for tables
hb_totals_table <- bind_rows(pds_scot_totals, pds_hb_totals) %>%
  mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% pivot_wider(names_from = geog, values_from = total_referrals)

ijb_totals_table <- bind_rows(pds_scot_totals, pds_ijb_totals)  %>%
  mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% pivot_wider(names_from = geog, values_from = total_referrals)
   
# colours for simd plots
simd_colours <- c("#0062AD", "#0078D4", "#3393DD", "#80BCEA", "#B3D7F2")

#colours for gender plots
sex_colours <- c( "#3F3685", "#9B4393")

# colours for age plots
age_colours <- c("#6B5C85", "#0078D4", "#1E7F84")
 
```

Sidebar - age rates {.sidebar}
-----------------------------------------------------------------------

<br>

### Age Groups - Rates per 10,000 population 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[**Rates per 10,000 population**](#age-groups)</li>
  <li>[Outcomes](#age-outcomes)</li>
</ul>

***

**FURTHER INFORMATION:**

<ul style="list-style-type:square;">
   <li >[Glossary](#glossary)</li>
   <li >[Navigation Guide](#navigation-guide)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

This page includes rates of the number of people referred to PDS per 10,000 population (65 years and over) for given age groups. *See the [Glossary](#glossary) for more details.*

The Integration Authority Area and Health Board tabs include a chart and table showing the rates for each geographical area for the selected financial year. For the Integration Authority tab use the dropdown menu to select areas to show in the charts and tables. 

The Trend tab shows the trend of the rate by financial year for Scotland and the selected geographical area for each age group. The table below the chart shows the rates for the selected geographical area.

*The figures shown for `r provisional_year` onwards are currently provisional and subject to change in future versions of this report.*

`r if(qt != 4) {div(style = css(fontStyle="italic"),paste0("For diagnoses in financial year ", current_fy, " data is available up to and including Q", qt, "."))}`

Row {.tabset data-height=1180}
----------------------------------------------------------------------

### **Integration Authority Areas**

```{r dropdown-ijb-age-pop}
#filter for authority areas
pds_ijb_age_rates <- pds_all_age_rates %>% filter(!grepl("NHS", geog)) %>% 
   mutate(pop_rate_10000 = if_else(is.na(pop_rate_10000), 0, pop_rate_10000)) %>% #this was added to avoid any areas with missing data being placed at the end of the chart
#age_grp_2_group is for use with age group dropdown below which has been removed in current version
         mutate(age_grp_2_group = "All", .before = age_grp_2)  %>% 
#create key for connecting dropdown to plot and table
         mutate(key = paste0(fy,age_grp_2_group,geog), .before = geog)

#create sharedData object for dropdown menu
pds_pop_age_data_ijb <- SharedData$new(pds_ijb_age_rates, key = ~key, group = "ijb_age_pop")

#create dropdown menu for selecting financial year
data_filter_ijb_age_pop <- filter_select(id = "filter_ijb_age_pop",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = pds_pop_age_data_ijb,
                                    multiple = FALSE
                                      )

## filter for selecting age group (removed in current version) 
# data_filter_ijb_age_group <- filter_select(id = "filter_ijb_age_group",
#                                     label = "Select Age Group:",
#                                     group = ~age_grp_2_group,
#                                     sharedData = pds_pop_age_data_ijb,
#                                     multiple = FALSE)
  
#create dropdown menu for selecting authority area
data_filter_ijb_age_pop_geog <- filter_select(id = "filter_ijb_age_pop_geog",
                                    label = "Select Integration Authority Area(s):",
                                    group = ~geog,
                                    sharedData = pds_pop_age_data_ijb,
                                    multiple = TRUE
                                      )
#place dropdown menus in columns and set size
bscols(widths = c(1,5,NA),
       NULL,
       data_filter_ijb_age_pop,
       NULL)

bscols(widths = c(1,10,NA), NULL, data_filter_ijb_age_pop_geog, NULL)
```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Number of people referred to PDS per 10,000 population by Age Group and Integration Authority Area</h2>
```{r plot-ijb-age-pop}

bscols(widths = 12,
  div(style = css(width="98%", height="350px", marginBottom="-20px"),
plot_ly(pds_pop_age_data_ijb, x = ~geog, y = ~pop_rate_10000, meta = ~fy, hovertext = ~age_grp_2, type = 'bar', color = ~age_grp_2, colors = age_colours, 
        hovertemplate = paste0("%{x} <br>", "%{meta} <br>", "Age Group: %{hovertext} <br>",
                            "Rate per 10,000 Population: %{y}<extra></extra>")) %>% 
  layout(clickmode = "none", 
         showlegend = TRUE, legend = list(orientation = 'h', x = 0.5, y = 100, xanchor = "center"),
         margin = list(l = -5, b = 10, t = 40),
         xaxis = list(title = "", showline = FALSE, linecolor = "#b3b3b3",
                      categoryorder = "trace", tickangle = -45, titlefont = list(size = 16)),
         yaxis = list(title = "Rate per 10,000 Population", linecolor = "#b3b3b3", titlefont = list(size = 16))
      ) %>%
  config(displayModeBar = TRUE, doubleClick = F,
         modeBarButtonsToRemove = list('select2d', 'lasso2d', 'zoomIn2d', 
                                       'zoomOut2d', 'autoScale2d', 
                                       'toggleSpikelines', 
                                       'hoverCompareCartesian', 
                                       'hoverClosestCartesian', 'toImage'), 
         displaylogo = F, editable = F)
  )
)

```


```{r table-ijb-age-pop}

ijb_pop_age_table_data <- pds_all_age_rates %>% filter(!grepl("NHS", geog)) %>%
   select(geog,fy,age_grp_2,pop_rate_10000) %>%
    mutate(age_grp_2_group = "All", .before = age_grp_2) %>% 
    mutate(pop_rate_10000 = as.character(pop_rate_10000)) %>%
  arrange(age_grp_2) %>% 
  pivot_wider(names_from = age_grp_2, values_from = pop_rate_10000) %>%
  mutate(key = paste0(fy,age_grp_2_group,geog), .before = geog) %>% 
  mutate(across(everything(), ~if_else(age_grp_2_group == "All", 
                                       replace_na(.x, "-"), 
                                       replace_na(.x, " ")))) %>%
             rename(`Integration Authority Area` = geog) 


ijb_age_table_pop <- SharedData$new(ijb_pop_age_table_data, key = ~key, group = "ijb_age_pop")


bscols(widths = 12,
       div(style = css(width="97%", height="560px", margin="20px"),
DT::datatable(ijb_age_table_pop, rownames = FALSE, selection = 'none',
              options = list(pageLength = 33,
                             scrollX = TRUE,
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,2,3)),
                                               list(className = 'dt-right', targets = 4:6)
                                               ))) %>%
           DT::formatStyle(2, fontWeight = "bold"
                          )
        )
     )


```


### **Health Boards**

```{r dropdown-hb-age-pop}
pds_hb_age_rates <- pds_all_age_rates %>% filter(grepl("NHS", geog) | geog == "Scotland") %>% 
         mutate(age_grp_2_group = "All", .before = age_grp_2)  %>% 
         mutate(key = paste0(fy,age_grp_2_group,geog), .before = geog)

pds_pop_age_data_hb <- SharedData$new(pds_hb_age_rates, key = ~key, group = "hb_age_pop")

data_filter_hb_age_pop <- filter_select(id = "filter_hb_age_pop",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = pds_pop_age_data_hb,
                                    multiple = FALSE
                                      )

# data_filter_hb_age_pop_quintile <- filter_select(id = "filter_hb_age_pop_quintile",
#                                     label = "Select Age Group:",
#                                     group = ~age_grp_2_group,
#                                     sharedData = pds_pop_age_data_hb,
#                                     multiple = FALSE)


bscols(widths = c(1,5,NA),
       NULL,
       data_filter_hb_age_pop,
       NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Number of people referred to PDS per 10,000 population by Age Group and Health Board</h2>
```{r plot-hb-age-pop}

bscols(widths = 12,
  div(style = css(width="98%", height="365px", marginBottom="-20px"),
plot_ly(pds_pop_age_data_hb, x = ~geog, y = ~pop_rate_10000, meta = ~fy, hovertext = ~age_grp_2, type = 'bar', color = ~age_grp_2, colors = age_colours, 
        hovertemplate = paste0("%{x} <br>", "%{meta} <br>", "Age Group: %{hovertext} <br>",
                            "Rate per 10,000 Population: %{y}<extra></extra>")) %>% 
  layout(clickmode = "none", 
         showlegend = TRUE, legend = list(orientation = 'h', x = 0.5, y = 100, xanchor = "center"),
         margin = list(l = -5, b = 10, t = 40),
         xaxis = list(title = "", showline = FALSE, linecolor = "#b3b3b3",
                      categoryorder = "array", categoryarray = pds_hb_age_rates$geog, tickangle = -45, titlefont = list(size = 16)),
         yaxis = list(title = "Rate per 10,000 Population", linecolor = "#b3b3b3", titlefont = list(size = 16))
      ) %>%
  config(displayModeBar = TRUE, doubleClick = F,
         modeBarButtonsToRemove = list('select2d', 'lasso2d', 'zoomIn2d', 
                                       'zoomOut2d', 'autoScale2d', 
                                       'toggleSpikelines', 
                                       'hoverCompareCartesian', 
                                       'hoverClosestCartesian', 'toImage'), 
         displaylogo = F, editable = F)
  )
)

```


```{r table-hb-age-pop}

hb_pop_age_table_data <-  pds_all_age_rates %>%
  filter(grepl("NHS", geog) | geog == "Scotland") %>%
  select(geog,fy,age_grp_2,pop_rate_10000) %>%
   mutate(age_grp_2_group = "All", .before = age_grp_2) %>% 
    mutate(pop_rate_10000 = as.character(pop_rate_10000)) %>%
   arrange(age_grp_2) %>% 
  pivot_wider(names_from = age_grp_2, values_from = pop_rate_10000) %>%
  mutate(key = paste0(fy,age_grp_2_group,geog), .before = geog) %>% 
  mutate(across(everything(), ~if_else(age_grp_2_group == "All", 
                                       replace_na(.x, "-"), 
                                       replace_na(.x, " ")))) %>%
             rename(`Health Board` = geog) 


hb_age_table_pop <- SharedData$new(hb_pop_age_table_data, key = ~key, group = "hb_age_pop")


bscols(widths = 12,
       div(style = css(width="97%", height="620px", margin="20px"),
DT::datatable(hb_age_table_pop, rownames = FALSE, selection = 'none',
              options = list(pageLength = 15,
                             scrollX = TRUE,
                            # fixedColumns = list(leftColumns = 1),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,2,3)),
                                               list(className = 'dt-right', targets = 4:6)
                                               ))) %>%
           DT::formatStyle(2, fontWeight = "bold"
                          )
        )
     )


```

### **Trend**

```{r dropdown-trend-age-pop}

pds_pop_age_data <- SharedData$new(pds_all_age_rates %>% 
  mutate(pop_rate_10000 = if_else(geog == "Scotland", NA, pop_rate_10000)),
  key = ~geog, group = "trend_age_pop")

data_filter_trend_age_pop <- filter_select(id = "filter_trend_age_pop",
                                    label = "Select Integration Authority Area or Health Board:",
                                    group = ~geog,
                                    sharedData = pds_pop_age_data,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_trend_age_pop,
       NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 15px"> Number of people referred to PDS per 10,000 population by Age Group and Financial Year</h2> 
```{r plot-trend-age-legend-pop}
legend_data_age<- SharedData$new(legend_data,
  key = ~geog, group = "trend_age_pop")

bscols(widths = 12,
       div(style = css(height="30px"),
plot_rate_line_legend(legend_data_age)),NULL
)

```

```{r plot-trend-age-pop}

bscols(widths = 12,
  div(style = css(width="98%", height="330px"),
plot_rate_line(pds_pop_age_data, measure = age_grp_2, measure_text = "Age Group: ", y = "Rate per 10,000 Population", scales = "free_y", colours = age_colours, facet_space = -5))
)

```

```{r table-trend-age-pop}

trend_pop_age_table_data <- pds_all_age_rates %>% filter(!is.na(pop_rate_10000)) %>% 
  select(geog,fy,age_grp_2,pop_rate_10000) %>%
  pivot_wider(names_from = fy, values_from = pop_rate_10000) %>%
  arrange(age_grp_2) %>% 
             rename(`Age Group` = age_grp_2)


trend_pop_age_table <- SharedData$new(trend_pop_age_table_data, key = ~geog, group = "trend_age_pop")


bscols(widths = 12,
       div(style = css(width="97%", height="165px", margin="20px"),
DT::datatable(trend_pop_age_table, rownames = FALSE, selection = 'none',
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0)))
              ) %>%
           DT::formatStyle(2, fontWeight = "bold")
        )
     )



```

Age Outcomes {.hidden}
=====================================
Sidebar - age outcomes{.sidebar}
-----------------------------------------------------------------------

<br>

### Age Groups - Outcomes 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Rates per 10,000 population](#age-groups)</li>
  <li>[**Outcomes**](#age-outcomes)</li>
</ul>

***

**FURTHER INFORMATION:**

<ul style="list-style-type:square;">
   <li >[Methodology](#methodology)</li>
   <li >[Glossary](#glossary)</li>
   <li >[Navigation Guide](#navigation-guide)</li>
</ul>

***

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

This page shows the percentage of referrals that have received one year’s support which started within a year of diagnosis (or have been exempt from the LDP Standard) for given age groups.  

The Integration Authority Area and Health Board tabs include a chart and table showing the percentages for each geographical area. For the Integration Authority tab use the dropdown menu to select areas to show in the charts and tables. 

The Trend tab shows the trend of the percentage of referrals that have received one year’s support by financial year for Scotland and the selected geographical area for each age group. The table below the chart shows the figures for the selected geographical area. 

*The figures shown for `r provisional_year` onwards are currently provisional and subject to change in future versions of this report.*

`r if(qt != 4) {div(style = css(fontStyle="italic"),paste("LDP Standard performance figures are not provided until data is available for the full financial year."))}`
`r if(qt != 4) {HTML("<br>")}`
**Please note:** *Aberdeen City Health & Social Care Partnership changed to provide PDS in 2019 to an inhouse hybrid model. This change in model, and process of receiving referrals and recording, resulted in data quality issues for financial years 2019/20 and 2020/21. This should be taken into account when interpreting figures for Aberdeen City and NHS Grampian.*


**Please note:** *NHS Shetland did not have a PDS worker in post from 2022/23 Q1 through 2023/24 Q3. As a result not all people referred to PDS could be allocated or contacted by a PDS worker within 12 months of diagnosis, hence they have been recorded as not having met the standard. A PDS worker was assigned in 2023/24 Q4 and the PDS service in Shetland has resumed.*

Row {.tabset data-height=1180}
----------------------------------------------------------------------

### **Integration Authority Areas**

```{r dropdown-ijb-age-ldp}
ldp_ijb_age <- ldp_all_age %>% filter(!grepl("NHS", geog)) %>% 
  mutate(perc_met = if_else((geog == "Aberdeen City" & fy %in% c("2019/20", "2020/21")) | is.na(perc_met),  
          0, perc_met)) %>% 
  mutate(key = paste0(fy,geog), .before = geog)

ldp_age_data_ijb <- SharedData$new(ldp_ijb_age, key = ~key,  group = "ijb_age_ldp")

data_filter_ijb_age_ldp <- filter_select(id = "filter_ijb_age_ldp",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = ldp_age_data_ijb,
                                    multiple = FALSE
                                      )

data_filter_ijb_age_ldp_geog <- filter_select(id = "filter_ijb_age_ldp_geog",
                                    label = "Select Integration Authority Area(s):",
                                    group = ~geog,
                                    sharedData = ldp_age_data_ijb,
                                    multiple = TRUE
                                      )


bscols(widths = c(1,5,NA),
       NULL,
       data_filter_ijb_age_ldp,
       NULL)

bscols(widths = c(1,10,NA), NULL, data_filter_ijb_age_ldp_geog, NULL)

```


<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px">Percentage of referrals who received a minimum of one year’s PDS by Age Group and Integration Authority Area</h2>
```{r plot-ijb-age-ldp}
bscols(widths = 12,
  div(style = css(width="98%", height="350px", marginBottom="-20px"),
plot_ly(ldp_age_data_ijb, x = ~geog, y = ~perc_met, meta = ~fy, hovertext = ~age_grp_2, type = 'bar', color = ~age_grp_2, colors = age_colours, 
        hovertemplate = paste0("%{x} <br>", "%{meta} <br>", "Age Group: %{hovertext} <br>",
                            "%{y}<extra></extra>")) %>% 
  layout(clickmode = "none", 
         showlegend = TRUE, legend = list(orientation = 'h', x = 0.5, y = 100, xanchor = "center"),
         margin = list(l = -5, b = 10, t = 40),
         xaxis = list(title = "", showline = FALSE, linecolor = "#b3b3b3",
                      categoryorder = "trace", tickangle = -45, titlefont = list(size = 16)),
         yaxis = list(title = "", linecolor = "#b3b3b3", ticksuffix = "%")
      ) %>%
  config(displayModeBar = TRUE, doubleClick = F,
         modeBarButtonsToRemove = list('select2d', 'lasso2d', 'zoomIn2d', 
                                       'zoomOut2d', 'autoScale2d', 
                                       'toggleSpikelines', 
                                       'hoverCompareCartesian', 
                                       'hoverClosestCartesian', 'toImage'), 
         displaylogo = F, editable = F)
  )
)

```


```{r table-ijb-age-ldp}
ijb_ldp_age_table_data <- ijb_table_ldp(ldp_all_age, age_grp_2)

ijb_age_table_ldp <- SharedData$new(ijb_ldp_age_table_data, key = ~key, group = "ijb_age_ldp")

bscols(widths = 12,
       div(style = css(width="97%", height="545px", margin="20px"),
DT::datatable(ijb_age_table_ldp, rownames = FALSE, selection = "none", #extensions = "FixedColumns",
              options = list(pageLength = 66,
                             scrollX = TRUE,
                            # fixedColumns = list(leftColumns = 4),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,2)),
                                               list(className = 'dt-right', targets = 4:6)
                                               ))) %>%
           DT::formatStyle(c(2,4), fontWeight = "bold"
                          )
        )
     )
```

### **Health Boards**

```{r dropdown-hb-age-ldp}
ldp_hb_age <- ldp_all_age %>% filter(geog == "Scotland" | grepl("NHS", geog))%>% 
 mutate(perc_met = if_else((geog == "NHS Grampian" & fy %in% c("2019/20", "2020/21")) | is.na(perc_met),  
          0, perc_met)) %>% 
         mutate(key = paste0(fy,geog), .before = geog)

ldp_age_data_hb <- SharedData$new(ldp_hb_age, key = ~key, group = "hb_age_ldp")

data_filter_hb_age_ldp <- filter_select(id = "filter_hb_age_ldp",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = ldp_age_data_hb,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_hb_age_ldp,
       NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px">Percentage of referrals who received a minimum of one year’s PDS by Age Group and Health Board</h2>
```{r plot-hb-age-ldp}

bscols(widths = 12,
  div(style = css(width="98%", height="365px", marginBottom="-20px"),
plot_ly(ldp_age_data_hb, x = ~geog, y = ~perc_met, meta = ~fy, hovertext = ~age_grp_2, type = 'bar', color = ~age_grp_2, colors = age_colours, 
        hovertemplate = paste0("%{x} <br>", "%{meta} <br>", "Age Group: %{hovertext} <br>",
                            "%{y}<extra></extra>")) %>% 
  layout(clickmode = "none", 
         showlegend = TRUE, legend = list(orientation = 'h', x = 0.5, y = 100, xanchor = "center"), 
         margin = list(l = -5, b = 10, t = 40),
         xaxis = list(title = "", showline = FALSE, linecolor = "#b3b3b3",
                      categoryorder = "array", categoryarray = ldp_hb_age$geog, tickangle = -45, titlefont = list(size = 16)),
         yaxis = list(title = "", linecolor = "#b3b3b3", ticksuffix = "%")
      ) %>%
  config(displayModeBar = TRUE, doubleClick = F,
         modeBarButtonsToRemove = list('select2d', 'lasso2d', 'zoomIn2d', 
                                       'zoomOut2d', 'autoScale2d', 
                                       'toggleSpikelines', 
                                       'hoverCompareCartesian', 
                                       'hoverClosestCartesian', 'toImage'), 
         displaylogo = F, editable = F)
  )
)

```


```{r table-hb-age-ldp}
hb_ldp_age_table_data <- hb_table_ldp(ldp_all_age, age_grp_2)

hb_age_table_ldp <- SharedData$new(hb_ldp_age_table_data, key = ~key, group = "hb_age_ldp")

bscols(widths = 12,
       div(style = css(width="97%", height="620px", margin="20px", marginTop="0px"),
DT::datatable(hb_age_table_ldp, rownames = FALSE, selection = "none", #extensions = "FixedColumns",
              options = list(pageLength = 30,
                             scrollX = TRUE,
                             #fixedColumns = list(leftColumns = 4),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,2)),
                                               list(className = 'dt-right', targets = 4:6)
                                               ))) %>%
           DT::formatStyle(c(2,4), fontWeight = "bold"
                          )
        )
     )
```

### **Trend**

```{r dropdown-ldp-age-trend}

ldp_all_age_data <- SharedData$new(
 ldp_all_age %>% 
  mutate(perc_met = if_else(
    geog == "Scotland" | (geog =="Aberdeen City" & fy %in% c("2019/20", "2020/21")) | (geog == "NHS Grampian" & fy %in% c("2019/20", "2020/21")),
    NA, perc_met)), 
        key = ~geog, 
    group = "ldp_age")

data_filter_ldp_age <- filter_select(id = "filter_ldp_age",
                                    label = "Select Integration Authority Area or Health Board:",
                                    group = ~geog,
                                    sharedData = ldp_all_age_data,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_ldp_age,
       NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 15px">Percentage of referrals who received a minimum of one year’s PDS by Age Group and Financial Year</h2>
```{r plot-ldp-age-trend-legend}
legend_data_age_ldp<- SharedData$new(legend_data,
  key = ~geog, group = "ldp_age")

bscols(widths = 12,
       div(style = css(height="30px"),
plot_ldp_line_legend(legend_data_age_ldp)),NULL
)
```

```{r plot-ldp-age-trend}
bscols(widths = 12,
  div(style = css(width="98%", height="330px"),
plot_ldp_line(ldp_all_age_data, measure = age_grp_2, measure_text = "Age Group: ", colours = age_colours))
)

```


```{r table-ldp-age-trend}
ldp_age_table_data <- trend_table_ldp(ldp_all_age, age_grp_2) %>% 
  arrange(geog, age_grp_2) %>% 
            mutate(across(everything(), ~replace_na(.x, "-"))) %>% 
  mutate(age_grp_2 = if_else(type == "% Met Standard/Exempt", " ", age_grp_2)) %>% 
   rename(`Age Group` = age_grp_2) %>% 
  rename(" " = "type")

ldp_age_table <- SharedData$new(ldp_age_table_data, key = ~geog, group = "ldp_age")

bscols(widths = 12,
       div(style = css(width="97%", height="275px", margin="20px"),
DT::datatable(ldp_age_table, rownames = FALSE, selection = 'none',
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right',
                                                    targets = 3:(length(full_years)+2))
                                               ))) %>%
           DT::formatStyle(2:3, fontWeight = "bold")
        )
     )

```


Gender {data-navmenu="Demographics"}
=================================================

Sidebar - gender rates {.sidebar}
-----------------------------------------------------------------------

<br>

### Gender - Rates per 10,000 population 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[**Rates per 10,000 population**](#gender)</li>
  <li>[Outcomes](#gender-outcomes)</li>
</ul>


***

**FURTHER INFORMATION:**

<ul style="list-style-type:square;">
   <li >[Glossary](#glossary)</li>
   <li >[Navigation Guide](#navigation-guide)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

This page includes rates of the number of people referred to PDS per 10,000 population (65 years and over) for males and females. *See the [Glossary](#glossary) for more details.* 

The Integration Authority Area and Health Board tabs include a chart and table showing the rates for each geographical area for the selected financial year.  

The Trend tab shows the trend of the rate by financial year for Scotland and the selected geographical area for each gender. The table below the chart shows the rates for the selected geographical area. 

*The figures shown for `r provisional_year` onwards are currently provisional and subject to change in future versions of this report.*

`r if(qt != 4) {div(style = css(fontStyle="italic"),paste0("For diagnoses in financial year ", current_fy, " data is available up to and including Q", qt, "."))}`


Row {.tabset data-height=1180}
----------------------------------------------------------------------

### **Integration Authority Areas**

```{r dropdown-ijb-sex-pop}
pds_ijb_sex_rates <- pds_all_sex_rates %>% filter(!grepl("NHS", geog)) %>%
  mutate(pop_rate_10000 = if_else(is.na(pop_rate_10000), 0, pop_rate_10000))  #this was added to avoid any areas with missing data being placed at the end of the chart

pds_pop_sex_data_ijb <- SharedData$new(pds_ijb_sex_rates, key = ~fy, group = "ijb_sex_pop")

data_filter_ijb_sex_pop <- filter_select(id = "filter_ijb_sex_pop",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = pds_pop_sex_data_ijb,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_ijb_sex_pop,
       NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Number of people referred to PDS per 10,000 population (65+) by Gender and Integration Authority Area</h2>
```{r plot-ijb-sex-pop}
bscols(widths = 12,
  div(style = css(width="98%", height="350px", marginBottom="-20px"),
plot_ly(pds_pop_sex_data_ijb, x = ~geog, y = ~pop_rate_10000, meta = ~fy, hovertext = ~sex, type = 'bar', color = ~sex, colors = sex_colours,
        hovertemplate = paste0("%{x} <br>", "%{meta} <br>", "Gender: %{hovertext} <br>",
                            "Rate per 10,000 Population: %{y}<extra></extra>")) %>% 
  layout(clickmode = "none", 
         showlegend = TRUE, legend = list(orientation = 'h', x = 0.5, y = 100, xanchor = "center"),
         margin = list(l = -5, b = 10, t = 40),
         xaxis = list(title = "", showline = FALSE, linecolor = "#b3b3b3",
                      categoryorder = "trace", tickangle = -45, titlefont = list(size = 16)),
         yaxis = list(title = "Rate per 10,000 Population", linecolor = "#b3b3b3", titlefont = list(size = 16),
                      range = c(0,max(pds_ijb_sex_rates$pop_rate_10000)))
      ) %>%
  config(displayModeBar = TRUE, doubleClick = F,
         modeBarButtonsToRemove = list('select2d', 'lasso2d', 'zoomIn2d', 
                                       'zoomOut2d', 'autoScale2d', 
                                       'toggleSpikelines', 
                                       'hoverCompareCartesian', 
                                       'hoverClosestCartesian', 'toImage'), 
         displaylogo = F, editable = F)
  )
)

```


```{r table-ijb-sex-pop}

ijb_pop_sex_table_data <- pds_all_sex_rates %>%
  filter(!grepl("NHS", geog)) %>% 
  select(geog,fy,sex,pop_rate_10000) %>% mutate(pop_rate_10000 = as.character(pop_rate_10000)) %>% 
    arrange(sex) %>% 
  pivot_wider(names_from = sex, values_from = pop_rate_10000, values_fill = "-") %>%  
            rename(`Integration Authority Area` = geog)


ijb_sex_table_pop <- SharedData$new(ijb_pop_sex_table_data, key = ~fy, group = "ijb_sex_pop")


bscols(widths = 12,
       div(style = css(width="97%", height="630px", margin="20px"),
DT::datatable(ijb_sex_table_pop, rownames = FALSE, selection = 'none',#extensions = "FixedColumns",
              options = list(pageLength = 33,
                             scrollX = TRUE,
                           #  fixedColumns = list(leftColumns = 1),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 1),
                                               list(className = 'dt-right', targets = 2:3)
                                               ))) %>%
           DT::formatStyle(1, fontWeight = "bold"#, padding = "4px"
                          )
        )
     )



```

### **Health Boards**

```{r dropdown-hb-sex-pop}
pds_hb_sex_rates <- pds_all_sex_rates %>% filter(geog == "Scotland" | grepl("NHS", geog)) 

pds_pop_sex_data_hb <- SharedData$new(pds_hb_sex_rates, key = ~fy, group = "hb_sex_pop")

data_filter_hb_sex_pop <- filter_select(id = "filter_hb_sex_pop",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = pds_pop_sex_data_hb,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_hb_sex_pop,
       NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Number of people referred to PDS per 10,000 population (65+) by Gender and Health Board</h2>
```{r plot-hb-sex-pop}
bscols(widths = 12,
  div(style = css(width="98%", height="365px", marginBottom="-20px"),
plot_ly(pds_pop_sex_data_hb, x = ~geog, y = ~pop_rate_10000, meta = ~fy, hovertext = ~sex, type = 'bar', color = ~sex, colors = sex_colours, 
        hovertemplate = paste0("%{x} <br>", "%{meta} <br>", "Gender: %{hovertext} <br>",
                            "Rate per 10,000 Population: %{y}<extra></extra>")) %>% 
  layout(clickmode = "none", 
         showlegend = TRUE, legend = list(orientation = 'h', x = 0.5, y = 100, xanchor = "center"),
         margin = list(l = -5, b = 10, t = 40),
         xaxis = list(title = "", showline = FALSE, linecolor = "#b3b3b3",
                      categoryorder = "array", categoryarray = pds_hb_sex_rates$geog, tickangle = -45, titlefont = list(size = 16)),
         yaxis = list(title = "Rate per 10,000 Population", linecolor = "#b3b3b3", titlefont = list(size = 16),
                      range = c(0,max(pds_hb_sex_rates$pop_rate_10000)))
      ) %>%
  config(displayModeBar = TRUE, doubleClick = F,
         modeBarButtonsToRemove = list('select2d', 'lasso2d', 'zoomIn2d', 
                                       'zoomOut2d', 'autoScale2d', 
                                       'toggleSpikelines', 
                                       'hoverCompareCartesian', 
                                       'hoverClosestCartesian', 'toImage'), 
         displaylogo = F, editable = F)
  )
)

```


```{r table-hb-sex-pop}

hb_pop_sex_table_data <- pds_all_sex_rates %>% filter(geog == "Scotland" | grepl("NHS", geog)) %>% 
  select(geog,fy,sex,pop_rate_10000) %>% mutate(pop_rate_10000 = as.character(pop_rate_10000)) %>%
  arrange(sex) %>% 
  pivot_wider(names_from = sex, values_from = pop_rate_10000, values_fill = "-") %>% 
   rename(`Health Board` = geog)

hb_sex_table_pop <- SharedData$new(hb_pop_sex_table_data, key = ~fy, group = "hb_sex_pop")

bscols(widths = 12,
       div(style = css(width="97%", height="620px", margin="20px"),
DT::datatable(hb_sex_table_pop, rownames = FALSE, selection = 'none',# extensions = "FixedColumns",
              options = list(pageLength = 15,
                             scrollX = TRUE,
                          #   fixedColumns = list(leftColumns = 1),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 1),
                                               list(className = 'dt-right', targets = 2:3)
                                               ))) %>%
           DT::formatStyle(1, fontWeight = "bold"
                          )
        )
     )

```

### **Trend**

```{r dropdown-trend-sex-pop}

pds_pop_sex_data <- SharedData$new(pds_all_sex_rates %>% 
  mutate(pop_rate_10000 = if_else(geog == "Scotland", NA, pop_rate_10000)),
  key = ~geog, group = "trend_sex_pop")

data_filter_trend_sex_pop <- filter_select(id = "filter_trend_sex_pop",
                                    label = "Select Integration Authority Area or Health Board:",
                                    group = ~geog,
                                    sharedData = pds_pop_sex_data,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_trend_sex_pop,
       NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 15px"> Number of people referred to PDS per 10,000 population (65+) by Gender and Financial Year</h2>
```{r plot-trend-sex-legend-pop}
legend_data_sex<- SharedData$new(legend_data,
  key = ~geog, group = "trend_sex_pop")

bscols(widths = 12,
       div(style = css(height="30px"),
plot_rate_line_legend(legend_data_sex)),NULL
)

```


```{r plot-trend-sex-pop}
bscols(widths = 12,
  div(style = css(width="98%", height="330px"),
plot_rate_line(pds_pop_sex_data, measure = sex, measure_text = "Gender: ", y = "Rate per 10,000 Population"))
)

```


```{r table-trend-sex-pop}
trend_pop_sex_table_data <- pds_all_sex_rates %>% filter(!is.na(pop_rate_10000)) %>% 
  select(geog,fy,sex,pop_rate_10000) %>%
  pivot_wider(names_from = fy, values_from = pop_rate_10000) %>% arrange(sex) %>% 
             rename(`Gender` = sex)

trend_pop_sex_table <- SharedData$new(trend_pop_sex_table_data, key = ~geog, group = "trend_sex_pop")

bscols(widths = 12,
       div(style = css(width="97%", height="120px", margin="20px"),
DT::datatable(trend_pop_sex_table, rownames = FALSE, selection = 'none',
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0)
                                               ))) %>%
           DT::formatStyle(2, fontWeight = "bold"#, padding = "4px"
                          )
        )
     )
```

Gender Outcomes {.hidden}
=====================================
Sidebar - gender outcomes{.sidebar}
-----------------------------------------------------------------------

<br>

### Gender - Outcomes 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Rates per 10,000 population](#gender)</li>
  <li>[**Outcomes**](#gender-outcomes)</li>
</ul>

***

**FURTHER INFORMATION:**

<ul style="list-style-type:square;">
   <li >[Methodology](#methodology)</li>
   <li >[Glossary](#glossary)</li>
   <li >[Navigation Guide](#navigation-guide)</li>
</ul>


***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

This page shows the percentage of referrals that have received one year’s support which started within a year of diagnosis (or have been exempt from the LDP Standard) for males and females.  

The Integration Authority Area and Health Board tabs include a chart and table showing the percentages for each geographical area.  

The Trend tab shows the trend of the percentage of referrals that have received one year’s support by financial year for Scotland and the selected geographical area for each gender. The table below the chart shows the figures for the selected geographical area. 

*The figures shown for `r provisional_year` onwards are currently provisional and subject to change in future versions of this report.*

`r if(qt != 4) {div(style = css(fontStyle="italic"),paste("LDP Standard performance figures are not provided until data is available for the full financial year."))}`
`r if(qt != 4) {HTML("<br>")}`
**Please note:** *Aberdeen City Health & Social Care Partnership changed to provide PDS in 2019 to an inhouse hybrid model. This change in model, and process of receiving referrals and recording, resulted in data quality issues for financial years 2019/20 and 2020/21. This should be taken into account when interpreting figures for Aberdeen City and NHS Grampian.*


**Please note:** *NHS Shetland did not have a PDS worker in post from 2022/23 Q1 through 2023/24 Q3. As a result not all people referred to PDS could be allocated or contacted by a PDS worker within 12 months of diagnosis, hence they have been recorded as not having met the standard. A PDS worker was assigned in 2023/24 Q4 and the PDS service in Shetland has resumed.*

Row {.tabset data-height=1180}
----------------------------------------------------------------------

### **Integration Authority Areas**

```{r dropdown-ijb-sex-ldp}
ldp_ijb_sex <- ldp_all_sex %>% filter(!grepl("NHS", geog))  %>% 
 mutate(perc_met = if_else((geog == "Aberdeen City" & fy %in% c("2019/20", "2020/21")) | is.na(perc_met),  
          0, perc_met)) %>% 
  mutate(key = paste0(fy,geog), .before = geog)

ldp_sex_data_ijb <- SharedData$new(ldp_ijb_sex, key = ~key,  group = "ijb_sex_ldp")

data_filter_ijb_sex_ldp <- filter_select(id = "filter_ijb_sex_ldp",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = ldp_sex_data_ijb,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_ijb_sex_ldp,
       NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px">Percentage of referrals who received a minimum of one year’s PDS by Gender and Integration Authority Area</h2>
```{r plot-ijb-sex-ldp}
bscols(widths = 12,
  div(style = css(width="98%", height="350px", marginBottom="-20px"),
plot_ly(ldp_sex_data_ijb, x = ~geog, y = ~perc_met, meta = ~fy, hovertext = ~sex, type = 'bar', color = ~sex, colors = sex_colours, 
        hovertemplate = paste0("%{x} <br>", "%{meta} <br>", "Gender: %{hovertext} <br>",
                            "%{y}<extra></extra>")) %>% 
  layout(clickmode = "none", 
         showlegend = TRUE, legend = list(orientation = 'h', x = 0.5, y = 100, xanchor = "center"),
         margin = list(l = -5, b = 10, t = 40),
         xaxis = list(title = "", showline = FALSE, linecolor = "#b3b3b3",
                      categoryorder = "trace", tickangle = -45, titlefont = list(size = 16)),
         yaxis = list(title = "", linecolor = "#b3b3b3", ticksuffix = "%")
      ) %>%
  config(displayModeBar = TRUE, doubleClick = F,
         modeBarButtonsToRemove = list('select2d', 'lasso2d', 'zoomIn2d', 
                                       'zoomOut2d', 'autoScale2d', 
                                       'toggleSpikelines', 
                                       'hoverCompareCartesian', 
                                       'hoverClosestCartesian', 'toImage'), 
         displaylogo = F, editable = F)
  )
)

```


```{r table-ijb-sex-ldp}
ijb_ldp_sex_table_data <- ijb_table_ldp(ldp_all_sex, sex)

ijb_sex_table_ldp <- SharedData$new(ijb_ldp_sex_table_data, key = ~key, group = "ijb_sex_ldp")

bscols(widths = 12,
       div(style = css(width="97%", height="545px", margin="20px"),
DT::datatable(ijb_sex_table_ldp, rownames = FALSE, selection = "none", #extensions = "FixedColumns",
              options = list(pageLength = 66,
                             scrollX = TRUE,
                            # fixedColumns = list(leftColumns = 4),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,2)),
                                               list(className = 'dt-right', targets = 4:5)
                                               ))) %>%
           DT::formatStyle(c(2,4), fontWeight = "bold"
                          )
        )
     )

```

### **Health Boards**

```{r dropdown-hb-sex-ldp}
ldp_hb_sex <- ldp_all_sex %>% filter(geog == "Scotland" | grepl("NHS", geog)) %>% 
 mutate(perc_met = if_else((geog == "NHS Grampian" & fy %in% c("2019/20", "2020/21")) | is.na(perc_met),  
          0, perc_met)) %>% 
  mutate(key = paste0(fy,geog), .before = geog)

ldp_sex_data_hb <- SharedData$new(ldp_hb_sex, key = ~key, group = "hb_sex_ldp")

data_filter_hb_sex_ldp <- filter_select(id = "filter_hb_sex_ldp",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = ldp_sex_data_hb,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_hb_sex_ldp,
       NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px">Percentage of referrals who received a minimum of one year’s PDS by Gender and Health Board</h2>
```{r plot-hb-sex-ldp}
bscols(widths = 12,
  div(style = css(width="98%", height="365px", marginBottom="-20px"),
plot_ly(ldp_sex_data_hb, x = ~geog, y = ~perc_met, meta = ~fy, hovertext = ~sex, type = 'bar', color = ~sex, colors = sex_colours, 
        hovertemplate = paste0("%{x} <br>", "%{meta} <br>", "Gender: %{hovertext} <br>",
                            "%{y}<extra></extra>")) %>% 
  layout(clickmode = "none", 
         showlegend = TRUE, legend = list(orientation = 'h', x = 0.5, y = 100, xanchor = "center"), 
         margin = list(l = -5, b = 10, t = 40),
         xaxis = list(title = "", showline = FALSE, linecolor = "#b3b3b3",
                      categoryorder = "array", categoryarray = ldp_hb_sex$geog, tickangle = -45, titlefont = list(size = 16)),
         yaxis = list(title = "", linecolor = "#b3b3b3", ticksuffix = "%")
      ) %>%
  config(displayModeBar = TRUE, doubleClick = F,
         modeBarButtonsToRemove = list('select2d', 'lasso2d', 'zoomIn2d', 
                                       'zoomOut2d', 'autoScale2d', 
                                       'toggleSpikelines', 
                                       'hoverCompareCartesian', 
                                       'hoverClosestCartesian', 'toImage'), 
         displaylogo = F, editable = F)
  )
)

```


```{r table-hb-sex-ldp}
hb_ldp_sex_table_data <- hb_table_ldp(ldp_all_sex, sex)

hb_sex_table_ldp <- SharedData$new(hb_ldp_sex_table_data, key = ~key, group = "hb_sex_ldp")

bscols(widths = 12,
       div(style = css(width="97%", height="620px", margin="20px", marginTop="0px"),
DT::datatable(hb_sex_table_ldp, rownames = FALSE, selection = "none", #extensions = "FixedColumns",
              options = list(pageLength = 30,
                             scrollX = TRUE,
                             #fixedColumns = list(leftColumns = 4),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,2)),
                                               list(className = 'dt-right', targets = 4:5)
                                               ))) %>%
           DT::formatStyle(c(2,4), fontWeight = "bold"
                          )
        )
     )

```

### **Trend**

```{r dropdown-ldp-sex}

ldp_all_sex_data <- SharedData$new(ldp_all_sex %>% 
  mutate(perc_met = if_else(
    geog == "Scotland" | (geog =="Aberdeen City" & fy %in% c("2019/20", "2020/21")) | (geog == "NHS Grampian" & fy %in% c("2019/20", "2020/21")), NA, perc_met)), 
  key = ~geog, group = "ldp_sex")

data_filter_ldp_sex <- filter_select(id = "filter_ldp_sex",
                                    label = "Select Integration Authority Area or Health Board:",
                                    group = ~geog,
                                    sharedData = ldp_all_sex_data,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_ldp_sex,
       NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 20px">Percentage of referrals who received a minimum of one year’s PDS by Gender and Financial Year </h2>
```{r plot-ldp-sex-legend}
legend_data_sex_ldp<- SharedData$new(legend_data,
  key = ~geog, group = "ldp_sex")

bscols(widths = 12,
       div(style = css(height="30px"),
plot_ldp_line_legend(legend_data_sex_ldp)),NULL
)

```

```{r plot-ldp-sex}
bscols(widths = 12,
  div(style = css(width="98%", height="330px"),
plot_ldp_line(ldp_all_sex_data, measure = sex, measure_text = "Gender: "))
)

```


```{r table-ldp-sex}

ldp_sex_table_data <- trend_table_ldp(ldp_all_sex, sex) %>%
  arrange(geog, sex) %>% 
            mutate(across(everything(), ~replace_na(.x, "-"))) %>% 
  mutate(sex = if_else(type == "% Met Standard/Exempt", " ", sex)) %>% 
   rename(`Gender` = sex) %>% 
  rename(" " = "type")

ldp_sex_table <- SharedData$new(ldp_sex_table_data, key = ~geog, group = "ldp_sex")

bscols(widths = 12,
       div(style = css(width="97%", height="195px", margin="20px"),
DT::datatable(ldp_sex_table, rownames = FALSE, selection = 'none',
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right',
                                                    targets = 3:(length(full_years)+2))
                                               ))) %>%
           DT::formatStyle(2:3, fontWeight = "bold")
        )
     )

```

Deprivation (SIMD) {data-navmenu="Demographics"}
=====================================

Sidebar -simd rates{.sidebar}
-----------------------------------------------------------------------

<br>

### Deprivation - Rates per 10,000 population 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[**Rates per 10,000 population**](#deprivation-simd)</li>
  <li>[Outcomes](#simd-outcomes)</li>
</ul>

***

**FURTHER INFORMATION:**

<ul style="list-style-type:square;">
   <li >[Glossary](#glossary)</li>
   <li >[Navigation Guide](#navigation-guide)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

This page includes rates of the number of people referred to PDS per 10,000 population (65 years and over) for deprivation (Scottish Index of Multiple Deprivation (SIMD)) quintiles. *See the [Glossary](#glossary) for more details.*

The Integration Authority Area and Health Board tabs include a chart and table showing the rates for each geographical area for the selected financial year. For the Integration Authority tab use the dropdown menu to select areas to show in the charts and tables. 

The Trend tab shows the trend of the rate by financial year for Scotland and the selected geographical area for each quintile. The table below the chart shows the rates for the selected geographical area. 

*The figures shown for `r provisional_year` onwards are currently provisional and subject to change in future versions of this report.*

`r if(qt != 4) {div(style = css(fontStyle="italic"),paste0("For diagnoses in financial year ", current_fy, " data is available up to and including Q", qt, "."))}`


<!-- **Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.** -->


Row {.tabset data-height=1180}
----------------------------------------------------------------------

### **Integration Authority Areas**

```{r dropdown-ijb-simd-pop}
pds_ijb_simd_rates <- 
   pds_all_simd_rates %>% filter(!grepl("NHS", geog)) %>% 
  mutate(pop_rate_10000 = if_else(is.na(pop_rate_10000), 0, pop_rate_10000)) %>% #this was added to avoid any areas with missing data being placed at the end of the chart
         mutate(simd_group = "All", .before = simd)  %>% 
  mutate(key = paste0(fy,simd_group,geog), .before = geog)

pds_pop_simd_data_ijb <- SharedData$new(pds_ijb_simd_rates, key = ~key, group = "ijb_simd_pop")

data_filter_ijb_simd_pop <- filter_select(id = "filter_ijb_simd_pop",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = pds_pop_simd_data_ijb,
                                    multiple = FALSE
                                      )

# data_filter_ijb_simd_pop_quintile <- filter_select(id = "filter_ijb_simd_pop_quintile",
#                                     label = "Select SIMD Quintile:",
#                                     group = ~simd_group,
#                                     sharedData = pds_pop_simd_data_ijb,
#                                     multiple = FALSE
#                                       )

data_filter_ijb_simd_pop_geog <- filter_select(id = "filter_ijb_simd_pop_geog",
                                    label = "Select Integration Authority Area(s):",
                                    group = ~geog,
                                    sharedData = pds_pop_simd_data_ijb,
                                    multiple = TRUE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_ijb_simd_pop,
       NULL)

bscols(widths = c(1,10,NA), NULL, data_filter_ijb_simd_pop_geog, NULL)
```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Number of people referred to PDS per 10,000 population (65+) by Deprivation Quintile and Integration Authority Area</h2>
```{r plot-ijb-simd-pop}

bscols(widths = 12,
  div(style = css(width="98%", height="350px", marginBottom="-20px"),
plot_ly(pds_pop_simd_data_ijb, x = ~geog, y = ~pop_rate_10000, meta = ~fy, hovertext = ~simd, type = 'bar', color = ~simd, colors = simd_colours, 
        hovertemplate = paste0("%{x} <br>", "%{meta} <br>", "deprivation quintile: %{hovertext} <br>",
                            "Rate per 10,000 Population: %{y}<extra></extra>")) %>% 
  layout(clickmode = "none",
         showlegend = TRUE, legend = list(orientation = 'h', x = 0.5, y = 100, xanchor = "center"),
         margin = list(l = -5, b = 10, t = 40),
         xaxis = list(title = "", showline = FALSE, linecolor = "#b3b3b3",
                      categoryorder = "trace", tickangle = -45, titlefont = list(size = 16)),
         yaxis = list(title = "Rate per 10,000 Population", linecolor = "#b3b3b3", titlefont = list(size = 16))
      ) %>%
  config(displayModeBar = TRUE, doubleClick = F,
         modeBarButtonsToRemove = list('select2d', 'lasso2d', 'zoomIn2d', 
                                       'zoomOut2d', 'autoScale2d', 
                                       'toggleSpikelines', 
                                       'hoverCompareCartesian', 
                                       'hoverClosestCartesian', 'toImage'), 
         displaylogo = F, editable = F)
  )
)

```


```{r table-ijb-simd-pop}

ijb_pop_simd_table_data <- #bind_rows(
  
  # pds_all_simd_rates %>%
  # filter(!grepl("NHS", geog)) %>%
  # select(geog,fy,simd,pop_rate_10000) %>%
  #  mutate(simd_group = simd, .before = simd),

  pds_all_simd_rates %>%
  filter(!grepl("NHS", geog)) %>%
  select(geog,fy,simd,pop_rate_10000) %>%
   mutate(simd_group = "All", .before = simd
          ) %>% 
  
     mutate(pop_rate_10000 = as.character(pop_rate_10000)) %>%
  pivot_wider(names_from = simd, values_from = pop_rate_10000) %>%
  mutate(key = paste0(fy,simd_group,geog), .before = geog) %>% 
  mutate(across(everything(), ~if_else(simd_group == "All", 
                                       replace_na(.x, "-"), 
                                       replace_na(.x, " ")))) %>%
             rename(`Integration Authority Area` = geog)


ijb_simd_table_pop <- SharedData$new(ijb_pop_simd_table_data, key = ~key, group = "ijb_simd_pop")


bscols(widths = 12,
       div(style = css(width="97%", height="555px", margin="20px"),
DT::datatable(ijb_simd_table_pop, rownames = FALSE, selection = 'none',
              options = list(pageLength = 33,
                             scrollX = TRUE,
                            # fixedColumns = list(leftColumns = 1),
                             scrollY = FALSE,
                             dom = "Bt",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,2,3)),
                                               list(className = 'dt-right', targets = 4:8)
                                               ))) %>%
           DT::formatStyle(2, fontWeight = "bold"#, padding = "4px"
                          )
        )
     )


```


### **Health Boards**

```{r dropdown-hb-simd-pop}
pds_hb_simd_rates <- pds_all_simd_rates %>% filter(geog == "Scotland" | grepl("NHS", geog)) %>% 
         mutate(simd_group = "All", .before = simd)  %>% 
  mutate(key = paste0(fy,simd_group,geog), .before = geog)


pds_pop_simd_data_hb <- SharedData$new(pds_hb_simd_rates, key = ~key, group = "hb_simd_pop")

data_filter_hb_simd_pop <- filter_select(id = "filter_hb_simd_pop",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = pds_pop_simd_data_hb,
                                    multiple = FALSE
                                      )

# data_filter_hb_simd_pop_quintile <- filter_select(id = "filter_hb_simd_pop_quintile",
#                                     label = "Select SIMD Quintile:",
#                                     group = ~simd_group,
#                                     sharedData = pds_pop_simd_data_hb,
#                                     multiple = FALSE
#                                       )
# 
# data_filter_hb_simd_pop_geog <- filter_select(id = "filter_hb_simd_pop_geog",
#                                     label = "Select Health Board(s):",
#                                     group = ~geog,
#                                     sharedData = pds_pop_simd_data_hb,
#                                     multiple = TRUE
#                                       )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_hb_simd_pop,
       NULL)

# bscols(widths = c(1,10,NA), NULL, data_filter_hb_simd_pop_geog, NULL)
```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px"> Number of people referred to PDS per 10,000 population (65+) by Deprivation Quintile and Health Board</h2>
```{r plot-hb-simd-pop}

bscols(widths = 12,
  div(style = css(width="98%", height="365px", marginBottom="-20px"),
plot_ly(pds_pop_simd_data_hb, x = ~geog, y = ~pop_rate_10000, meta = ~fy, hovertext = ~simd, type = 'bar', color = ~simd, colors = simd_colours, 
        hovertemplate = paste0("%{x} <br>", "%{meta} <br>", "deprivation quintile: %{hovertext} <br>",
                            "Rate per 10,000 Population: %{y}<extra></extra>")) %>% 
  layout(clickmode = "none", 
         showlegend = TRUE, legend = list(orientation = 'h', x = 0.5, y = 100, xanchor = "center"),
         margin = list(l = -5, b = 10, t = 40),
         xaxis = list(title = "", showline = FALSE, linecolor = "#b3b3b3",
                      categoryorder = "array", categoryarray = pds_hb_simd_rates$geog, tickangle = -45, titlefont = list(size = 16)),
         yaxis = list(title = "Rate per 10,000 Population", linecolor = "#b3b3b3", titlefont = list(size = 16))
      ) %>%
  config(displayModeBar = TRUE, doubleClick = F,
         modeBarButtonsToRemove = list('select2d', 'lasso2d', 'zoomIn2d', 
                                       'zoomOut2d', 'autoScale2d', 
                                       'toggleSpikelines', 
                                       'hoverCompareCartesian', 
                                       'hoverClosestCartesian', 'toImage'), 
         displaylogo = F, editable = F)
  )
)

```


```{r table-hb-simd-pop}

 hb_pop_simd_table_data <- #bind_rows(
#   
#   pds_all_simd_rates %>%
#   filter(geog == "Scotland" | grepl("NHS", geog)) %>%
#   select(geog,fy,simd,pop_rate_10000) %>%
#    mutate(simd_group = simd, .before = simd),

  pds_all_simd_rates %>%
  filter(geog == "Scotland" | grepl("NHS", geog)) %>%
  select(geog,fy,simd,pop_rate_10000) %>%
   mutate(simd_group = "All", .before = simd
) %>% 
  
     mutate(pop_rate_10000 = as.character(pop_rate_10000)) %>%
  pivot_wider(names_from = simd, values_from = pop_rate_10000) %>%
  mutate(key = paste0(fy,simd_group,geog), .before = geog) %>% 
  mutate(across(everything(), ~if_else(simd_group == "All", 
                                       replace_na(.x, "-"), 
                                       replace_na(.x, " ")))) %>%
             rename(`Health Board` = geog)


hb_simd_table_pop <- SharedData$new(hb_pop_simd_table_data, key = ~key, group = "hb_simd_pop")


bscols(widths = 12,
       div(style = css(width="97%", height="620px", margin="20px"),
DT::datatable(hb_simd_table_pop, rownames = FALSE, selection = "none", #extensions = "FixedColumns",
                  options = list(pageLength = 15,
                             scrollX = TRUE,
                            # fixedColumns = list(leftColumns = 1),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,2,3)),
                                               list(className = 'dt-right', targets = 4:8)
                                               ))) %>%
           DT::formatStyle(2, fontWeight = "bold"#, padding = "4px"
                          )
        )
     )


```

### **Trend**

```{r dropdown-trend-simd-pop}

pds_pop_simd_data <- SharedData$new(pds_all_simd_rates %>% 
  mutate(pop_rate_10000 = if_else(geog == "Scotland", NA, pop_rate_10000)),
  key = ~geog, group = "trend_simd_pop")

data_filter_trend_simd_pop <- filter_select(id = "filter_trend_simd_pop",
                                    label = "Select Integration Authority Area or Health Board:",
                                    group = ~geog,
                                    sharedData = pds_pop_simd_data,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_trend_simd_pop,
       NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 15px"> Number of people referred to PDS per 10,000 population (65+) by Deprivation Quintile and Financial Year</h2> 
```{r plot-trend-simd-legend-pop}
legend_data_simd<- SharedData$new(legend_data,
  key = ~geog, group = "trend_simd_pop")

bscols(widths = 12,
       div(style = css(height="30px"),
plot_rate_line_legend(legend_data_simd)),NULL
)

```


```{r plot-trend-simd-pop}

bscols(widths = 12,
  div(style = css(width="98%", height="320px"),
plot_rate_line(pds_pop_simd_data, measure = simd, measure_text = "deprivation quintile: ", y = "Rate per 10,000 Population", colours = simd_colours))
)

```


```{r table-trend-simd-pop}

trend_pop_simd_table_data <- pds_all_simd_rates %>% filter(!is.na(pop_rate_10000)) %>% 
  select(geog,fy,simd,pop_rate_10000) %>%
  pivot_wider(names_from = fy, values_from = pop_rate_10000) %>%
             rename(`Deprivation Quintile` = simd)


trend_pop_simd_table <- SharedData$new(trend_pop_simd_table_data, key = ~geog, group = "trend_simd_pop")


bscols(widths = 12,
       div(style = css(width="97%", height="235px", margin="20px"),
DT::datatable(trend_pop_simd_table, rownames = FALSE, selection = 'none',
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right', targets = 2:9)
                                               ))) %>%
           DT::formatStyle(2, fontWeight = "bold"#, padding = "4px"
                          )
        )
     )



```

SIMD Outcomes {.hidden}
=====================================
Sidebar- simd outcomes {.sidebar}
-----------------------------------------------------------------------

<br>

### Deprivation - Outcomes 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[Rates per 10,000 population](#deprivation-simd)</li>
  <li>[**Outcomes**](#simd-outcomes)</li>
</ul>

***

**FURTHER INFORMATION:**

<ul style="list-style-type:square;">
   <li >[Methodology](#methodology)</li>
   <li >[Glossary](#glossary)</li>
   <li >[Navigation Guide](#navigation-guide)</li>
</ul>

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

This page shows the percentage of referrals that have received one year’s support which started within a year of diagnosis (or have been exempt from the LDP Standard) for deprivation (Scottish Index of Multiple Deprivation (SIMD)) quintiles.  

The Integration Authority Area and Health Board tabs include a chart and table showing the percentages for each geographical area. For the Integration Authority tab use the dropdown menu to filter for selected areas to show in the charts and table. 

The Trend tabs include a chart showing the trend of the percentage by financial year for the selected geographical area for each deprivation quintile. The table below the charts shows the figures for the selected geographical area. 

*The figures shown for `r provisional_year` onwards are currently provisional and subject to change in future versions of this report.*

`r if(qt != 4) {div(style = css(fontStyle="italic"),paste("LDP Standard performance figures are not provided until data is available for the full financial year."))}`
`r if(qt != 4) {HTML("<br>")}`
**Please note:** *Aberdeen City Health & Social Care Partnership changed to provide PDS in 2019 to an inhouse hybrid model. This change in model, and process of receiving referrals and recording, resulted in data quality issues for financial years 2019/20 and 2020/21. This should be taken into account when interpreting figures for Aberdeen City and NHS Grampian.*


**Please note:** *NHS Shetland did not have a PDS worker in post from 2022/23 Q1 through 2023/24 Q3. As a result not all people referred to PDS could be allocated or contacted by a PDS worker within 12 months of diagnosis, hence they have been recorded as not having met the standard. A PDS worker was assigned in 2023/24 Q4 and the PDS service in Shetland has resumed.*

Row {.tabset data-height=1180}
----------------------------------------------------------------------

### **Integration Authority Areas**

```{r dropdown-ijb-simd-ldp}
ldp_ijb_simd <-  ldp_all_simd %>% filter(!grepl("NHS", geog))  %>% 
 mutate(perc_met = if_else((geog == "Aberdeen City" & fy %in% c("2019/20", "2020/21")) | is.na(perc_met),  
          0, perc_met)) %>% 
  mutate(key = paste0(fy,geog), .before = geog)

ldp_simd_data_ijb <- SharedData$new(ldp_ijb_simd, key = ~key, group = "ijb_simd_ldp")

data_filter_ijb_simd_ldp <- filter_select(id = "filter_ijb_simd_ldp",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = ldp_simd_data_ijb,
                                    multiple = FALSE
                                      )


data_filter_ijb_simd_ldp_geog <- filter_select(id = "filter_ijb_simd_ldp_geog",
                                    label = "Select Integration Authority Area(s):",
                                    group = ~geog,
                                    sharedData = ldp_simd_data_ijb,
                                    multiple = TRUE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_ijb_simd_ldp,
       NULL)

bscols(widths = c(1,10,NA), NULL, data_filter_ijb_simd_ldp_geog, NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px">Percentage of referrals who received a minimum of one year’s PDS by Deprivation Quintile and Integration Authority Area</h2>
```{r plot-ijb-simd-ldp}

bscols(widths = 12,
  div(style = css(width="98%", height="350px", marginBottom="-20px"),
plot_ly(ldp_simd_data_ijb, x = ~geog, y = ~perc_met, meta = ~fy, hovertext = ~simd, type = 'bar', color = ~simd, colors = simd_colours, 
        hovertemplate = paste0("%{x} <br>", "%{meta} <br>", "deprivation quintile: %{hovertext} <br>",
                            "%{y}<extra></extra>")) %>% 
  layout(clickmode = "none", 
         showlegend = TRUE, legend = list(orientation = 'h', x = 0.5, y = 100, xanchor = "center"),
         margin = list(l = -5, b = 10, t = 40),
         xaxis = list(title = "", showline = FALSE, linecolor = "#b3b3b3",
                      categoryorder = "trace", tickangle = -45, titlefont = list(size = 16)),
         yaxis = list(title = "", linecolor = "#b3b3b3", ticksuffix = "%")
      ) %>%
  config(displayModeBar = TRUE, doubleClick = F,
         modeBarButtonsToRemove = list('select2d', 'lasso2d', 'zoomIn2d', 
                                       'zoomOut2d', 'autoScale2d', 
                                       'toggleSpikelines', 
                                       'hoverCompareCartesian', 
                                       'hoverClosestCartesian', 'toImage'), 
         displaylogo = F, editable = F)
  )
)

```


```{r table-ijb-simd-ldp}
ijb_ldp_simd_table_data <- ijb_table_ldp(ldp_all_simd, simd)

ijb_simd_table_ldp <- SharedData$new(ijb_ldp_simd_table_data, key = ~key, group = "ijb_simd_ldp")

bscols(widths = 12,
       div(style = css(width="97%", height="545px", margin="20px"),
DT::datatable(ijb_simd_table_ldp, rownames = FALSE, selection = "none", #extensions = "FixedColumns",
              options = list(pageLength = 66,
                             scrollX = TRUE,
                            # fixedColumns = list(leftColumns = 4),
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,2)),
                                               list(className = 'dt-right', targets = 4:8)
                                               ))) %>%
           DT::formatStyle(c(2,4), fontWeight = "bold"
                          )
        )
     )





```

### **Health Boards**

```{r dropdown-hb-simd-ldp}
ldp_hb_simd <- ldp_all_simd %>% filter(geog == "Scotland" | grepl("NHS", geog))  %>% 
 mutate(perc_met = if_else((geog == "NHS Grampian" & fy %in% c("2019/20", "2020/21")) | is.na(perc_met),  
          0, perc_met)) %>% 
  mutate(key = paste0(fy,geog), .before = geog)

ldp_simd_data_hb <- SharedData$new(ldp_hb_simd, key = ~key, group = "hb_simd_ldp")

data_filter_hb_simd_ldp <- filter_select(id = "filter_hb_simd_ldp",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = ldp_simd_data_hb,
                                    multiple = FALSE
                                      )


bscols(widths = c(1,5,NA),
       NULL,
       data_filter_hb_simd_ldp,
       NULL)

```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 0px">Percentage of referrals who received a minimum of one year’s PDS by Deprivation Quintile and Health Board</h2>
```{r plot-hb-simd-ldp}

bscols(widths = 12,
  div(style = css(width="98%", height="365px", marginBottom="-20px"),
plot_ly(ldp_simd_data_hb, x = ~geog, y = ~perc_met, meta = ~fy, hovertext = ~simd, type = 'bar', color = ~simd, colors = simd_colours, 
        hovertemplate = paste0("%{x} <br>", "%{meta} <br>", "deprivation quintile: %{hovertext} <br>",
                            "%{y}<extra></extra>")) %>% 
  layout(clickmode = "none", 
         showlegend = TRUE, legend = list(orientation = 'h', x = 0.5, y = 100, xanchor = "center"), 
         margin = list(l = -5, b = 10, t = 40),
         xaxis = list(title = "", showline = FALSE, linecolor = "#b3b3b3",
                     categoryorder = "array", categoryarray = ldp_hb_simd$geog, tickangle = -45, titlefont = list(size = 16)),
         yaxis = list(title = "", linecolor = "#b3b3b3", ticksuffix = "%")
      ) %>%
  config(displayModeBar = TRUE, doubleClick = F,
         modeBarButtonsToRemove = list('select2d', 'lasso2d', 'zoomIn2d', 
                                       'zoomOut2d', 'autoScale2d', 
                                       'toggleSpikelines', 
                                       'hoverCompareCartesian', 
                                       'hoverClosestCartesian', 'toImage'), 
         displaylogo = F, editable = F)
  )
)

```


```{r table-hb-simd-ldp}
hb_ldp_simd_table_data <- hb_table_ldp(ldp_all_simd, simd)

hb_simd_table_ldp <- SharedData$new(hb_ldp_simd_table_data, key = ~key, group = "hb_simd_ldp")

bscols(widths = 12,
       div(style = css(width="97%", height="620px", margin="20px", marginTop="0px"),
DT::datatable(hb_simd_table_ldp, rownames = FALSE, selection = "none", #extensions = "FixedColumns",
              options = list(pageLength = 30,
                             scrollX = TRUE,
                             #fixedColumns = list(leftColumns = 4),
                             scrollY = TRUE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = c(0,2)),
                                               list(className = 'dt-right', targets = 4:8)
                                               ))) %>%
           DT::formatStyle(c(2,4), fontWeight = "bold"
                          )
        )
     )

```

### **Trend by Deprivation Quintile**

```{r dropdown-ldp-simd}

ldp_all_simd_data <- SharedData$new(ldp_all_simd %>% 
  mutate(perc_met = if_else(
    geog == "Scotland" | (geog =="Aberdeen City" & fy %in% c("2019/20", "2020/21")) | (geog == "NHS Grampian" & fy %in% c("2019/20", "2020/21")),
    NA, perc_met)),
  key = ~geog, group = "ldp_simd")

data_filter_ldp_simd <- filter_select(id = "filter_ldp_simd",
                                    label = "Select Integration Authority Area or Health Board:",
                                    group = ~geog,
                                    sharedData = ldp_all_simd_data,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_ldp_simd,
       NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 15px">Percentage of referrals who received a minimum of one year’s PDS by Deprivation Quintile and Financial Year </h2>
```{r plot-ldp-simd-legend}
legend_data_simd_ldp<- SharedData$new(legend_data,
  key = ~geog, group = "ldp_simd")

bscols(widths = 12,
       div(style = css(height="30px"),
plot_ldp_line_legend(legend_data_simd_ldp)),NULL
)

```

```{r plot-ldp-simd}
bscols(widths = 12,
  div(style = css(width="98%", height="320px"),
plot_ldp_line(ldp_all_simd_data, measure = simd, measure_text = "deprivation quintile: ", colours = simd_colours))
)


```


```{r table-ldp-simd}
ldp_simd_table_data <- trend_table_ldp(ldp_all_simd, simd) %>% 
  arrange(geog, simd) %>% 
           rename(`Deprivation Quintile` = simd) %>% mutate(across(everything(), ~replace_na(.x, "-"))) %>% 
  mutate(`Deprivation Quintile` = if_else(type == "% Met Standard/Exempt", " ", `Deprivation Quintile`)) %>% 
 rename(" " = "type")

ldp_simd_table <- SharedData$new(ldp_simd_table_data, key = ~geog, group = "ldp_simd")

bscols(widths = 12,
       div(style = css(width="97%", height="430px", margin="20px", marginTop="-10px"),
DT::datatable(ldp_simd_table, rownames = FALSE, selection = 'none',
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right',
                                                    targets = 3:(length(full_years)+2))
                                               ))) %>%
           DT::formatStyle(2:3, fontWeight = "bold"
                          )
        )
     )

```

### **Trend by Financial Year**

```{r dropdown-ldp-simd-bar}
ldp_all_simd_data_2 <- SharedData$new(ldp_all_simd %>% mutate(perc_met = if_else((geog == "Aberdeen City" & fy %in% c("2019/20", "2020/21")) | (geog == "NHS Grampian" & fy %in% c("2019/20", "2020/21")),  
          0, perc_met)),
          key = ~geog, group = "ldp_simd_2")

data_filter_ldp_simd_bar <- filter_select(id = "filter_ldp_simd_bar",
                                    label = "Select Integration Authority Area or Health Board:",
                                    group = ~geog,
                                    sharedData = ldp_all_simd_data_2,
                                    multiple = FALSE
                                      )

bscols(widths = c(1,5,NA),
       NULL,
       data_filter_ldp_simd_bar,
       NULL)


```

<h2 style="margin-left: 70px; margin-top: 0px; margin-bottom: 18px">Percentage of referrals who received a minimum of one year’s PDS by Financial Year and Deprivation Quintile</h2>
```{r plot-ldp-simd-legend_bar}

bscols(widths = 12, div(style = css(height="30px", marginBottom="-7px"),
plot_ldp_bar_legend(ldp_all_simd, measure = simd, measure_text = "", colours = simd_colours))
)

```

```{r plot-ldp-simd_bar}
bscols(widths = 12,
  div(style = css(width="98%", height="290px"),
plot_ldp_bar(ldp_all_simd_data_2, measure = simd, measure_text = "deprivation quintile: ", colours = simd_colours))
)


```

```{r plot-ldp-simd-legend_labels}
bscols(widths = 12,
  div(style = css(width="98%", height="70px", marginTop="-35px", marginLeft="-3px"),
plot_ldp_bar_labels(ldp_all_simd %>% filter(geog == "Scotland"), measure = simd))
)

```

```{r table-ldp-simd_bar}

ldp_simd_table_2 <- SharedData$new(ldp_simd_table_data, key = ~geog, group = "ldp_simd_2")

bscols(widths = 12,
       div(style = css(width="97%", height="430px", margin="20px", marginTop="-25px"),
DT::datatable(ldp_simd_table_2, rownames = FALSE, selection = 'none',
              options = list(pageLength = 10,
                             scrollX = TRUE,
                             scrollY = FALSE,
                             dom = "t",
                             ordering = FALSE,
                             columnDefs = list(list(visible = FALSE, targets = 0),
                                               list(className = 'dt-right',
                                                    targets = 3:(length(full_years)+2))
                                               ))) %>%
           DT::formatStyle(2:3, fontWeight = "bold"
                          )
        )
     )



```

<!-- END OF SCRIPT -->