---
title: "TRENDS DRAFT"
output: 
  flexdashboard::flex_dashboard:
    logo: phs-logo.png
    orientation: rows
    vertical_layout: scroll
---

```{r load-setup, include=FALSE}
source(here::here("code", "00_setup-environment.R"))
library(crosstalk) # for drop down menus

# Write numbers with thousands separator
knit_hooks$set(inline = function(x){
  if(!is.character(x)){prettyNum(x, big.mark=",")}else{x}
})
```

---
date: "`r paste('Data as at', format(end_date, '%d %B %Y'))`"
---

```{r setup, include=FALSE}

# Remove tidylog
detach("package:tidylog", unload = TRUE)

# Load functions
walk(dir(here::here("functions"), full.names = TRUE), source)

# Load PDS data
pds <- read_rds(get_mi_data_path("final_data", ext = "rds", test_output = test_output)) %>% 
  
  # Remove codes from board and IJB
  mutate(health_board = str_sub(health_board, 3, -1),
         ijb          = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))

# Load expected diagnoses reference file
exp <- read_csv(get_exp_diagnoses_path())


# Load error summary
err <- read_rds(get_mi_data_path("error_data", ext = "rds", test_output = test_output)) %>% 

  mutate(ijb = if_else(is.na(ijb),
                                "Unknown",
                                str_sub(ijb, 11, -1)))
```
<!-- delete all of above when finished tetsing -->

All Referrals
=================================================

```{r data setup, include=FALSE}
# to be automated based on whether current year is complete or not??
#included_years <- c("2016/17", "2017/18", "2018/19", "2019/20", "2020/21", "2021/22", "2022/23", "2023/24")

#prepare data for plot_yearly_referrals() function
pds_ijb <- pds %>% arrange(ijb)

pds_scot <- pds %>% group_by(health_board = "Scotland", ijb = "Scotland", fy, month, ldp, age_grp, simd) %>% 
  summarise(referrals = sum(referrals), .groups = "drop")

pds_hb <- pds %>% group_by(health_board, fy, month, ldp, age_grp, simd) %>% 
  summarise(referrals = sum(referrals), .groups = "drop") %>% mutate(ijb = health_board, .before = fy)

pds_all <- bind_rows(pds_scot, pds_hb, pds_ijb)

pds_all %<>% rename(geog = ijb) 

pds_all$geog<- factor(pds_all$geog, levels = unique(pds_all$geog))

pds_all %<>% group_by(geog, fy) %>% summarise(total_referrals = sum(referrals))

# assigns data to filter_select in sidebar
pds_trends_data <- SharedData$new(pds_all)
   
 
```


Sidebar {.sidebar}
-----------------------------------------------------------------------

### All Referrals - Trend
***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***

<ul>
  <li>[All Referrals - Trend](#all-referrals)</li>
  <li>[All Referrals per 10,000 population - Trend](#pop-trend)</li>
  <li>[All Referrals per 10,000 population - by Integration Authority Area](#pop-ijb)</li>
</ul>

***

```{r dropdown}
data_filter_hb_ijb <- filter_select(id = "trend_filter",
                                    label = "Select Health Board or Integration Authority Area:",
                                    group = ~geog,
                                    sharedData = pds_trends_data
                                   )
data_filter_hb_ijb

```

```{js}
function filter_default() {
    document.getElementById("trend_filter").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("trend_filter").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
   document.getElementById("trend_filter_pop").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("trend_filter_pop").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
      document.getElementById("trend_filter_year").getElementsByClassName("selectized") 
  [0].selectize.setValue("Scotland", false);

  document.getElementById("trend_filter_year").getElementsByClassName("selectized")
  [0].selectize.removeOption("");
  
  
  }
  
  window.onload = filter_default;

```

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**


Row {.data-height=1000}
----------------------------------------------------------------------

### **Number of Individuals referred to Post-Diagnostic Support by Financial Year** {data-width=800}

```{r trend-plot}

trends_plot <- plot_yearly_referrals(pds_trends_data)
trends_plot

```


Row {.tabset data-height=750}
----------------------------------------------------------------------

### **Scotland/Health Board**

**Number of Individuals referred to Post-Diagnostic Support by Financial Year**

```{r trend-table-hb}

pds_all %>% filter(geog == "Scotland" | grepl("NHS", geog)) %>% 
            mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% 
            pivot_wider(names_from = fy, values_from = total_referrals) %>%
            rename(`Health Board` = geog) %>%
            kable(align = c("l", rep("r", length(unique(pds$fy))))) %>%
            kable_styling(full_width = FALSE) %>%
            column_spec(1, bold = TRUE) %>%
  # Add header above table 
            add_header_above(
                    c(" " = 1,
                     "Financial Year of Diagnosis" = length(unique(pds$fy))))

```

### **Scotland/Integration Authority Area**

**Number of Individuals referred to Post-Diagnostic Support by Financial Year**

```{r trend-table-ijb}

pds_all %>% filter(geog == "Scotland" | !grepl("NHS", geog)) %>% 
            mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% 
            pivot_wider(names_from = fy, values_from = total_referrals) %>% 
            rename(`Integration Authority Area` = geog) %>%
            kable(align = c("l", rep("r", length(unique(pds$fy))))) %>% 
            kable_styling(full_width = FALSE) %>%
            column_spec(1, bold = TRUE) %>%
  # Add header above table 
            add_header_above(
                       c(" " = 1,
                         "Financial Year of Diagnosis" = length(unique(pds$fy)))) %>%
            scroll_box(height = "740px")
 

```

Pop Trend {.hidden}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

### All Referrals per 10,000 population - Trend 

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>

***
<ul>
  <li>[All Referrals - Trend](#all-referrals)</li>
  <li>[All Referrals per 10,000 population - Trend](#pop-trend)</li>
  <li>[All Referrals per 10,000 population - by Integration Authority Area](#pop-ijb)</li>
</ul>

***

```{r dropdown-pop}
data_filter_hb_ijb_pop <- filter_select(id = "trend_filter_pop",
                                    label = "Select Health Board or Integration Authority Area:",
                                    group = ~geog,
                                    sharedData = pds_trends_data
                                   )
data_filter_hb_ijb_pop

```

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)


Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**


Row {.data-height=1000}
----------------------------------------------------------------------

### **Number of Individuals referred to Post-Diagnostic Support per 10,000 population by Financial Year** {data-width=800}

```{r trend-plot-pop}

# trends_plot <- plot_yearly_referrals(pds_trends_data)
# trends_plot

```


Row {.tabset data-height=750}
----------------------------------------------------------------------

### **Scotland/Health Board**

**Number of Individuals referred to Post-Diagnostic Support per 10,000 population by Financial Year**

```{r trend-table-hb-pop}

# pds_all %>% filter(geog == "Scotland" | grepl("NHS", geog)) %>% 
#             mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% 
#             pivot_wider(names_from = fy, values_from = total_referrals) %>%
#             rename(`Health Board` = geog) %>%
#             kable(align = c("l", rep("r", length(unique(pds$fy))))) %>%
#             kable_styling(full_width = FALSE) %>%
#             column_spec(1, bold = TRUE) %>%
#   # Add header above table 
#             add_header_above(
#                     c(" " = 1,
#                      "Financial Year of Diagnosis" = length(unique(pds$fy))))

```

### **Scotland/Integration Authority Area**

**Number of Individuals referred to Post-Diagnostic Support per 10,000 population by Financial Year**

```{r trend-table-ijb-pop}

# pds_all %>% filter(geog == "Scotland" | !grepl("NHS", geog)) %>% 
#             mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% 
#             pivot_wider(names_from = fy, values_from = total_referrals) %>% 
#             rename(`Integration Authority Area` = geog) %>%
#             kable(align = c("l", rep("r", length(unique(pds$fy))))) %>% 
#             kable_styling(full_width = FALSE) %>%
#             column_spec(1, bold = TRUE) %>%
#   # Add header above table 
#             add_header_above(
#                        c(" " = 1,
#                          "Financial Year of Diagnosis" = length(unique(pds$fy)))) %>%
#             scroll_box(height = "740px")
 

```

Pop IJB {.hidden}
=====================================
Sidebar {.sidebar}
-----------------------------------------------------------------------

### All Referrals per 10,000 population - by Integration Authority Area

***

<font size="2"> 
<span style="color:red"> 
**MANAGEMENT INFORMATION ONLY:** <br>
**NOT FOR ONWARD DISTRIBUTION**
</span> </font>


***
<ul>
  <li>[All Referrals - Trend](#all-referrals)</li>
  <li>[All Referrals per 10,000 population - Trend](#pop-trend)</li>
  <li>[All Referrals per 10,000 population - by Integration Authority Area](#pop-ijb)</li>
</ul>

***

```{r dropdown-pop-iaa}
data_filter_year <- filter_select(id = "trend_filter_year",
                                    label = "Select Financial Year:",
                                    group = ~fy,
                                    sharedData = pds_trends_data
                                   )
data_filter_year

```

***

Please get in touch with any comments, suggestions and feedback: [phs.dementiapds@phs.scot](mailto:phs.dementiapds@phs.scot)

Row
----------------------------------------------------------------------

### **Note**

**Please note that both the Dementia Post Diagnostic Support service provision and data submission to PHS were affected by the COVID-19 pandemic.**


Row {.data-height=1000}
----------------------------------------------------------------------

### **Number of Individuals referred to Post-Diagnostic Support per 10,000 population by Integration Authority Area** {data-width=800}

```{r plot-ijb-pop}

# trends_plot <- plot_yearly_referrals(pds_trends_data)
# trends_plot

```


Row {.tabset data-height=750}
----------------------------------------------------------------------

### **Number of Individuals referred to Post-Diagnostic Support per 10,000 population by Integration Authority Area**

```{r table-ijb-pop}

# pds_all %>% filter(geog == "Scotland" | !grepl("NHS", geog)) %>% 
#             mutate(total_referrals = format(total_referrals, big.mark = ",")) %>% 
#             pivot_wider(names_from = fy, values_from = total_referrals) %>% 
#             rename(`Integration Authority Area` = geog) %>%
#             kable(align = c("l", rep("r", length(unique(pds$fy))))) %>% 
#             kable_styling(full_width = FALSE) %>%
#             column_spec(1, bold = TRUE) %>%
#   # Add header above table 
#             add_header_above(
#                        c(" " = 1,
#                          "Financial Year of Diagnosis" = length(unique(pds$fy)))) %>%
#             scroll_box(height = "740px")
 

```